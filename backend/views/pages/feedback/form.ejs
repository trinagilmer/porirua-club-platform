<style>
  .feedback-shell {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #0f172a;
    padding: 2rem 1rem;
  }
  .feedback-card {
    max-width: 720px;
    width: 100%;
  }
  .rating-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .rating-pill {
    border: 1px solid #d9e2ec;
    background: #f8fafc;
    color: #0f172a;
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    cursor: pointer;
    user-select: none;
    transition: all 0.15s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
  .rating-pill input {
    display: none;
  }
  .rating-pill.active {
    background: #e8f5fc;
    border-color: #6bb4de;
    color: #0b5c7a;
    box-shadow: 0 0 0 2px rgba(107, 180, 222, 0.25);
  }
  .nps-scale {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(42px, 1fr));
    gap: 0.35rem;
  }
  .issue-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .issue-chip {
    border: 1px solid #d9e2ec;
    background: #f8fafc;
    color: #0f172a;
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    cursor: pointer;
    user-select: none;
    transition: all 0.15s ease;
  }
  .issue-chip input {
    display: none;
  }
  .issue-chip.active {
    background: #fdf4f5;
    border-color: #e25b5b;
    color: #8b1b1b;
    box-shadow: 0 0 0 2px rgba(226, 91, 91, 0.2);
  }
  .issue-section {
    display: none;
  }
  .issue-section.is-visible {
    display: block;
  }
</style>

<div class="feedback-shell">
  <div class="card shadow-lg feedback-card">
    <div class="card-body p-4">
      <% const resolvedQuestionConfig = typeof questionConfig !== 'undefined' ? questionConfig : {
        overallLabel: "Overall, how was your experience?",
        showService: true,
        serviceLabel: "How would you rate our service?",
        showRecommend: true,
        recommendLabel: "Would you recommend us?",
        showComments: true,
        commentsLabel: "Anything we could improve?"
      }; %>

      <% if (surveyHeaderHtml) { %>
        <div class="mb-4">
          <%- surveyHeaderHtml %>
        </div>
      <% } %>

      <% if (preview) { %>
        <div class="alert alert-info">Preview mode - this link is not tracked.</div>
      <% } %>

      <% if (errorMessage) { %>
        <div class="alert alert-danger"><%= errorMessage %></div>
      <% } %>

      <% if (!entry) { %>
        <p class="text-muted mb-0">This feedback link is no longer active.</p>
      <% } else if (success) { %>
        <div class="alert alert-success">
          <h5 class="alert-heading mb-1">Thank you!</h5>
          <p class="mb-0">We appreciate you taking the time to share your feedback.</p>
        </div>
      <% } else { %>
        <form method="POST" class="vstack gap-4">
          <div>
            <p class="text-muted mb-1 text-uppercase small">
              <%= entry.entity_type === 'function' ? 'Function' : 'Restaurant booking' %>
            </p>
            <h4 class="mb-0"><%= entry.entity_type === 'function' ? (entry.function_name || entry.contact_name || 'Your event') : (entry.booking_name || entry.contact_name || 'Your event') %></h4>
            <% const displayDate = entry.entity_type === 'function' ? entry.function_date : entry.booking_date; %>
            <% if (displayDate) { %>
              <p class="text-muted mb-0"><%= formatDisplayDate(displayDate) %></p>
            <% } %>
          </div>

          <div>
            <label class="form-label fw-semibold d-block mb-2"><%= resolvedQuestionConfig.overallLabel %></label>
            <div class="rating-pills" data-rating-group="overall">
              <% const overallLabels = ['Very poor','Poor','Okay','Good','Excellent']; %>
              <% for (let i = 1; i <= 5; i += 1) { %>
                <label class="rating-pill" data-value="<%= i %>">
                  <input type="radio" name="rating_overall" value="<%= i %>" required>
                  <span class="fw-semibold"><%= i %></span>
                  <span class="text-muted small"><%= overallLabels[i-1] %></span>
                </label>
              <% } %>
            </div>
          </div>

          <% if (resolvedQuestionConfig.showService) { %>
            <div>
              <label class="form-label d-block mb-2"><%= resolvedQuestionConfig.serviceLabel %></label>
              <div class="rating-pills" data-rating-group="service">
                <% const serviceLabels = ['Very poor','Poor','Okay','Good','Excellent']; %>
                <% for (let i = 1; i <=5; i += 1) { %>
                  <label class="rating-pill" data-value="<%= i %>">
                    <input type="radio" name="rating_service" value="<%= i %>">
                    <span class="fw-semibold"><%= i %></span>
                    <span class="text-muted small"><%= serviceLabels[i-1] %></span>
                  </label>
                <% } %>
              </div>
            </div>
          <% } %>

          <% if (resolvedQuestionConfig.showRecommend) { %>
            <div>
              <label class="form-label fw-semibold d-block mb-2"><%= resolvedQuestionConfig.recommendLabel %></label>
              <div class="nps-scale rating-pills" data-rating-group="nps">
                <% for (let i = 0; i <= 10; i += 1) { %>
                  <label class="rating-pill w-100 text-center" data-nps-value="<%= i %>">
                    <input type="radio" name="nps_score" value="<%= i %>">
                    <span class="fw-semibold"><%= i %></span>
                  </label>
                <% } %>
              </div>
              <small class="text-muted d-block mt-1">0 = Not at all likely, 10 = Extremely likely</small>
            </div>
          <% } %>

          <% if (resolvedQuestionConfig.showComments) { %>
            <div>
              <label class="form-label"><%= resolvedQuestionConfig.commentsLabel %></label>
              <textarea class="form-control" name="comments" rows="4" placeholder="Share your thoughts."></textarea>
            </div>
          <% } %>

          <div id="issueSection" class="issue-section">
            <label class="form-label d-block">If something wasnâ€™t right, what needs improvement?</label>
            <div class="issue-chips">
              <% const baseIssues = ['Food quality','Service','Speed','Value','Cleanliness','Communication','Other']; %>
              <% baseIssues.forEach(function(issue) { %>
                <label class="issue-chip" data-issue="<%= issue %>">
                  <input type="checkbox" name="issue_tags[]" value="<%= issue %>">
                  <span><%= issue %></span>
                </label>
              <% }); %>
            </div>
            <small class="text-muted d-block mt-1">Choose any that apply (optional). If everything was great, you can leave this blank.</small>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">Send feedback</button>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const pillGroups = document.querySelectorAll('.rating-pills');
    const issueSection = document.getElementById('issueSection');
    const npsInputs = document.querySelectorAll('input[name="nps_score"]');

    function computeShowIssues() {
      // show if overall <=3, recommend no, or nps <=6
      const overallChecked = document.querySelector('input[name="rating_overall"]:checked');
      const overallVal = overallChecked ? parseInt(overallChecked.value, 10) : null;
      const npsVal = Array.from(npsInputs).find((el) => el.checked)?.value;
      return (
        (overallVal !== null && overallVal <= 3) ||
        (npsVal !== undefined && npsVal !== null && npsVal !== '' && Number(npsVal) <= 6)
      );
    }

    function syncIssueVisibility() {
      if (!issueSection) return;
      const shouldShow = computeShowIssues();
      issueSection.classList.toggle('is-visible', shouldShow);
      if (!shouldShow) {
        issueSection.querySelectorAll('.issue-chip.active').forEach(function(chip) {
          chip.classList.remove('active');
          const input = chip.querySelector('input');
          if (input) input.checked = false;
        });
      }
    }

    document.querySelectorAll('input[name="rating_overall"], input[name="nps_score"]').forEach(function(el) {
      el.addEventListener('change', function(e) {
        const input = e.target;
        const group = input.closest('.rating-pills');
        if (group) {
          group.querySelectorAll('.rating-pill').forEach(function(pill) {
            pill.classList.toggle('active', pill.querySelector('input')?.checked);
          });
        }
        syncIssueVisibility();
      });
    });
    syncIssueVisibility();

    pillGroups.forEach(function(group) {
      group.addEventListener('click', function(e) {
        const pill = e.target.closest('.rating-pill');
        if (!pill) return;
        const input = pill.querySelector('input');
        if (!input) return;
        const isRadio = input.type === 'radio';
        if (isRadio) {
          const siblings = group.querySelectorAll('.rating-pill');
          siblings.forEach(function(sib) { sib.classList.remove('active'); });
        }
        pill.classList.toggle('active', true);
        input.checked = true;
        syncIssueVisibility();
      });
    });

    const issueChips = document.querySelectorAll('.issue-chip');
    issueChips.forEach(function(chip) {
      chip.addEventListener('click', function(e) {
        const input = chip.querySelector('input');
        if (!input) return;
        const nowChecked = !input.checked;
        input.checked = nowChecked;
        chip.classList.toggle('active', nowChecked);
      });
    });
  });
</script>
