<% const roomsList = Array.isArray(rooms) ? rooms : []; %>

<script>
  window.calendarConfig = Object.assign({}, window.calendarConfig || {}, <%- JSON.stringify(calendarConfig || {}) %>);
</script>

<div class="calendar-page px-4 py-4 calendar-print-shell">
  <div class="calendar-print-header">
    <h1 class="calendar-print-title" id="calendarPrintTitle"></h1>
  </div>

  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3 no-print">
    <div class="flex-grow-1">
      <h1 class="page-title mb-1">
        <span>Function Calendar</span>
        <span class="calendar-view-label" id="calendarViewLabel"></span>
      </h1>
      <p class="text-muted mb-0">Track room bookings across functions, restaurant reservations, and club events.</p>
    </div>
    <div class="d-flex flex-wrap gap-2 justify-content-end align-items-center">
      <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="exitDayViewBtn">
        Back to overview
      </button>
      <button type="button" class="btn btn-primary btn-sm" id="calendarPrintBtn">
        <i class="bi bi-printer me-1"></i> Print calendar
      </button>
      <a href="/calendar/restaurant" class="btn btn-outline-primary btn-sm">
        Restaurant calendar
      </a>
    </div>
  </div>

  <section class="calendar-controls card shadow-sm p-3 mb-4 no-print">
    <div class="calendar-room-toggle mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label mb-0">Rooms / Spaces</label>
        <small class="text-muted">Click to toggle rooms. All are shown by default.</small>
      </div>
      <% if (!roomsList.length) { %>
        <p class="text-muted small mb-0">No rooms have been set up yet.</p>
      <% } else { %>
        <div class="calendar-room-grid" role="group" aria-label="Room filters">
          <% roomsList.forEach(function(room) { %>
            <button type="button" class="btn btn-outline-secondary btn-sm calendar-room-btn active" data-room-id="<%= room.id %>" aria-pressed="true">
              <%= room.name %>
            </button>
          <% }) %>
        </div>
      <% } %>
    </div>
    <div class="row g-3 align-items-center">
      <div class="col-12 col-md-8">
        <span class="form-label d-block">Show bookings</span>
        <div class="btn-group flex-wrap" role="group" aria-label="Calendar source filters">
          <input class="btn-check" type="checkbox" id="toggleFunctions" data-calendar-type="functions" checked>
          <label class="btn btn-outline-primary btn-sm" for="toggleFunctions">Functions</label>

          <input class="btn-check" type="checkbox" id="toggleRestaurant" data-calendar-type="restaurant">
          <label class="btn btn-outline-primary btn-sm" for="toggleRestaurant">Restaurant</label>

          <input class="btn-check" type="checkbox" id="toggleEntertainment" data-calendar-type="entertainment">
          <label class="btn btn-outline-primary btn-sm" for="toggleEntertainment">Entertainment</label>
        </div>
        <small class="text-muted d-block mt-1">Toggle any combination to focus the calendar.</small>
      </div>
      <div class="col-12 col-md-4 text-md-end">
        <button class="btn btn-light w-100 w-md-auto" id="calendarClearFilters">
          <i class="bi bi-arrow-counterclockwise me-1"></i>
          Reset filters
        </button>
      </div>
    </div>
    <div class="mt-3">
      <span class="form-label d-block">Function status</span>
      <div class="btn-group flex-wrap" role="group" aria-label="Function status filters">
        <input class="btn-check" type="checkbox" id="statusLead" data-function-status="lead" checked>
        <label class="btn btn-outline-secondary btn-sm" for="statusLead">Lead</label>

        <input class="btn-check" type="checkbox" id="statusQualified" data-function-status="qualified" checked>
        <label class="btn btn-outline-secondary btn-sm" for="statusQualified">Qualified</label>

        <input class="btn-check" type="checkbox" id="statusConfirmed" data-function-status="confirmed" checked>
        <label class="btn btn-outline-secondary btn-sm" for="statusConfirmed">Confirmed</label>

        <input class="btn-check" type="checkbox" id="statusBalance" data-function-status="balance_due">
        <label class="btn btn-outline-secondary btn-sm" for="statusBalance">Balance due</label>

        <input class="btn-check" type="checkbox" id="statusCompleted" data-function-status="completed">
        <label class="btn btn-outline-secondary btn-sm" for="statusCompleted">Completed</label>

        <input class="btn-check" type="checkbox" id="statusCancelled" data-function-status="cancelled">
        <label class="btn btn-outline-secondary btn-sm" for="statusCancelled">Cancelled</label>
      </div>
      <small class="text-muted d-block mt-1">Cancelled functions are hidden unless selected.</small>
    </div>
  </section>

  <section class="calendar-wrapper card shadow-sm p-3 calendar-area">
    <div id="functionCalendar" class="calendar-shell calendar-area" aria-live="polite"></div>
  </section>

  <!-- Print-only layouts -->
  <section class="calendar-print-wrapper">
    <div class="calendar-print-month">
      <table class="calendar-print-table" id="calendarPrintMonthTable">
        <thead>
          <tr>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Sat</th>
            <th>Sun</th>
          </tr>
        </thead>
        <tbody id="calendarPrintMonthBody"></tbody>
      </table>
    </div>

    <div class="calendar-print-week">
      <table class="calendar-print-table" id="calendarPrintWeekTable">
        <thead>
          <tr>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Sat</th>
            <th>Sun</th>
          </tr>
        </thead>
        <tbody>
          <tr id="calendarPrintWeekRow"></tr>
        </tbody>
      </table>
    </div>

    <div class="calendar-print-day">
      <div class="calendar-print-day-meta" id="calendarPrintDayMeta"></div>
      <ul class="calendar-print-day-list" id="calendarPrintDayList"></ul>
    </div>
  </section>
</div>

<!-- Event Snapshot Modal -->
<div class="modal fade" id="calendarEventModal" tabindex="-1" aria-labelledby="calendarEventLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <p class="text-muted text-uppercase small mb-1">Booking Snapshot</p>
          <h5 class="modal-title mb-0" id="calendarEventLabel" data-calendar-field="title">Function</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-3 text-muted small text-uppercase">Date &amp; time</dt>
          <dd class="col-sm-9 fw-semibold" data-calendar-field="schedule">--</dd>

          <dt class="col-sm-3 text-muted small text-uppercase">Room</dt>
          <dd class="col-sm-9" data-calendar-field="room">--</dd>

          <dt class="col-sm-3 text-muted small text-uppercase">Status</dt>
          <dd class="col-sm-9">
            <span class="badge rounded-pill bg-light text-dark" data-calendar-field="status">--</span>
          </dd>

          <dt class="col-sm-3 text-muted small text-uppercase">Primary contact</dt>
          <dd class="col-sm-9" data-calendar-field="contact">--</dd>

          <dt class="col-sm-3 text-muted small text-uppercase">Guests</dt>
          <dd class="col-sm-9" data-calendar-field="attendees">--</dd>
        </dl>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="text-muted small">Use the buttons to open the full details.</div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <% if (user && ['admin','owner'].includes((user.role || '').toLowerCase())) { %>
            <div class="btn-group dropup d-none" id="calendarConvertGroup">
              <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                Convert toâ€¦
              </button>
              <ul class="dropdown-menu">
                <li><button type="button" class="dropdown-item d-none" data-convert-target="restaurant">Restaurant booking</button></li>
                <li><button type="button" class="dropdown-item d-none" data-convert-target="entertainment">Entertainment event</button></li>
                <li><button type="button" class="dropdown-item d-none" data-convert-target="functions">Function</button></li>
              </ul>
            </div>
          <% } %>
          <a href="#" target="_blank" rel="noopener" class="btn btn-outline-secondary" data-calendar-action="open-function">
            Open function
          </a>
          <a href="#" target="_blank" rel="noopener" class="btn btn-outline-secondary d-none" data-calendar-action="open-event">
            Open event
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add / Quick action modal -->
<div class="modal fade" id="calendarAddModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <p class="text-muted text-uppercase small mb-1">New entry</p>
          <h5 class="modal-title mb-0">Choose what to add</h5>
          <small class="text-muted" data-calendar-add-date></small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">Select the item type to start a new booking for the highlighted date.</p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary" data-calendar-add-target="functions">
            Add Function
          </button>
          <button type="button" class="btn btn-outline-primary" data-calendar-add-target="restaurant">
            Add Restaurant Booking
          </button>
          <button type="button" class="btn btn-outline-primary" data-calendar-add-target="entertainment">
            Add Entertainment Event
          </button>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <small class="text-muted">Need a closer look?</small>
        <button type="button" class="btn btn-link text-decoration-none" id="calendarAddViewDay">
          View day in calendar
        </button>
      </div>
    </div>
  </div>
</div>
