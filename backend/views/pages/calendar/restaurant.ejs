<% const dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]; %>
<% const prefill = typeof prefillBooking !== 'undefined' ? prefillBooking : {}; %>
<% const isEmbed = Boolean(embed); %>
<% if (isEmbed) { %>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Porirua Club - Restaurant Calendar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
    <style>
      body.restaurant-calendar-embed {
        margin: 0;
        padding: 16px;
        font-family: "Inter","Segoe UI",system-ui,sans-serif;
        background: #f8fafc;
      }
      .calendar-embed-shell {
        max-width: 1100px;
        margin: 0 auto;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 12px 24px rgba(15,23,42,0.12);
        padding: 16px;
      }
      @media (max-width: 720px) {
        body.restaurant-calendar-embed { padding: 8px; }
        .calendar-embed-shell { padding: 10px; }
      }
    </style>
  </head>
  <body class="restaurant-calendar-embed">
<% } %>
<script>
  window.calendarConfig = Object.assign({}, window.calendarConfig || {}, <%- JSON.stringify(calendarConfig || {}) %>);
  window.restaurantCanManage = <%= canManage ? 'true' : 'false' %>;
  window.restaurantServices = <%- JSON.stringify(services || []) %>;
</script>
<style>
  .upcoming-list {
    max-height: 420px;
    overflow-y: auto;
  }
</style>

<div class="<%= isEmbed ? 'calendar-embed-shell' : 'calendar-page px-4 py-4' %>">
  <% if (!isEmbed) { %>
    <div class="d-flex justify-content-between flex-wrap gap-2 mb-4">
      <div>
        <h1 class="mb-1">Restaurant Bookings</h1>
        <p class="text-muted mb-0">Live view of reservations and capacity windows.</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="/calendar" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left-short me-1"></i> Function calendar
        </a>
        <a href="/calendar/restaurant/bookings" class="btn btn-outline-primary btn-sm">
          Booking list
        </a>
        <a href="/calendar/restaurant/book" class="btn btn-outline-primary btn-sm">
          Public booking form
        </a>
      </div>
    </div>
  <% } %>

  <% if (message) { %>
    <div class="alert alert-success"><%= message %></div>
  <% } %>
  <% if (errorMessage) { %>
    <div class="alert alert-danger"><%= decodeURIComponent(errorMessage) %></div>
  <% } %>

  <% if (isEmbed) { %>
    <section class="card shadow-sm p-3">
      <div id="restaurantCalendar" class="calendar-shell" aria-live="polite"></div>
    </section>
  <% } else { %>
    <div class="row g-4">
      <div class="col-lg-8">
        <section class="card shadow-sm p-3">
          <div id="restaurantCalendar" class="calendar-shell" aria-live="polite"></div>
        </section>
      </div>
      <div class="col-lg-4">
        <section class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Upcoming bookings</h5>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#serviceWindowsModal">
                Service windows
              </button>
            </div>
            <div class="mb-2">
              <div class="row g-2">
                <div class="col-12">
                  <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="upcomingFilter" placeholder="Search bookings">
                  </div>
                </div>
                <div class="col-6">
                  <select id="upcomingMode" class="form-select form-select-sm">
                    <option value="all" selected>All bookings</option>
                    <option value="date">Bookings by date</option>
                  </select>
                </div>
                <div class="col-6">
                  <input type="date" id="upcomingDate" class="form-control form-control-sm" aria-label="Filter by date">
                </div>
                <div class="col-12 d-flex justify-content-between align-items-center">
                  <small class="text-muted" id="bookingTotalsLabel">Totals: -</small>
                </div>
              </div>
            </div>
            <% if (!upcomingBookings || !upcomingBookings.length) { %>
              <p class="text-muted small mb-0">No upcoming bookings.</p>
            <% } else { %>
              <div class="list-group list-group-flush upcoming-list" id="upcomingList">
                <% upcomingBookings.forEach(function(b) { %>
                  <% 
                    const rawDate = b.booking_date || "";
                    const dateObj = rawDate ? new Date(rawDate) : null;
                    const dateAttr = dateObj
                      ? new Date(dateObj.getTime() - dateObj.getTimezoneOffset() * 60000).toISOString().slice(0, 10)
                      : (typeof rawDate === 'string' ? rawDate.slice(0, 10) : '');
                    const dateStr = dateObj
                      ? dateObj.toLocaleDateString('en-NZ', { weekday: 'long', day: 'numeric', month: 'short', year: '2-digit' })
                      : '';
                    const timeStr = (b.booking_time || '').slice(0,5);
                    const receivedStr = b.created_at
                      ? new Date(b.created_at).toLocaleString('en-NZ', { weekday: 'long', day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit' })
                      : '';
                    const linkUrl = `/calendar/restaurant/bookings/${b.id}`;
                  %>
                  <a href="<%= linkUrl %>" data-booking-date="<%= dateAttr %>" data-size="<%= b.size || 0 %>" class="list-group-item px-0 d-flex justify-content-between align-items-start text-decoration-none upcoming-item">
                    <div>
                      <div class="fw-semibold text-primary"><%= b.party_name %></div>
                      <small class="text-muted d-block"><%= dateStr %> <% if (timeStr) { %> @ <%= timeStr %><% } %></small>
                      <small class="text-muted d-block">Guests: <%= b.size || 0 %><% if (b.service_name) { %> • <%= b.service_name %><% } %></small>
                    </div>
                    <span class="badge <%= (b.status || '').toLowerCase() === 'pending' ? 'bg-warning text-dark' : 'bg-success' %> text-uppercase align-self-center">
                      <%= (b.status || '').toLowerCase() === 'pending' ? 'Pending' : 'Confirmed' %>
                    </span>
                  </a>
                <% }) %>
              </div>
            <% } %>
            <hr>
            <p class="text-muted small mb-0">Click a calendar slot to add a booking.</p>
          </div>
        </section>
      </div>
    </div>
  <% } %>
</div>

<script>
  (function() {
    const filterInput = document.getElementById('upcomingFilter');
    const modeSelect = document.getElementById('upcomingMode');
    const dateInput = document.getElementById('upcomingDate');
    const list = document.getElementById('upcomingList');
    const totalsLabel = document.getElementById('bookingTotalsLabel');
    if (!filterInput || !list || !modeSelect || !dateInput) return;

    function applyFilters() {
      const term = (filterInput.value || '').toLowerCase().trim();
      const mode = modeSelect.value;
      const dateVal = (dateInput.value || "").trim();
      let count = 0;
      let guests = 0;
      list.querySelectorAll('.upcoming-item').forEach((item) => {
        const text = item.textContent.toLowerCase();
        const matchesTerm = !term || text.includes(term);
        const itemDate = (item.getAttribute('data-booking-date') || '').slice(0,10);
        const matchesDate =
          mode === 'all' || !dateVal
            ? true
            : itemDate === dateVal;
        const show = matchesTerm && matchesDate;
        item.classList.toggle('d-none', !show);
        if (show) {
          count += 1;
          guests += Number(item.getAttribute('data-size')) || 0;
        }
      });
      if (totalsLabel) {
        totalsLabel.textContent = count
          ? `Totals: ${count} booking${count === 1 ? '' : 's'} • ${guests} guest${guests === 1 ? '' : 's'}`
          : 'Totals: 0 bookings';
      }
    }

    filterInput.addEventListener('input', applyFilters);
    modeSelect.addEventListener('change', applyFilters);
    dateInput.addEventListener('change', applyFilters);

    // Preselect date if provided via data attribute (e.g., day view)
    const prefillDate = document.body.getAttribute('data-selected-date');
    if (prefillDate) {
      modeSelect.value = 'date';
      dateInput.value = prefillDate;
    }
    applyFilters();
  })();
</script>

<% if (!isEmbed) { %>
<!-- Service Windows Modal -->
<div class="modal fade" id="serviceWindowsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Service windows</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <% if (!services || !services.length) { %>
          <p class="text-muted mb-0">No services configured. Set them up under Settings → Restaurant Bookings.</p>
        <% } else { %>
          <ul class="list-unstyled mb-0">
            <% services.forEach(function(service) { %>
              <li class="mb-3">
                <strong><%= service.name %></strong><br>
                <small class="text-muted">
                  <%= dayNames[service.day_of_week] %>,
                  <%= service.start_time ? service.start_time.slice(0,5) : "--:--" %>
                  -
                  <%= service.end_time ? service.end_time.slice(0,5) : "--:--" %>
                </small>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Add / Edit Booking Modal -->
<div class="modal fade" id="restaurantBookingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="restaurantBookingForm" action="/calendar/restaurant/bookings" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Add restaurant booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body vstack gap-2">
          <div>
            <label class="form-label">Party name</label>
            <input type="text" name="party_name" id="rb-party" class="form-control form-control-sm" required>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Date</label>
              <input type="date" name="booking_date" id="rb-date" class="form-control form-control-sm" required>
            </div>
            <div class="col">
              <label class="form-label">Time</label>
              <input type="time" name="booking_time" id="rb-time" class="form-control form-control-sm" required>
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Party size</label>
              <input type="number" name="size" id="rb-size" class="form-control form-control-sm" min="1" required>
            </div>
            <div class="col">
              <label class="form-label">Service</label>
              <select name="service_id" id="rb-service" class="form-select form-select-sm">
                <option value="">Auto detect</option>
                <% (services || []).filter(function(s){ return s.special_menu_label; }).forEach(function(service) { 
                     const start = service.special_menu_start ? new Date(service.special_menu_start).toLocaleDateString('en-NZ') : null;
                     const end = service.special_menu_end ? new Date(service.special_menu_end).toLocaleDateString('en-NZ') : null;
                     const window = start && end ? `${start} - ${end}` : (start ? `From ${start}` : (end ? `Until ${end}` : ''));
                     const price = service.special_menu_price ? ` ($${Number(service.special_menu_price).toFixed(2)})` : '';
                %>
                  <option value="<%= service.id %>"><%= service.special_menu_label %><%= price %><% if (window) { %> - <%= window %><% } %></option>
                <% }) %>
              </select>
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Zone</label>
              <select name="zone_id" id="rb-zone" class="form-select form-select-sm">
                <option value="">No preference</option>
                <% (zones || []).forEach(function(zone) { %>
                  <option value="<%= zone.id %>"><%= zone.name %></option>
                <% }) %>
              </select>
            </div>
            <div class="col">
              <label class="form-label">Table</label>
              <select name="table_id" id="rb-table" class="form-select form-select-sm">
                <option value="">Unassigned</option>
                <% (tables || []).forEach(function(table) { %>
                  <option value="<%= table.id %>"><%= table.label %></option>
                <% }) %>
              </select>
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Contact email</label>
              <input type="email" name="contact_email" id="rb-email" class="form-control form-control-sm">
            </div>
            <div class="col">
              <label class="form-label">Phone</label>
              <input type="text" name="contact_phone" id="rb-phone" class="form-control form-control-sm">
            </div>
          </div>
          <div>
            <label class="form-label">Notes</label>
            <textarea name="notes" id="rb-notes" class="form-control form-control-sm" rows="2"></textarea>
          </div>
          <div>
            <label class="form-label">Status</label>
            <select name="status" id="rb-status" class="form-select form-select-sm">
              <option value="confirmed">Confirmed</option>
              <option value="pending">Pending</option>
              <option value="seated">Seated</option>
            </select>
          </div>

          <div class="border-top pt-3 mt-2">
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="rb-recurring-toggle">
              <label class="form-check-label" for="rb-recurring-toggle">Recurring booking</label>
            </div>
            <div id="rb-recurring-fields" class="d-none">
              <div class="mb-3">
                <label class="form-label">Frequency</label>
                <select name="recurrence_frequency" class="form-select form-select-sm">
                  <option value="none">Does not repeat</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly_date">Monthly (date)</option>
                  <option value="monthly_weekday">Monthly (weekday)</option>
                </select>
              </div>
              <div class="row g-2">
                <div class="col">
                  <label class="form-label">Interval</label>
                  <input type="number" name="recurrence_interval" class="form-control form-control-sm" min="1" value="1">
                </div>
                <div class="col">
                  <label class="form-label">End date</label>
                  <input type="date" name="recurrence_end_date" class="form-control form-control-sm">
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label small mb-1">Weekdays</label>
                <div class="d-flex flex-wrap gap-2">
                  <% ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(function(day, idx) { %>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="<%= idx %>" id="rb-rec-<%= idx %>">
                      <label class="form-check-label" for="rb-rec-<%= idx %>"><%= day %></label>
                    </div>
                  <% }) %>
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col">
                  <label class="form-label">Monthly day</label>
                  <input type="number" name="recurrence_monthly_day" class="form-control form-control-sm" min="1" max="31">
                </div>
                <div class="col">
                  <label class="form-label">Monthly weekday</label>
                  <select name="recurrence_monthly_week" class="form-select form-select-sm">
                    <option value="">--</option>
                    <option value="1">First</option>
                    <option value="2">Second</option>
                    <option value="3">Third</option>
                    <option value="4">Fourth</option>
                    <option value="-1">Last</option>
                  </select>
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Skip dates</label>
                <textarea name="recurrence_skip_dates" class="form-control form-control-sm" rows="2" placeholder="YYYY-MM-DD, ..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save booking</button>
        </div>
      </form>
    </div>
  </div>
</div>
<% } %>
<% if (isEmbed) { %>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="/js/calendar/restaurant.js"></script>
  </body>
</html>
<% } %>
