<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title><%= title %></title>
  <style>
    /* Page-specific polish */
    .status-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .status-filters a {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--primary);
      color: var(--primary);
      background: #fff;
      text-transform: capitalize;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .status-filters a.active {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }
    .status-filters a:hover {
      background: var(--deep);
      color: #fff;
    }

    .kpi-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .kpi {
      background: var(--white);
      border-left: 5px solid var(--primary);
      border-radius: var(--radius);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 12px 16px;
    }
    .kpi .label {
      color: #666;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    .kpi .value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--deep);
    }

    .table-actions a {
      margin-right: 6px;
    }
    .add-btn {
      float: right;
      background: var(--accent);
      color: var(--deep);
      font-weight: 600;
    }
    .add-btn:hover {
      background: var(--deep);
      color: #fff;
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user: user }) %>

  <main class="main-content">
    <h1 style="color:var(--deep); margin-top:0;">Functions Dashboard</h1>

    <!-- KPI Overview -->
    <div class="kpi-bar">
      <div class="kpi">
        <div class="label">Leads</div>
        <div class="value">$<%= totals.lead_value %></div>
      </div>
      <div class="kpi">
        <div class="label">Qualified</div>
        <div class="value">$<%= totals.qualified_value %></div>
      </div>
      <div class="kpi">
        <div class="label">Confirmed</div>
        <div class="value">$<%= totals.confirmed_value %></div>
      </div>
      <div class="kpi">
        <div class="label">Balance Due</div>
        <div class="value">$<%= totals.balance_due_value %></div>
      </div>
      <div class="kpi">
        <div class="label">Completed YTD</div>
        <div class="value">$<%= totals.completed_value %></div>
      </div>
    </div>

    <!-- Status Filters -->
    <div class="status-filters">
      <% ['active','lead','qualified','confirmed','balance_due','completed'].forEach(st => { %>
        <a href="/functions?status=<%= st %>" class="<%= statusFilter === st ? 'active' : '' %>">
          <%= st.replace('_',' ') %>
        </a>
      <% }) %>
      <a href="/functions?mine=true" class="<%= myOnly ? 'active' : '' %>">My Events</a>
      <a href="/functions" class="add-btn btn">+ Add Function</a>
    </div>

    <!-- Functions Table -->
    <div class="card">
<table class="table compact-table">
  <thead>
    <tr>
      <th>Event</th>
      <th>Status</th>
      <th>Date</th>
      <th>Attendees</th>
      <th>Value ($)</th>
      <th>Room</th>
      <th>Owner</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>

  <tbody>
    <% if (events.length === 0) { %>
      <tr>
        <td colspan="9" style="text-align:center; padding:16px;">
          No functions found for this view.
        </td>
      </tr>
    <% } else { %>
      <% events.forEach(e => { %>
        <tr>
          <!-- Event + Contact -->
<td>
  <a href="/functions/<%= e.id %>" class="event-link"><%= e.event_name %></a><br>

  <% 
    let contacts = e.contacts || [];
    if (typeof contacts === 'string') contacts = JSON.parse(e.contacts); 
  %>
  <% if (contacts.length > 0) { 
       const primary = contacts.find(c => c.is_primary) || contacts[0];
       const extra = contacts.length - 1;
  %>
    <span class="subtext">
      <%= primary.name %>
      <% if (extra > 0) { %>
        <span style="color:#888;"> +<%= extra %></span>
      <% } %>
    </span>
  <% } else { %>
    <span class="subtext" style="color:#999;">No contact</span>
  <% } %>
</td>

          <!-- Status with badge -->
          <td>
            <span class="status-badge status-<%= e.status %>"><%= e.status %></span>
          </td>

          <!-- Date + Time -->
      <td>
        <%= formatNZDate(e.event_date) %><br>
        <% if (e.event_time) { %>
        <span class="subtext">
        <%= e.event_time.toString().slice(0, 5) %>
       </span>
       <% } %>
      </td>


          <!-- Attendees -->
          <td><%= e.attendees || '' %></td>

          <!-- Value -->
          <td>
            <% if (e.totals_price) { %>
              $<%= Number(e.totals_price).toFixed(2) %>
            <% } else { %>
              â€”
            <% } %>
          </td>

          <!-- Room -->
          <td><%= e.room_name || '' %></td>

          <!-- Owner -->
          <td><%= e.owner_name || '' %></td>

          <!-- Created -->
          <td><%= formatNZDate(e.created_at) %></td>

          <!-- Actions -->
          <td class="table-actions">
            <a href="/functions/<%= e.id %>" class="btn small">View</a>
            <a href="/function/<%= e.id %>/edit" class="btn ghost small">Edit</a>
          </td>
        </tr>
      <% }) %>
    <% } %>
  </tbody>
</table>
    </div>
  </main>
</body>
</html>
