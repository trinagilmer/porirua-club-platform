<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title><%= fn.event_name %> - Function Detail</title>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user: user }) %>

  <main class="main-content">

    <!-- üß≠ HEADER -->
    <div class="function-header">
      <h1 class="function-title"><%= fn.event_name %></h1>
      <div class="function-actions">
        <a href="/functions/<%= fn.id %>/edit" class="btn">Edit Function</a>
      </div>
    </div>

    <!-- üß© TABS -->
    <div class="tabs-bar">
      <a href="/functions/<%= fn.id %>?tab=info" class="<%= activeTab==='info'?'active':'' %>">Info</a>
      <a href="/functions/<%= fn.id %>?tab=tasks" class="<%= activeTab==='tasks'?'active':'' %>">Tasks</a>
      <a href="/functions/<%= fn.id %>?tab=notes" class="<%= activeTab==='notes'?'active':'' %>">Notes</a>
      <a href="/functions/<%= fn.id %>/communications" class="<%= activeTab==='communications'?'active':'' %>">Communications</a>
    </div>

    <!-- üß± GRID LAYOUT -->
    <div class="function-layout">
      
      <!-- CONTACTS COLUMN -->
      <aside class="card contact-panel hover-lift">
        <h3>Contacts</h3>

        <div id="contactInfo" class="contact-card-list">
          <% if (linkedContacts.length > 0) { %>
            <% linkedContacts.forEach(c => { %>
              <div class="contact-card <%= c.is_primary ? 'primary' : '' %>">
                <div class="contact-avatar"><%= c.name.charAt(0).toUpperCase() %></div>
                <div class="contact-details">
                  <div class="contact-name">
                    <strong><%= c.name %></strong>
                    <% if (c.is_primary) { %><span class="primary-badge">‚≠ê</span><% } %>
                  </div>
                  <div class="contact-email"><a href="mailto:<%= c.email %>"><%= c.email %></a></div>
                  <div class="contact-phone"><%= c.phone || '' %></div>
                </div>
                <div class="contact-actions">
                  <button class="menu-btn" data-id="<%= c.id %>">‚ãÆ</button>
                  <div class="menu-dropdown hidden" id="menu-<%= c.id %>">
                    <button class="menu-item edit-btn" data-id="<%= c.id %>">Edit</button>
                    <% if (!c.is_primary) { %>
                      <button class="menu-item primary-btn" data-id="<%= c.id %>">Make Primary</button>
                    <% } %>
                    <button class="menu-item remove-btn" data-id="<%= c.id %>">Remove</button>
                    <button class="menu-item delete-btn" data-id="<%= c.id %>">Delete</button>
                    <button class="menu-item view-btn" data-id="<%= c.id %>">View</button>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted">No contacts assigned yet.</p>
          <% } %>
        </div>

        <!-- ‚ûï Add Contact -->
        <button class="add-contact-fab" id="addContactBtn">+</button>
      </aside>

      <!-- MAIN DETAIL PANEL -->
      <section class="detail-panel">

        <% if (activeTab === 'info') { %>
          <div class="card function-section">
            <h3>Event Details</h3>
            <p><strong>Status:</strong> <span class="badge <%= fn.status %>"><%= fn.status %></span></p>
            <p><strong>Date:</strong> <%= formatNZDate(fn.event_date) %> at <%= fn.event_time || 'TBC' %></p>
            <p><strong>Attendees:</strong> <%= fn.attendees || '‚Äî' %></p>
            <p><strong>Total:</strong> $<%= fn.totals_price || 0 %></p>
            <p><strong>Room:</strong> <%= fn.room_name || '‚Äî' %></p>
            <p><strong>Notes:</strong> <%= fn.notes || 'No notes yet' %></p>
          </div>
        <% } %>

        <% if (activeTab === 'tasks') { %>
          <div class="card function-section">
            <h3>Tasks</h3>
            <% if (tasks.length === 0) { %>
              <p class="text-muted">No tasks yet.</p>
            <% } else { %>
              <table class="table compact">
                <thead>
                  <tr><th>Title</th><th>Status</th><th>Due</th><th>Assignee</th></tr>
                </thead>
                <tbody>
                  <% tasks.forEach(t => { %>
                    <tr>
                      <td><%= t.title %></td>
                      <td><%= t.status %></td>
                      <td><%= t.due_at ? formatNZDate(t.due_at) : '‚Äî' %></td>
                      <td><%= t.assignee || '‚Äî' %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            <% } %>
          </div>
        <% } %>

        <% if (activeTab === 'notes') { %>
          <div class="card function-section">
            <h3>Notes</h3>
            <% if (notes.length === 0) { %>
              <p class="text-muted">No notes yet.</p>
            <% } else { %>
              <ul class="note-list">
                <% notes.forEach(n => { %>
                  <li><strong><%= formatNZDate(n.created_at) %>:</strong> <%= n.content %></li>
                <% }) %>
              </ul>
            <% } %>
            <div class="sticky-actions">
              <button id="newNoteBtn" class="btn small">Add Note</button>
            </div>
          </div>
        <% } %>

      </section>
    </div>
  </main>

  <!-- Overlay panel reused from previous version -->
  <div id="contactPanel" class="contact-edit-panel">
    <!-- ... same inner content as before ... -->
  </div>
  <div id="panelOverlay" class="panel-overlay"></div>

  <!-- Global UI + Page Interactions -->
  <script src="/js/ui.js"></script>
  <script>
    const fnId = "<%= fn.id %>";

    // Reuse your existing panel toggle logic but with wrappedFetch()
    // For brevity, we skip full duplication here (you already have it)
    // Only fetch() calls need to use wrappedFetch()

    // Example integration:
    async function addContact(contactData) {
      await wrappedFetch(`/functions/${fnId}/new-contact`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(contactData)
      }).then(() => location.reload());
    }
  </script>
</body>
</html>





