<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title><%= fn.event_name %> - Function Detail</title>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user: user }) %>

  <main class="main-content">
    <h1 style="color:var(--deep);margin-top:0;"><%= fn.event_name %></h1>

<div style="display:grid;grid-template-columns:380px 1fr;gap:24px;align-items:start;">

      <!-- 🧍 CONTACTS COLUMN -->
<div class="card">
  <h3 style="margin-top:0;color:var(--deep);">Contacts</h3>

  <!-- Contact List -->
  <div id="contactInfo">
    <% if (linkedContacts.length > 0) { %>
      <table class="compact-table" style="width:100%;margin-bottom:10px;">
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Phone</th><th>Company</th>
          </tr>
        </thead>
        <tbody>
          <% linkedContacts.forEach(c => { %>
            <tr>
              <td><strong><%= c.name %></strong></td>
              <td><a href="mailto:<%= c.email %>"><%= c.email %></a></td>
              <td><%= c.phone || '' %></td>
              <td><%= c.company || '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <p>No contacts assigned yet.</p>
    <% } %>
  </div>

  <!-- Assign Existing -->
  <form id="assignContactForm" action="/functions/<%= fn.id %>/link-contact" method="POST" style="margin-top:12px;">
    <label style="font-weight:600;">Link existing contact</label>
    <select name="contact_id" style="width:100%;padding:6px;border-radius:6px;margin-top:4px;">
      <option value="">— Select Contact —</option>
      <% contacts.forEach(c => { %>
        <option value="<%= c.id %>"><%= c.name %> (<%= c.email %>)</option>
      <% }) %>
    </select>
    <button class="btn" style="margin-top:8px;" type="submit">Link</button>
  </form>

  <!-- Add New Contact -->
  <form action="/functions/<%= fn.id %>/new-contact" method="POST" style="margin-top:12px;background:#f4f6f8;padding:12px;border-radius:8px;">
    <label style="font-weight:600;">Add new contact</label>
    <input type="text" name="name" placeholder="Name" required style="width:100%;margin-bottom:6px;">
    <input type="email" name="email" placeholder="Email" required style="width:100%;margin-bottom:6px;">
    <input type="text" name="phone" placeholder="Phone" style="width:100%;margin-bottom:6px;">
    <input type="text" name="company" placeholder="Company" style="width:100%;margin-bottom:10px;">
    <button type="submit" class="btn">Add + Link</button>
  </form>
</div>

      <!-- 📋 MAIN FUNCTION DETAILS -->
      <div>
        <div class="card">
          <h3 style="margin-top:0;color:var(--deep);">Event Details</h3>
          <p><strong>Status:</strong> <%= fn.status %></p>
          <p><strong>Date:</strong> <%= formatNZDate(fn.event_date) %> at <%= fn.event_time || 'TBC' %></p>
          <p><strong>Attendees:</strong> <%= fn.attendees || '—' %></p>
          <p><strong>Total:</strong> $<%= fn.totals_price || 0 %></p>
          <p><strong>Room:</strong> <%= fn.room_name || '—' %></p>
          <p><strong>Notes:</strong> <%= fn.notes || 'No notes yet' %></p>

          <a href="/functions/<%= fn.id %>/edit" class="btn">Edit Function</a>
        </div>

        <!-- Tasks -->
        <div class="card">
          <h3 style="color:var(--deep);">Tasks</h3>
          <% if (!tasks.length) { %>
            <p>No tasks yet.</p>
          <% } else { %>
            <ul>
              <% tasks.forEach(t => { %>
                <li><strong><%= t.title %></strong> — <%= t.status %></li>
              <% }) %>
            </ul>
          <% } %>
        </div>

        <!-- Notes -->
        <div class="card">
          <h3 style="color:var(--deep);">Notes</h3>
          <% if (!notes.length) { %>
            <p>No notes yet.</p>
          <% } else { %>
            <ul>
              <% notes.forEach(n => { %>
                <li><strong><%= formatNZDate(n.created_at) %>:</strong> <%= n.content %></li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <!-- 💡 AJAX Contact Scripts -->
  <script>
  const fnId = "<%= fn.id %>";

  // Toggle Add Contact form
  document.getElementById('showAddContact').addEventListener('click', e => {
    e.preventDefault();
    const form = document.getElementById('addContactForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  });

  // Save new contact + auto assign
  document.getElementById('saveNewContact').addEventListener('click', async () => {
    const name = document.getElementById('newContactName').value.trim();
    const email = document.getElementById('newContactEmail').value.trim();
    const phone = document.getElementById('newContactPhone').value.trim();
    const company = document.getElementById('newContactCompany').value.trim();

    if (!name || !email) {
      alert('Name and Email are required.');
      return;
    }

    try {
      const res = await fetch(`/functions/${fnId}/add-contact`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, phone, company })
      });
      const data = await res.json();

      if (data.success) {
        const c = data.contact;

        // Update dropdown + contact display
        const select = document.getElementById('contactSelect');
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.name} (${c.email})`;
        select.appendChild(opt);
        select.value = c.id;

        document.getElementById('contactInfo').innerHTML = `
          <p><strong>${c.name}</strong></p>
          <p>${c.company || ''}</p>
          <p><a href="mailto:${c.email}">${c.email}</a></p>
          <p>${c.phone || ''}</p>
        `;

        // Hide and clear form
        document.getElementById('addContactForm').style.display = 'none';
        document.getElementById('newContactName').value = '';
        document.getElementById('newContactEmail').value = '';
        document.getElementById('newContactPhone').value = '';
        document.getElementById('newContactCompany').value = '';
        alert('Contact added and assigned successfully');
      } else {
        alert(data.message || 'Error saving contact');
      }
    } catch (err) {
      console.error(err);
      alert('Failed to add contact');
    }
  });

  // Assign existing contact
  document.getElementById('assignContactForm').addEventListener('submit', async e => {
    e.preventDefault();
    const contactId = document.getElementById('contactSelect').value;
    if (!contactId) return alert('Please select a contact.');

    try {
      const res = await fetch(`/functions/${fnId}/assign-contact`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact_id: contactId })
      });
      const data = await res.json();

      if (data.success) {
        const c = data.contact;
        document.getElementById('contactInfo').innerHTML = `
          <p><strong>${c.name}</strong></p>
          <p>${c.company || ''}</p>
          <p><a href="mailto:${c.email}">${c.email}</a></p>
          <p>${c.phone || ''}</p>
        `;
        alert('Contact assigned successfully');
      } else alert(data.message || 'Error updating contact');
    } catch (err) {
      console.error(err);
      alert('Failed to assign contact');
    }
  });
  </script>

</body>
</html>


