<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title><%= fn.event_name %> — Function Detail</title>
  <style>
    /* Local enhancements just for this page (can move to CSS later) */
    .comm-entry {
      border-left: 4px solid var(--primary);
      background: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: transform .2s ease;
    }
    .comm-entry:hover { transform: translateY(-2px); }
    .comm-meta {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 4px;
    }
    .comm-subject {
      font-weight: 600;
      color: var(--deep);
      margin-bottom: 6px;
    }
    .comm-body {
      font-size: 0.9rem;
      color: #444;
      white-space: pre-line;
    }
    .comm-type {
      text-transform: capitalize;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--accent);
      color: var(--deep);
      padding: 3px 6px;
      border-radius: 6px;
      margin-right: 6px;
    }
    .no-comms {
      color: #888;
      font-style: italic;
      text-align: center;
      margin: 12px 0;
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user: user }) %>

  <main class="main-content fade-in">
    <!-- HEADER -->
    <div class="function-header">
      <h1 class="function-title"><%= fn.event_name %></h1>
      <div class="function-actions">
        <a href="/functions/<%= fn.id %>/edit" class="btn">Edit Function</a>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs-bar">
      <a href="/functions/<%= fn.id %>?tab=info" class="<%= activeTab==='info'?'active':'' %>">Info</a>
      <a href="/functions/<%= fn.id %>?tab=tasks" class="<%= activeTab==='tasks'?'active':'' %>">Tasks</a>
      <a href="/functions/<%= fn.id %>?tab=notes" class="<%= activeTab==='notes'?'active':'' %>">Notes</a>
      <a href="/functions/<%= fn.id %>?tab=communications" class="<%= activeTab==='communications'?'active':'' %>">Communications</a>
    </div>

    <div class="function-layout">
      <!-- LEFT: CONTACTS -->
      <aside class="card contact-panel">
        <h3>Contacts</h3>
        <div class="contact-card-list">
          <% if (linkedContacts.length) { %>
            <% linkedContacts.forEach(c => { %>
              <div class="contact-card <%= c.is_primary ? 'primary' : '' %>">
                <div class="contact-avatar"><%= c.name.charAt(0).toUpperCase() %></div>
                <div class="contact-details">
                  <div class="contact-name">
                    <strong><%= c.name %></strong>
                    <% if (c.is_primary) { %><span class="primary-badge">⭐</span><% } %>
                  </div>
                  <div class="contact-email"><a href="mailto:<%= c.email %>"><%= c.email %></a></div>
                  <div class="contact-phone"><%= c.phone || '' %></div>
                </div>
                <div class="contact-actions">
                  <button class="menu-btn" data-id="<%= c.id %>">⋮</button>
                  <div class="menu-dropdown hidden" id="menu-<%= c.id %>">
                    <button class="menu-item view-btn" data-id="<%= c.id %>">View</button>
                    <button class="menu-item edit-btn" data-id="<%= c.id %>">Edit</button>
                    <% if (!c.is_primary) { %>
                      <button class="menu-item primary-btn" data-id="<%= c.id %>">Make Primary</button>
                    <% } %>
                    <button class="menu-item remove-btn" data-id="<%= c.id %>">Remove</button>
                    <button class="menu-item delete-btn" data-id="<%= c.id %>">Delete</button>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No contacts assigned yet.</p>
          <% } %>
        </div>
        <button class="add-contact-fab" id="addContactBtn">+</button>
      </aside>

      <!-- RIGHT: DETAILS -->
      <section class="detail-panel">
        <% if (activeTab === 'info') { %>
          <div class="card function-section">
            <h3>Event Details</h3>
            <p><strong>Status:</strong> <%= fn.status %></p>
            <p><strong>Date:</strong> <%= formatNZDate(fn.event_date) %> <%= fn.event_time || '' %></p>
            <p><strong>Room:</strong> <%= fn.room_name || '—' %></p>
            <p><strong>Attendees:</strong> <%= fn.attendees || '—' %></p>
            <p><strong>Total:</strong> $<%= fn.totals_price || 0 %></p>
            <p><strong>Owner:</strong> <%= fn.owner_name || 'Unassigned' %></p>
          </div>
        <% } %>

        <% if (activeTab === 'tasks') { %>
          <div class="card function-section">
            <h3>Tasks</h3>
            <% if (!tasks.length) { %><p>No tasks yet.</p><% } else { %>
              <ul class="task-list">
                <% tasks.forEach(t => { %>
                  <li><strong><%= t.title %></strong> — <%= t.status %> <% if (t.due_at) { %>(Due <%= formatNZDate(t.due_at) %>)<% } %></li>
                <% }) %>
              </ul>
            <% } %>
          </div>
        <% } %>

        <% if (activeTab === 'notes') { %>
          <div class="card function-section">
            <h3>Notes</h3>
            <% if (!notes.length) { %><p>No notes yet.</p><% } else { %>
              <ul class="note-list">
                <% notes.forEach(n => { %>
                  <li><strong><%= formatNZDate(n.created_at) %>:</strong> <%= n.content %></li>
                <% }) %>
              </ul>
            <% } %>
          </div>
        <% } %>

        <% if (activeTab === 'communications') { %>
          <div class="card function-section">
            <h3>All Communications</h3>
            <% if (!communications.length) { %>
              <p class="no-comms">No communications found for this function.</p>
            <% } else { %>
              <% communications.forEach(c => { %>
                <div class="comm-entry">
                  <div class="comm-meta">
                    <span class="comm-type"><%= c.entry_type %></span>
                    <%= new Date(c.entry_date).toLocaleString('en-NZ') %>
                  </div>
                  <% if (c.subject) { %><div class="comm-subject"><%= c.subject %></div><% } %>
                  <% if (c.body) { %><div class="comm-body"><%= c.body.substring(0, 300) %>...</div><% } %>
                  <% if (c.from_email) { %>
                    <div class="comm-meta">From: <%= c.from_email %></div>
                  <% } %>
                  <% if (c.to_email) { %>
                    <div class="comm-meta">To: <%= c.to_email.join(', ') %></div>
                  <% } %>
                </div>
              <% }) %>
            <% } %>
          </div>
        <% } %>
      </section>
    </div>
  </main>

  <!-- SLIDE-IN PANEL -->
  <div id="contactPanel" class="contact-edit-panel">
    <h3 id="contactPanelTitle">Add Contact</h3>
    <input type="hidden" id="contactPanelMode" value="add">
    <input type="hidden" id="editContactId">

    <div class="contact-panel-tabs">
      <button id="modeExisting" class="tab-btn active">Existing Contact</button>
      <button id="modeNew" class="tab-btn">New Contact</button>
    </div>

    <div id="existingContactSection">
      <input type="text" id="existingContactSearch" placeholder="Search existing contacts..." class="contact-search">
      <select id="existingContactSelect" size="8" class="contact-dropdown"></select>
      <button id="linkExistingBtn" class="btn" style="margin-top: 10px;">Link Selected</button>
    </div>

    <div id="newContactSection" class="hidden">
      <input type="text" id="newContactName" placeholder="Name" required>
      <input type="email" id="newContactEmail" placeholder="Email" required>
      <input type="text" id="newContactPhone" placeholder="Phone">
      <input type="text" id="newContactCompany" placeholder="Company">
      <button type="button" id="saveNewContactBtn" class="btn">Save Contact</button>
    </div>

    <div class="panel-actions">
      <button type="button" id="closePanel" class="btn ghost">Cancel</button>
    </div>
  </div>

  <div id="panelOverlay" class="panel-overlay"></div>

  <!-- VIEW CONTACT MODAL -->
  <div id="viewContactModal" class="modal hidden">
    <div class="modal-content">
      <h3>Contact Details</h3>
      <div id="contactDetails"></div>
      <h4>Recent Communications</h4>
      <div id="contactEmails" class="mini-timeline"></div>
      <button id="closeModalBtn" class="btn ghost">Close</button>
    </div>
  </div>

  <script src="/js/function-detail.js"></script>
</body>
</html>






