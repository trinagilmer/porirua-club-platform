<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title><%= fn.event_name %> - Function Detail</title>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user }) %>

  <main class="main-content">
    <!-- =========================
         HEADER
    ========================== -->
    <div class="function-header">
      <h1 class="function-title"><%= fn.event_name %></h1>
      <div class="function-actions">
        <a href="/functions/<%= fn.id %>/edit" class="btn">Edit Function</a>
      </div>
    </div>

    <!-- =========================
         TABS BAR
    ========================== -->
    <div class="tabs-bar">
      <a href="/functions/<%= fn.id %>" class="<%= activeTab === 'info' ? 'active' : '' %>">Info</a>
      <a href="/functions/<%= fn.id %>?tab=tasks" class="<%= activeTab === 'tasks' ? 'active' : '' %>">Tasks</a>
      <a href="/functions/<%= fn.id %>?tab=notes" class="<%= activeTab === 'notes' ? 'active' : '' %>">Notes</a>
      <a href="/functions/<%= fn.id %>/communications" class="<%= activeTab === 'communications' ? 'active' : '' %>">Communications</a>
    </div>

    <!-- =========================
         GRID LAYOUT
    ========================== -->
    <div class="function-layout">

      <!-- CONTACT PANEL -->
      <aside class="card contact-panel">
        <h3>Contacts</h3>

        <div id="contactInfo" class="contact-card-list">
          <% if (linkedContacts.length > 0) { %>
            <% linkedContacts.forEach(c => { %>
              <div class="contact-card <%= c.is_primary ? 'primary' : '' %>">
                <div class="contact-avatar"><%= c.name.charAt(0).toUpperCase() %></div>
                <div class="contact-details">
                  <div class="contact-name">
                    <strong><%= c.name %></strong>
                    <% if (c.is_primary) { %><span class="primary-badge" title="Primary Contact">‚≠ê</span><% } %>
                  </div>
                  <div class="contact-email"><%= c.email || '‚Äî' %></div>
                  <% if (c.phone) { %><div class="contact-phone"><%= c.phone %></div><% } %>
                </div>

                <div class="contact-actions">
                  <button class="menu-btn" data-id="<%= c.id %>">‚ãÆ</button>
                  <div class="menu-dropdown hidden" id="menu-<%= c.id %>">
                    <button class="menu-item view-btn" data-id="<%= c.id %>">View</button>
                    <button class="menu-item edit-btn" data-id="<%= c.id %>">Edit</button>
                    <% if (!c.is_primary) { %>
                      <button class="menu-item primary-btn" data-id="<%= c.id %>">Make Primary</button>
                    <% } %>
                    <button class="menu-item remove-btn" data-id="<%= c.id %>">Remove</button>
                    <button class="menu-item delete-btn" data-id="<%= c.id %>">Delete</button>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="subtext">No contacts assigned yet.</p>
          <% } %>
        </div>

        <!-- ‚ûï Add Contact FAB -->
        <button id="openAddPanelBtn" class="add-contact-fab" title="Add new contact">+</button>
      </aside>

      <!-- DETAILS PANEL -->
      <section class="detail-panel">
        <!-- EVENT DETAILS -->
        <div class="card function-section">
          <h3>Event Details</h3>
          <p><strong>Status:</strong> <%= fn.status %></p>
          <p><strong>Date:</strong> <%= formatNZDate(fn.event_date) %> at <%= fn.event_time || 'TBC' %></p>
          <p><strong>Room:</strong> <%= fn.room_name || '‚Äî' %></p>
          <p><strong>Attendees:</strong> <%= fn.attendees || '‚Äî' %></p>
          <p><strong>Total:</strong> $<%= fn.totals_price || 0 %></p>
          <p><strong>Owner:</strong> <%= fn.owner_name || '‚Äî' %></p>
          <p><strong>Notes:</strong> <%= fn.notes || 'No notes yet' %></p>
        </div>

        <!-- RECENT COMMUNICATIONS -->
        <div class="card function-section">
          <h3>Recent Communications</h3>
          <% if (typeof grouped !== 'undefined' && Object.keys(grouped).length > 0) { %>
            <% for (const date in grouped) { %>
              <div class="comm-day-group">
                <h4 class="comm-date"><%= date %></h4>
                <ul class="comm-list">
                  <% grouped[date].forEach(msg => { %>
                    <li class="comm-entry <%= msg.entry_type %>">
                      <% if (msg.entry_type === 'message') { %>
                        üìß <strong><%= msg.subject || '(No subject)' %></strong><br>
                        <small class="subtext"><%= msg.from_email %> ‚Üí <%= (msg.to_email || []).join(', ') %></small>
                      <% } else if (msg.entry_type === 'note') { %>
                        üìù <strong>Note:</strong> <%= msg.body %>
                      <% } else if (msg.entry_type === 'task') { %>
                        ‚úÖ <strong>Task:</strong> <%= msg.subject %>
                      <% } %>
                    </li>
                  <% }) %>
                </ul>
              </div>
            <% } %>
            <a href="/functions/<%= fn.id %>/communications" class="btn small mt-2">View All</a>
          <% } else { %>
            <p>No communications yet.</p>
          <% } %>
        </div>

        <!-- TASKS -->
        <div class="card function-section">
          <h3>Tasks</h3>
          <% if (!tasks.length) { %>
            <p>No tasks yet.</p>
          <% } else { %>
            <ul class="task-list">
              <% tasks.forEach(t => { %>
                <li>
                  <strong><%= t.title %></strong> ‚Äî <%= t.status %>
                  <% if (t.due_at) { %>
                    <span class="subtext">(due <%= formatNZDate(t.due_at) %>)</span>
                  <% } %>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </section>
    </div>
  </main>
<!-- üîπ Modals and Panels -->
<%- include('../partials/function-modals') %>

<!-- üîπ Script -->
<script>
  window.fnContext = {
    id: "<%= fn.id %>",
    name: "<%= fn.event_name %>",
    userId: "<%= user ? user.id : '' %>"
  };
</script>
<script src="/js/function-detail.js"></script>
</body>
</html>









