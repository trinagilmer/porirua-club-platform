<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title><%= title %></title>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user: user }) %>

  <main class="main-content">
    <!-- Header -->
    <div class="function-header">
      <h1 class="function-title"><%= fn.event_name %></h1>
      <div class="function-actions">
        <a href="/functions/<%= fn.id %>" class="btn ghost">Back to Details</a>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-bar">
      <a href="/functions/<%= fn.id %>?tab=info">Info</a>
      <a href="/functions/<%= fn.id %>?tab=tasks">Tasks</a>
      <a href="/functions/<%= fn.id %>?tab=notes">Notes</a>
      <a href="/functions/<%= fn.id %>/communications" class="active">Communications</a>
    </div>

    <!-- Communications Timeline -->
    <div class="card">
      <% if (Object.keys(grouped).length === 0) { %>
        <p class="text-muted">No communication history yet for this function.</p>
      <% } else { %>
        <% Object.keys(grouped).forEach(date => { %>
          <div class="timeline-day">
            <h4 class="timeline-date"><%= date %></h4>
            <div class="timeline-items">
              <% grouped[date].forEach(entry => { %>
                <div class="timeline-entry <%= entry.entry_type %> hover-lift">
                  <div class="entry-header">
                    <% if (entry.entry_type === 'message') { %>
                      <span class="entry-icon">üìß</span>
                      <span class="entry-label">Email</span>
                    <% } else if (entry.entry_type === 'note') { %>
                      <span class="entry-icon">üìù</span>
                      <span class="entry-label">Note</span>
                    <% } else if (entry.entry_type === 'task') { %>
                      <span class="entry-icon">‚úÖ</span>
                      <span class="entry-label">Task</span>
                    <% } %>
                    <% if (entry.subject) { %>
                      <strong class="entry-subject"><%= entry.subject %></strong>
                    <% } %>
                    <span class="entry-time"><%= new Date(entry.entry_date).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}) %></span>
                  </div>
                  
                  <div class="entry-body">
                    <% if (entry.body) { %>
                      <div class="entry-text"><%= entry.body.length > 300 ? entry.body.substring(0, 300) + '...' : entry.body %></div>
                    <% } else { %>
                      <div class="entry-text text-muted">(no message body)</div>
                    <% } %>
                  </div>

                  <% if (entry.entry_type === 'message') { %>
                    <div class="entry-meta">
                      <small>From: <%= entry.from_email || 'System' %></small>
                      <small>To: <%= (entry.to_email && entry.to_email.join(', ')) || 'N/A' %></small>
                    </div>
                  <% } %>
                </div>
              <% }) %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>

  <script src="/js/ui.js"></script>
</body>
</html>

