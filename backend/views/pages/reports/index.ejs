<%
  const helpers = (report && report.helpers) || {};
  helpers.formatCurrency = helpers.formatCurrency || function (value) { return value ?? 0; };
  helpers.formatDisplayDate = helpers.formatDisplayDate || function (value) { return value || ""; };
  helpers.formatTime = helpers.formatTime || function (value) { return value || ""; };
%>
<div class="container-fluid py-4 reports-page">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-1">Reports</h1>
      <p class="text-muted mb-0">Download ready-to-share data from functions, restaurant bookings, and entertainment.</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="/calendar">
        <i class="bi bi-calendar3 me-1"></i>
        Back to calendar
      </a>
      <a class="btn btn-outline-secondary" href="/settings">
        <i class="bi bi-gear me-1"></i>
        Settings
      </a>
    </div>
  </div>

  <section class="card shadow-sm mb-4">
    <div class="card-body">
      <form class="row g-3 align-items-end" method="GET" action="/reports">
        <div class="col-md-3 col-sm-6">
          <label class="form-label">Report type</label>
          <select name="type" class="form-select">
            <option value="functions" <%= filters.type === 'functions' ? 'selected' : '' %>>Functions</option>
            <option value="restaurant" <%= filters.type === 'restaurant' ? 'selected' : '' %>>Restaurant bookings</option>
            <option value="entertainment" <%= filters.type === 'entertainment' ? 'selected' : '' %>>Entertainment</option>
            <option value="contact-value" <%= filters.type === 'contact-value' ? 'selected' : '' %>>Contacts (spend)</option>
          </select>
        </div>
        <div class="col-md-3 col-sm-6">
          <label class="form-label">Start date</label>
          <input type="date" name="start_date" class="form-control" value="<%= filters.startDate %>" required>
        </div>
        <div class="col-md-3 col-sm-6">
          <label class="form-label">End date</label>
          <input type="date" name="end_date" class="form-control" value="<%= filters.endDate %>" required>
        </div>
        <div class="col-md-3 col-sm-6 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">
            <i class="bi bi-filter-circle me-1"></i>
            Run report
          </button>
          <a
            class="btn btn-outline-secondary"
            href="/reports/export?<%= new URLSearchParams({
                type: filters.type,
                start_date: filters.startDate,
                end_date: filters.endDate
              }).toString() %>"
          >
            <i class="bi bi-file-earmark-spreadsheet me-1"></i>
            Excel
          </a>
        </div>
      </form>
    </div>
  </section>

  <% if (!report || !report.rows || !report.rows.length) { %>
    <div class="alert alert-light border">
      No records were found for the selected dates. Try widening the range or choosing another report.
    </div>
  <% } else { %>
    <section class="mb-3">
      <div class="row g-3">
        <% if (filters.type === 'functions') { %>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Total functions</p>
                <h3 class="mb-0"><%= report.rows.length %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Revenue (NZD)</p>
                <h3 class="mb-0"><%= helpers.formatCurrency(report.summary.totalRevenue || 0) %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Profit (NZD)</p>
                <h3 class="mb-0"><%= helpers.formatCurrency(report.summary.totalProfit || 0) %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Expected attendees</p>
                <h3 class="mb-0"><%= report.summary.totalAttendees || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Statuses</p>
                <div class="d-flex flex-wrap gap-2">
                  <% Object.entries(report.summary.statusCounts || {}).forEach(([status, count]) => { %>
                    <span class="badge bg-light text-dark text-uppercase">
                      <%= status.replace('_',' ') %>: <%= count %>
                    </span>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% } else if (filters.type === 'restaurant') { %>
          <div class="col-sm-4">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Bookings</p>
                <h3 class="mb-0"><%= report.rows.length %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Guests</p>
                <h3 class="mb-0"><%= report.summary.totalGuests || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Statuses</p>
                <div class="d-flex flex-wrap gap-2">
                  <% Object.entries(report.summary.statusCounts || {}).forEach(([status, count]) => { %>
                    <span class="badge bg-light text-dark text-uppercase">
                      <%= status %>: <%= count %>
                    </span>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% } else if (filters.type === 'restaurant') { %>
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Party</th>
                <th>Date</th>
                <th>Time</th>
                <th>Guests</th>
                <th>Status</th>
                <th>Service</th>
                <th>Channel</th>
              </tr>
            </thead>
            <tbody>
              <% report.rows.forEach(function(row) { %>
                <tr>
                  <td><a href="/calendar/restaurant/bookings/<%= row.id %>"><%= row.party_name %></a></td>
                  <td><%= helpers.formatDisplayDate(row.booking_date) %></td>
                  <td><%= helpers.formatTime(row.booking_time) %></td>
                  <td><%= row.size || 0 %></td>
                  <td><span class="badge bg-light text-dark text-uppercase"><%= row.status || 'pending' %></span></td>
                  <td><%= row.service_name || '—' %></td>
                  <td><%= (row.channel || 'internal') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else if (filters.type === 'contact-value') { %>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Contacts</p>
                <h3 class="mb-0"><%= report.summary.contactCount || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Functions booked</p>
                <h3 class="mb-0"><%= report.summary.totalFunctions || 0 %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Revenue</p>
                <h3 class="mb-0"><%= helpers.formatCurrency(report.summary.totalRevenue || 0) %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Top contact</p>
                <% if (report.summary.topContact) { %>
                  <h6 class="mb-0"><%= report.summary.topContact.name %></h6>
                  <small class="text-muted">Spent <%= helpers.formatCurrency(report.summary.topContact.revenue || 0) %></small>
                <% } else { %>
                  <p class="text-muted mb-0">—</p>
                <% } %>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="col-sm-4">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Events</p>
                <h3 class="mb-0"><%= report.rows.length %></h3>
              </div>
            </div>
          </div>
          <div class="col-sm-8">
            <div class="report-stat card shadow-sm">
              <div class="card-body">
                <p class="text-muted text-uppercase small mb-1">Statuses</p>
                <div class="d-flex flex-wrap gap-2">
                  <% Object.entries(report.summary.statusCounts || {}).forEach(([status, count]) => { %>
                    <span class="badge bg-light text-dark text-uppercase">
                      <%= status %>: <%= count %>
                    </span>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </section>

    <section class="card shadow-sm">
      <div class="card-body table-responsive">
        <% if (filters.type === 'functions') { %>
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Event</th>
                <th>Date</th>
                <th>Start</th>
                <th>Status</th>
                <th>Attendees</th>
                <th>Room</th>
                <th>Owner</th>
                <th>Revenue</th>
                <th>Cost</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody>
              <% report.rows.forEach(function(fn) { %>
                <tr>
                  <td>
                    <strong><a href="/functions/<%= fn.id_uuid %>" class="text-decoration-none"><%= fn.event_name %></a></strong>
                  </td>
                  <td><%= helpers.formatDisplayDate(fn.event_date) %></td>
                  <td><%= helpers.formatTime(fn.start_time || fn.event_time) %></td>
                  <td><span class="badge bg-light text-dark text-uppercase"><%= fn.status || 'lead' %></span></td>
                  <td><%= fn.attendees || 0 %></td>
                  <td><%= fn.room_name || 'Unassigned' %></td>
                  <td><%= fn.owner_name || '—' %></td>
                  <td><%= helpers.formatCurrency(fn.totals_price || 0) %></td>
                  <td><%= helpers.formatCurrency(fn.totals_cost || 0) %></td>
                  <td><%= helpers.formatCurrency((fn.totals_price || 0) - (fn.totals_cost || 0)) %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else if (filters.type === 'contact-value') { %>
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Contact</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Functions</th>
                <th>Revenue</th>
                <th>Cost</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody>
              <% report.rows.forEach(function(row) { %>
                <tr>
                  <td><a href="/contacts?selected=<%= row.id %>" class="text-decoration-none"><%= row.name %></a></td>
                  <td><%= row.email || '—' %></td>
                  <td><%= row.phone || '—' %></td>
                  <td><%= row.function_count || 0 %></td>
                  <td><%= helpers.formatCurrency(row.revenue || 0) %></td>
                  <td><%= helpers.formatCurrency(row.cost || 0) %></td>
                  <td><%= helpers.formatCurrency((row.revenue || 0) - (row.cost || 0)) %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else { %>
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Event</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th>Room</th>
                <th>Adjunct</th>
                <th>Organiser</th>
              </tr>
            </thead>
            <tbody>
              <% report.rows.forEach(function(evt) { %>
                <tr>
                  <td><a href="/entertainment/<%= evt.id %>" target="_blank" rel="noopener"><%= evt.title %></a></td>
                  <td><%= helpers.formatDisplayDate(evt.start_at) %></td>
                  <td><%= helpers.formatTime(evt.start_at) %></td>
                  <td><span class="badge bg-light text-dark text-uppercase"><%= evt.status || 'scheduled' %></span></td>
                  <td><%= evt.room_name || '—' %></td>
                  <td><%= evt.adjunct_name || '-' %></td>
                  <td><%= evt.organiser || '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
    </section>
  <% } %>
</div>
