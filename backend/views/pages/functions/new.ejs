<!-- pages/functions/new.ejs -->
<% locals.layout = 'layouts/main'; %>

<div class="function-body py-4 px-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h1 class="page-title mb-0">Create Function</h1>
    <a href="/functions" class="btn btn-outline-secondary">Back to Dashboard</a>
  </div>

  <% if (formError) { %>
    <div class="alert alert-danger"><%= formError %></div>
  <% } %>

  <% const v = formValues || {}; %>
  <% const selectedWeekdaysRaw = v.recurrence_weekdays ?? v["recurrence_weekdays[]"] ?? []; %>
  <% const selectedWeekdays = Array.isArray(selectedWeekdaysRaw) ? selectedWeekdaysRaw.map(String) : String(selectedWeekdaysRaw || "").split(",").map(function(x){return x.trim();}).filter(Boolean); %>

  <form method="POST" action="/functions/new" class="card p-3 shadow-sm">
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Event Name</label>
        <input type="text" name="event_name" class="form-control" value="<%= v.event_name || '' %>" required />
      </div>

      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input type="date" name="event_date" class="form-control"
               value="<%= v.event_date || '' %>" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Start Time</label>
        <input type="time" name="start_time" class="form-control" value="<%= v.start_time || '' %>" />
      </div>

      <div class="col-md-4">
        <label class="form-label">End Time</label>
        <input type="time" name="end_time" class="form-control" value="<%= v.end_time || '' %>" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Attendees</label>
        <input type="number" name="attendees" class="form-control" value="<%= v.attendees || '' %>" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Budget ($)</label>
        <input type="number" step="0.01" name="budget" class="form-control" value="<%= v.budget || '' %>" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Room / Space</label>
        <select name="room_id" class="form-select">
          <option value="">Select a room</option>
          <% (rooms || []).forEach(r => { %>
            <option value="<%= r.id %>" <%= String(v.room_id || '') === String(r.id) ? 'selected' : '' %>>
              <%= r.name %><% if (r.capacity) { %> (<%= r.capacity %> ppl)<% } %>
            </option>
          <% }) %>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Event Type</label>
        <select name="event_type" class="form-select">
          <option value="">Select type</option>
          <% (eventTypes || []).forEach(t => { %>
            <option value="<%= t.name %>" <%= v.event_type === t.name ? 'selected' : '' %>><%= t.name %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <% (statuses || []).forEach(st => { %>
            <option value="<%= st %>" <%= (v.status || 'lead') === st ? 'selected' : '' %>>
              <%= st.replace('_',' ') %>
            </option>
          <% }) %>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Owner</label>
        <select name="owner_id" class="form-select">
          <option value="">Unassigned</option>
          <% (users || []).forEach(u => { %>
            <option value="<%= u.id %>" <%= String(v.owner_id || '') === String(u.id) ? 'selected' : '' %>>
              <%= u.name %>
            </option>
          <% }) %>
        </select>
      </div>
    </div>

    <div class="border rounded-3 p-3 mt-3 bg-light">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h5 class="mb-0">Recurrence</h5>
          <small class="text-muted">Optionally repeat this function on a cadence.</small>
        </div>
      </div>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Repeats</label>
          <select name="recurrence_frequency" class="form-select">
            <option value="none" <%= (v.recurrence_frequency || 'none') === 'none' ? 'selected' : '' %>>Does not repeat</option>
            <option value="daily" <%= v.recurrence_frequency === 'daily' ? 'selected' : '' %>>Daily</option>
            <option value="weekly" <%= v.recurrence_frequency === 'weekly' ? 'selected' : '' %>>Weekly</option>
            <option value="monthly_date" <%= v.recurrence_frequency === 'monthly_date' ? 'selected' : '' %>>Monthly (by date)</option>
            <option value="monthly_weekday" <%= v.recurrence_frequency === 'monthly_weekday' ? 'selected' : '' %>>Monthly (by weekday)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Repeat every</label>
          <div class="input-group">
            <input type="number" name="recurrence_interval" class="form-control" min="1" value="<%= v.recurrence_interval || 1 %>">
            <span class="input-group-text">interval(s)</span>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">End date</label>
          <input type="date" name="recurrence_end_date" class="form-control" value="<%= v.recurrence_end_date || '' %>">
        </div>
      </div>
      <div class="mt-3">
        <label class="form-label">Weekly pattern</label>
        <div class="d-flex flex-wrap gap-2">
          <% ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(function(day, idx) { %>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="<%= idx %>" id="rec-week-<%= idx %>" <%= selectedWeekdays.includes(String(idx)) ? 'checked' : '' %>>
              <label class="form-check-label" for="rec-week-<%= idx %>"><%= day %></label>
            </div>
          <% }) %>
        </div>
        <small class="text-muted d-block">Only used for weekly/monthly weekday repeats.</small>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <label class="form-label">Monthly day</label>
          <input type="number" name="recurrence_monthly_day" class="form-control" min="1" max="31" value="<%= v.recurrence_monthly_day || '' %>">
          <small class="text-muted">Used for monthly-by-date repeats.</small>
        </div>
        <div class="col-md-6">
          <label class="form-label">Monthly weekday</label>
          <select name="recurrence_monthly_week" class="form-select">
            <option value="">-- choose --</option>
            <option value="1" <%= v.recurrence_monthly_week === '1' ? 'selected' : '' %>>First</option>
            <option value="2" <%= v.recurrence_monthly_week === '2' ? 'selected' : '' %>>Second</option>
            <option value="3" <%= v.recurrence_monthly_week === '3' ? 'selected' : '' %>>Third</option>
            <option value="4" <%= v.recurrence_monthly_week === '4' ? 'selected' : '' %>>Fourth</option>
            <option value="-1" <%= v.recurrence_monthly_week === '-1' || v.recurrence_monthly_week === 'last' ? 'selected' : '' %>>Last</option>
          </select>
          <small class="text-muted">Used with weekly checkboxes.</small>
        </div>
      </div>
      <div class="mt-3">
        <label class="form-label">Skip dates</label>
        <textarea name="recurrence_skip_dates" class="form-control" rows="2" placeholder="Comma or newline separated YYYY-MM-DD dates"><%= v.recurrence_skip_dates || '' %></textarea>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
      <a href="/functions" class="btn btn-outline-secondary">Cancel</a>
      <button type="submit" class="btn btn-primary">Create Function</button>
    </div>
  </form>
</div>
