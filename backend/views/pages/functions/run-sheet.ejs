<% locals.layout = 'layouts/main'; %>
<%
  const eventDateFormatted = eventDate
    ? new Date(eventDate).toLocaleDateString('en-NZ', { day: 'numeric', month: 'long', year: 'numeric' })
    : 'Not set';
  const formatTime = (value) => {
    if (!value) return '--:--';
    const str = String(value);
    if (str.includes('T')) {
      return new Date(str).toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' });
    }
    return str.slice(0, 5);
  };
  const startTimeFormatted = formatTime(startTime);
  const endTimeFormatted = formatTime(endTime);
  const safeNotes = Array.isArray(notes) ? notes : [];
  const safeMenus = Array.isArray(menus) ? menus : [];
%>

<style>
  .run-sheet table {
    font-size: 12.5px;
  }
  .run-sheet table th,
  .run-sheet table td {
    padding-top: 0.35rem;
    padding-bottom: 0.35rem;
  }
  .run-sheet__totals {
    text-align: right;
    margin-left: auto;
    margin-right: 0;
    display: block;
    min-width: 220px;
  }
  @media print {
    .run-sheet table {
      font-size: 12.5px;
    }
    .run-sheet table th,
    .run-sheet table td {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }
    .run-sheet__totals {
      text-align: right;
      margin-left: auto;
      margin-right: 0;
      display: block;
      min-width: 220px;
    }
  }
</style>

<div class="run-sheet container py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
      <p class="text-muted mb-1 text-uppercase small letter-tight">Internal Run Sheet</p>
      <h1 class="mb-0"><%= fn.event_name || 'Function Run Sheet' %></h1>
    </div>
    <div class="run-sheet__actions d-flex gap-2 no-print">
      <a href="/functions/<%= fn.id_uuid %>" class="btn btn-outline-secondary btn-sm">Back to function</a>
      <button class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
    </div>
  </div>

  <section class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="run-sheet-summary">
        <div class="run-sheet-summary__group">
          <p class="text-muted text-uppercase small mb-1">Event Date</p>
          <p class="fw-semibold mb-3"><%= eventDateFormatted %></p>
          <p class="text-muted text-uppercase small mb-1">Start &amp; End Time</p>
          <p class="fw-semibold mb-0"><%= startTimeFormatted %> - <%= endTimeFormatted %></p>
        </div>
        <div class="run-sheet-summary__group">
          <p class="text-muted text-uppercase small mb-1">Room</p>
          <p class="fw-semibold mb-3"><%= roomName || 'Unassigned' %></p>
          <p class="text-muted text-uppercase small mb-1">Guests</p>
          <p class="fw-semibold mb-0"><%= attendees || 0 %></p>
        </div>
      </div>
    </div>
  </section>

  <% if (safeNotes.length) { %>
    <section class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Instructions &amp; Notes</h5>
        <div class="vstack gap-3">
          <% safeNotes.forEach(function(note) { %>
            <article class="run-sheet-note border rounded-3 p-3">
              <div class="run-sheet-note__body">
                <%- note.rendered_html || note.content || '<em>No content</em>' %>
              </div>
            </article>
          <% }) %>
        </div>
      </div>
    </section>
  <% } %>

  <% if (safeMenus.length) { %>
    <section class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Catering / Menus</h5>
          <span class="badge bg-light text-dark"><%= safeMenus.length %> menus</span>
        </div>
        <div class="vstack gap-4">
          <% safeMenus.forEach(function(menu) { %>
            <article class="run-sheet-menu border rounded-3 overflow-hidden">
              <header class="p-3 bg-light border-bottom">
                <div class="d-flex flex-column flex-lg-row justify-content-between gap-2">
                  <div>
                    <p class="mb-0 fw-semibold"><%= menu.name %></p>
                    <small class="text-muted"><%= menu.category || 'Catering' %></small>
                  </div>
                </div>
              </header>
              <div class="table-responsive">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th scope="col" style="min-width: 240px;">Item</th>
                      <th scope="col" style="width: 90px;">Quantity</th>
                      <th scope="col" style="width: 90px;">Unit</th>
                      <% if (typeof includeCosts !== 'undefined' && includeCosts) { %>
                        <th scope="col" style="width: 110px;">Cost</th>
                        <th scope="col" style="width: 110px;">Line Total</th>
                      <% } %>
                    </tr>
                  </thead>
                  <tbody>
                    <% (menu.items || []).forEach(function(item) { %>
                      <tr>
                        <td><%= item.label || 'Item' %></td>
                        <td><%= item.qty || 0 %></td>
                        <td><%= item.unit || '' %></td>
                        <% if (typeof includeCosts !== 'undefined' && includeCosts) { 
                             const qtyVal = (item.qty && !isNaN(Number(item.qty))) ? Number(item.qty) : 0;
                             const unitCost = Number.isFinite(Number(item.cost_each))
                               ? Number(item.cost_each)
                               : (Number.isFinite(Number(item.cost_total || item.cost)) && qtyVal > 0
                                   ? Number(item.cost_total || item.cost) / qtyVal
                                   : 0);
                             const lineCost = Number.isFinite(Number(item.cost_total || item.cost))
                               ? Number(item.cost_total || item.cost)
                               : unitCost * qtyVal;
                        %>
                          <td><%= '$' + unitCost.toFixed(2) %></td>
                          <td><%= '$' + lineCost.toFixed(2) %></td>
                        <% } %>
                      </tr>
                    <% }) %>
                    <% if (!(menu.items || []).length) { %>
                      <tr>
                        <td colspan="<%= (includeCosts ? 5 : 3) %>" class="text-muted text-center">No items recorded for this menu.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </article>
          <% }) %>

          <% 
            let totalPriceAll = 0;
            let totalCostAll = 0;
            safeMenus.forEach(function(menu) {
              (menu.items || []).forEach(function(item) {
                const linePrice = Number(item.price);
                if (!isNaN(linePrice)) totalPriceAll += linePrice;
                if (typeof includeCosts !== 'undefined' && includeCosts) {
                  const lineCost = item.cost_total != null ? Number(item.cost_total) : Number(item.cost);
                  if (!isNaN(lineCost)) totalCostAll += lineCost;
                }
              });
            });
          %>
          <table class="table mb-0 border-0">
            <tbody>
              <tr>
                <td class="border-0"></td>
                <td class="border-0 text-end run-sheet__totals" style="width: 220px;">
                  <div class="fw-semibold mb-1" style="font-size: 13.5px;">Totals</div>
                  <div style="font-size: 12.5px;">
                    <div>Price: $<%= totalPriceAll.toFixed(2) %></div>
                    <% if (typeof includeCosts !== 'undefined' && includeCosts) { %>
                      <div>Cost: $<%= totalCostAll.toFixed(2) %></div>
                    <% } %>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  <% } %>
</div>
