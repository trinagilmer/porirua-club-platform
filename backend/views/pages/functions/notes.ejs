<% locals.layout = 'layouts/main'; %>


    <!-- üîπ Body -->
    <div class="function-body py-4 px-4">

      <!-- ===== NOTES EDITOR TOOLBAR + EDITOR ===== -->
      <style>
        .notes-bar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; margin-bottom:.5rem; }
        .notes-bar .group { display:flex; gap:.25rem; align-items:center; background:var(--surface, #f6f7f9); padding:.4rem .5rem; border-radius:.5rem; }
        .notes-bar .group label { font-size:.85rem; margin-right:.25rem; color:#555; }
        .notes-bar button, .notes-bar select { font-size:.9rem; padding:.35rem .5rem; border:1px solid #d0d7de; background:#fff; border-radius:.4rem; cursor:pointer; }
        .notes-bar button:hover { background:#f1f4f7; }
        .notes-editor-surface { min-height:220px; border:1px solid #d0d7de; border-radius:.5rem; padding:.75rem; background:#fff; }
        .notes-actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem; }
        .token-panel { display:flex; gap:.25rem; flex-wrap:wrap; max-height:120px; overflow:auto; }
        .token-panel .token-btn { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .status-group { display:flex; gap:.5rem; align-items:center; }
        .status-group input { margin-right:.25rem; }
        .preview-wrap { margin-top:1rem; border:1px dashed #d0d7de; border-radius:.5rem; padding:.75rem; background:#fff; }
        .notes-columns { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-top:1rem; }
        .notes-card { background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; }
        .notes-card header { display:flex; justify-content:space-between; align-items:center; padding:.6rem .8rem; border-bottom:1px solid #eef1f4; font-weight:600; }
        .notes-list { padding:.5rem .8rem; display:flex; flex-direction:column; gap:.5rem; }
        .note-item { border:1px solid #eef1f4; border-radius:.4rem; padding:.5rem .6rem; background:#fafbfc; }
        .note-meta { font-size:.8rem; color:#6b7280; display:flex; gap:.5rem; justify-content:space-between; margin-bottom:.25rem; }
        .note-html { font-size:.95rem; }
        .badge { display:inline-block; padding:.1rem .4rem; border-radius:.4rem; font-size:.75rem; }
        .badge-proposal { background:#e0f2fe; color:#075985; }
        .badge-general { background:#ecfccb; color:#365314; }
        .badge-internal { background:#fee2e2; color:#7f1d1d; }
      </style>

      <div class="notes-bar">
        <!-- Templates -->
        <div class="group">
          <label for="templateSelect">Template</label>
          <select id="templateSelect">
            <option value="">‚Äî Select ‚Äî</option>
            <% (templates || []).forEach(t => { %>
              <option value="<%= t.id %>"><%= t.name %></option>
            <% }) %>
          </select>
        </div>

        <!-- Status -->
        <div class="group status-group">
          <label>Status</label>
          <label><input type="radio" name="note_status" value="proposal"> Proposal</label>
          <label><input type="radio" name="note_status" value="general" checked> Calls</label>
          <label><input type="radio" name="note_status" value="internal"> Internal</label>
        </div>

        <!-- Formatting -->
        <div class="group">
          <button type="button" title="Bold" data-cmd="bold"><strong>B</strong></button>
          <button type="button" title="Italic" data-cmd="italic"><em>I</em></button>
          <button type="button" title="Underline" data-cmd="underline"><u>U</u></button>
        </div>

        <div class="group">
          <button type="button" title="Heading 2" data-cmd="formatBlock" data-value="h2">H2</button>
          <button type="button" title="Heading 3" data-cmd="formatBlock" data-value="h3">H3</button>
          <button type="button" title="Paragraph" data-cmd="formatBlock" data-value="p">P</button>
        </div>

        <div class="group">
          <button type="button" title="Bulleted list" data-cmd="insertUnorderedList">‚Ä¢ List</button>
          <button type="button" title="Numbered list" data-cmd="insertOrderedList">1. List</button>
          <button type="button" title="Blockquote" data-cmd="formatBlock" data-value="blockquote">‚ùù Quote</button>
        </div>

        <div class="group">
          <button type="button" title="Align left" data-cmd="justifyLeft">‚ü∏</button>
          <button type="button" title="Align center" data-cmd="justifyCenter">‚Üî</button>
          <button type="button" title="Align right" data-cmd="justifyRight">‚üπ</button>
        </div>

        <div class="group">
          <button type="button" title="Insert link" data-action="link">üîó Link</button>
          <button type="button" title="Remove link" data-cmd="unlink">‚õìÔ∏è‚Äç‚úÇÔ∏è Unlink</button>
          <button type="button" title="Undo" data-cmd="undo">‚Ü∂</button>
          <button type="button" title="Redo" data-cmd="redo">‚Ü∑</button>
          <button type="button" title="Clear formatting" data-cmd="removeFormat">üßπ</button>
        </div>

        <!-- Tables -->
        <div class="group">
          <label>Table</label>
          <button type="button" data-insert-table data-rows="2" data-cols="2">2√ó2</button>
          <button type="button" data-insert-table data-rows="3" data-cols="3">3√ó3</button>
        </div>
      </div>

      <!-- Token palette -->
      <div class="group" style="margin-bottom:.5rem;">
        <details>
          <summary style="cursor:pointer;">Merge fields (click to insert)</summary>
          <div class="token-panel" style="margin-top:.5rem;">
            <% (mergeFields || []).forEach(f => { %>
              <button type="button" class="token-btn" data-key="<%- f.key %>" title="<%- f.description || '' %>">
                {{<%- f.key %>}}
              </button>
            <% }) %>
          </div>
        </details>
      </div>

      <!-- Editor surface -->
      <div id="noteEditor" class="notes-editor-surface" contenteditable="true" spellcheck="true"></div>

      <!-- Actions -->
      <div class="notes-actions">
        <button type="button" id="previewNote">Preview</button>
        <button type="button" id="saveNote">Save</button>
      </div>

      <!-- Preview pane -->
      <div id="previewPane" class="preview-wrap"></div>

      <!-- Tiny helper for Link (prompts for URL) -->
      <script>
        (function () {
          const editorEl = document.getElementById('noteEditor');
          const linkBtn = document.querySelector('[data-action="link"]');
          if (!editorEl || !linkBtn) return;

          linkBtn.addEventListener('click', () => {
            const url = window.prompt('Enter URL (including https://)');
            if (!url) return;
            document.execCommand('createLink', false, url);
            editorEl.focus();
          });
        })();
      </script>

      <!-- ===== RENDERED NOTES: Proposal / General / Internal ===== -->
      <%
        const notesArr = notes || [];
        const byStatus = { proposal: [], general: [], internal: [] };
        notesArr.forEach(n => {
          const s = (n.note_type || 'general').toLowerCase();
          if (byStatus[s]) byStatus[s].push(n); else byStatus.general.push(n);
        });

        function fmtDate(d) {
          try { return new Date(d).toLocaleString('en-NZ', { hour12: true }); } catch { return ''; }
        }
      %>

      <div class="notes-columns">
        <!-- Proposal -->
        <div class="notes-card">
          <header>
            <span>Proposal</span>
            <span class="badge badge-proposal"><%= byStatus.proposal.length %></span>
          </header>
          <div class="notes-list">
            <% if (!byStatus.proposal.length) { %>
              <div class="note-item"><em>No proposal notes yet.</em></div>
            <% } %>
            <% byStatus.proposal.forEach(n => { %>
              <article class="note-item" data-note-id="<%= n.id %>">
                <div class="note-meta">
                  <span><%= n.author_name || 'Unknown' %></span>
                  <span><%= fmtDate(n.updated_at || n.created_at) %></span>
                </div>
                <div class="note-html"><%- n.rendered_html || n.content || '' %></div>
              </article>
            <% }) %>
          </div>
        </div>

        <!-- Calls -->
        <div class="notes-card">
          <header>
            <span>Calls</span>
            <span class="badge badge-general"><%= byStatus.general.length %></span>
          </header>
          <div class="notes-list">
            <% if (!byStatus.general.length) { %>
              <div class="note-item"><em>No call notes yet.</em></div>
            <% } %>
            <% byStatus.general.forEach(n => { %>
              <article class="note-item" data-note-id="<%= n.id %>">
                <div class="note-meta">
                  <span><%= n.author_name || 'Unknown' %></span>
                  <span><%= fmtDate(n.updated_at || n.created_at) %></span>
                </div>
                <div class="note-html"><%- n.rendered_html || n.content || '' %></div>
              </article>
            <% }) %>
          </div>
        </div>

        <!-- Internal -->
        <div class="notes-card">
          <header>
            <span>Internal</span>
            <span class="badge badge-internal"><%= byStatus.internal.length %></span>
          </header>
          <div class="notes-list">
            <% if (!byStatus.internal.length) { %>
              <div class="note-item"><em>No internal notes yet.</em></div>
            <% } %>
            <% byStatus.internal.forEach(n => { %>
              <article class="note-item" data-note-id="<%= n.id %>">
                <div class="note-meta">
                  <span><%= n.author_name || 'Unknown' %></span>
                  <span><%= fmtDate(n.updated_at || n.created_at) %></span>
                </div>
                <div class="note-html"><%- n.rendered_html || n.content || '' %></div>
              </article>
            <% }) %>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<!-- üß± GLOBAL FUNCTION MODALS (if you include them site-wide) -->
<%- include('../../partials/functions/modals') %>

<!-- Context for editor JS -->
<script>
  (function () {
    // Safely JSON-encode raw data from EJS
    const fnId       = <%- JSON.stringify(fn.id_uuid) %>;
    const eventName  = <%- JSON.stringify(fn.event_name || "") %>;
    const eventDate  = <%- JSON.stringify(fn.event_date || "") %>;
    const startTime  = <%- JSON.stringify(fn.start_time || "") %>;
    const endTime    = <%- JSON.stringify(fn.end_time || "") %>;

    const contacts   = <%- JSON.stringify(linkedContacts || []) %>;
    const rooms      = <%- JSON.stringify(rooms || []) %>;
    const roomId     = <%- JSON.stringify(fn.room_id || null) %>;

    const templates  = <%- JSON.stringify(templates || []) %>;
    const mergeFields= <%- JSON.stringify(mergeFields || []) %>;

    const contact    = contacts[0] || {};
    const room       = rooms.find(r => r.id === roomId) || {};

    window.fnContext = {
      id: fnId,
      event: {
        name: eventName,
        date: eventDate,
        start_time: startTime,
        end_time: endTime,
      },
      contact,
      room,
      templates,
      mergeFields,
    };
  })();
</script>

<script src="/js/functions/notes-editor.js" defer></script>
<script src="/js/functions/notes-delete.js" defer></script>
