<% locals.layout = 'layouts/main'; %>

<%
  const clientModeFlag =
    typeof locals.clientMode !== 'undefined'
      ? locals.clientMode
      : typeof clientMode !== 'undefined'
      ? clientMode
      : false;

  const formatFriendlyDate = (value) => {
    if (!value) return '';
    try {
      return new Date(value).toLocaleDateString('en-NZ', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
      });
    } catch (err) {
      return '';
    }
  };

  const acceptedDateDisplay = formatFriendlyDate(typeof acceptedDisplayDate !== 'undefined' ? acceptedDisplayDate : null);

  const successMessage =
    typeof locals.successMessage !== 'undefined'
      ? locals.successMessage
      : null;

  const errorMessage =
    typeof locals.errorMessage !== 'undefined'
      ? locals.errorMessage
      : null;
  const formatPlain = (value) => {
    return String(value || '')
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/(p|div|li|h[1-6])>/gi, '\n')
      .replace(/<[^>]+>/g, '')
      .replace(/\r/g, '')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  };
  const formatTime = (value) => {
    if (!value) return null;
    const str = String(value);
    return str.length >= 5 ? str.slice(0, 5) : str;
  };
  const startTime = formatTime(fn?.start_time);
  const endTime = formatTime(fn?.end_time);
  const contactList = Array.isArray(contacts) ? contacts : [];
  const resolveContactId = (contact) =>
    contact?.id ?? contact?.contact_id ?? contact?.id_uuid ?? null;
  const selectedContactIds = Array.isArray(saved?.includeContactIds)
    ? saved.includeContactIds.map((id) => String(id))
    : [];
  let orderedContacts = [];
  if (selectedContactIds.length) {
    const orderMap = new Map(
      selectedContactIds.map((id, index) => [String(id), index])
    );
    orderedContacts = contactList
      .filter((contact) => {
        const contactId = resolveContactId(contact);
        return orderMap.has(String(contactId));
      })
      .sort((a, b) => {
        const aIdx = orderMap.get(String(resolveContactId(a)));
        const bIdx = orderMap.get(String(resolveContactId(b)));
        return aIdx - bIdx;
      });
  } else if (contactList.length) {
    orderedContacts = [...contactList].sort((a, b) => {
      const primDelta =
        Number(Boolean(b?.is_primary)) - Number(Boolean(a?.is_primary));
      if (primDelta !== 0) return primDelta;
      return (a?.name || "").localeCompare(b?.name || "");
    });
  }
  const primaryContact =
    orderedContacts[0] ||
    contactList.find((c) => c.is_primary) ||
    contactList[0] ||
    null;
  const printedDate = new Date().toLocaleDateString('en-NZ', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
  const eventDate = fn?.event_date
    ? new Date(fn.event_date).toLocaleDateString('en-NZ', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
      })
    : 'TBC';
  const safeTotals = totals || {
    subtotal: 0,
    gratuity_percent: 0,
    gratuity_amount: 0,
    discount_amount: 0,
    deposit_amount: 0,
    total_paid: 0,
    remaining_due: 0,
  };
  const subtotal = Number(safeTotals.subtotal || 0);
  const discountAmount = Number(safeTotals.discount_amount || 0);
  const totalPaid = Number(safeTotals.total_paid || 0);
  const paymentRows = Array.isArray(payments) ? payments : [];
  const totalPayments = totalPaid + (discountAmount > 0 ? discountAmount : 0);
  const remainingDue = subtotal - totalPayments;
  const totalExGst = subtotal / 1.15;
  const gstPortion = subtotal - totalExGst;
  const currency = (val) => {
    const amount = Number(val) || 0;
    const sign = amount < 0 ? "-" : "";
    return `${sign}$${Math.abs(amount).toFixed(2)}`;
  };
  const baseDiscount = Number(totals?.discount_amount || 0);
  const baseTotalPaid = Number(totals?.total_paid || 0);
%>

<style>
  .proposal-items-table td,
  .proposal-items-table th {
    font-size: 0.95rem;
    padding: 0.4rem 0.5rem;
  }
  .proposal-menu-row {
    font-weight: 700;
    border-top: 2px solid #c2ccd6;
    border-bottom: 2px solid #c2ccd6;
  }
  .proposal-choice-row td:first-child {
    padding-left: 1.75rem;
  }
</style>

<div class="proposal-print container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <div>
      <% if (clientModeFlag) { %>
        <div class="badge bg-primary-subtle text-primary">Client view</div>
        <% if (typeof itemsFallbackNote !== 'undefined' && itemsFallbackNote) { %>
          <div class="text-muted small"><%= itemsFallbackNote %></div>
        <% } %>
      <% } %>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" type="button" onclick="window.print()">
        <i class="bi bi-printer me-1"></i> Print / Save as PDF
      </button>
    </div>
  </div>
  <header class="proposal-header card shadow-sm mb-4">
    <div class="proposal-header__logo proposal-header__logo--pc">
      <img src="/img/Pclogotext.png" alt="Porirua Club" class="proposal-logo proposal-logo--primary">
    </div>
    <div class="proposal-header__meta">
      <div class="proposal-header__date"><%= eventDate %></div>
      <div class="proposal-header__title"><strong><%= fn.event_name || 'Function Proposal' %></strong></div>
      <div class="proposal-header__contact">
        <div class="text-muted text-uppercase small letter-tight">Attention</div>
        <% if (primaryContact) { %>
          <strong><%= primaryContact.name %></strong>
          <% if (primaryContact.email) { %><span><%= primaryContact.email %></span><% } %>
          <% if (primaryContact.phone) { %><span><%= primaryContact.phone %></span><% } %>
        <% } else { %>
          <span class="text-muted">No contact selected</span>
        <% } %>
      </div>
      <div class="proposal-header__issued text-uppercase small text-muted">
        Prepared <%= printedDate %>
      </div>
    </div>
    <div class="proposal-header__logo proposal-header__logo--eastwood">
      <img src="/img/EASTWOOD-LOGO-small.png" alt="Eastwood" class="proposal-logo proposal-logo--secondary">
    </div>
  </header>

  <% if (clientModeFlag) { %>
    <div id="clientFormAlert" class="alert alert-warning d-none" role="alert">
      Please enter your name and agree to the Terms &amp; Conditions before confirming.
    </div>
  <% } %>

  <% if (clientModeFlag) { %>
    <form id="clientProposalForm" method="POST" action="/functions/proposal/client/<%= encodeURIComponent(proposal?.client_token || '') %>/accept" class="mb-4">
  <% } else { %>
    <form class="mb-4">
  <% } %>
    <% const hasContacts = (orderedContacts || []).length > 0; %>
    <div class="row g-3">
      <div class="<%= hasContacts ? 'col-lg-6' : 'col-12' %>">
        <div class="proposal-summary-card card shadow-sm h-100 <%= hasContacts ? '' : 'proposal-summary-card--single' %>">
          <div class="card-body">
            <h5 class="proposal-summary__title">Function Details</h5>
            <dl class="proposal-summary__list">
              <div>
                <dt>Event Date</dt>
                <dd><%= eventDate %></dd>
              </div>
              <div>
                <dt>Attendees</dt>
                <dd><%= fn.attendees || 0 %></dd>
              </div>
              <div>
                <dt>Start / Finish</dt>
                <dd><%= startTime || '--:--' %> - <%= endTime || '--:--' %></dd>
              </div>
              <% if (fn.room_name) { %>
                <div>
                  <dt>Room</dt>
                  <dd><%= fn.room_name %></dd>
                </div>
              <% } %>
              <% if (fn.status) { %>
                <div>
                  <dt>Status</dt>
                  <dd><%= fn.status %></dd>
                </div>
              <% } %>
            </dl>
          </div>
        </div>
      </div>
      <% if (hasContacts) { %>
        <div class="col-lg-6">
          <div class="proposal-summary-card card shadow-sm h-100">
            <div class="card-body">
              <h5 class="proposal-summary__title">Contacts</h5>
              <ul class="proposal-contact-list">
                <% orderedContacts.forEach((contact) => { %>
                  <li>
                    <strong><%= contact.name %></strong>
                    <% if (contact.is_primary) { %>
                      <span class="badge bg-secondary ms-2 text-uppercase">Primary</span>
                    <% } %>
                    <br>
                    <span><%= contact.email || 'No email' %></span>
                    <% if (contact.phone) { %><span><%= contact.phone %></span><% } %>
                  </li>
                <% }) %>
              </ul>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  <% if (clientModeFlag) { %>
    <div id="clientFormAlert" class="alert alert-warning d-none" role="alert">
      Please enter your name and agree to the Terms &amp; Conditions before confirming.
    </div>
  <% } %>

  <section id="proposalItemsSection" class="proposal-table-card proposal-section proposal-content-rail">
    <h5 class="proposal-category__title">Proposal Items</h5>
    <div id="proposalPricingAll"></div>
  </section>

  <section class="proposal-run-sheet proposal-flat proposal-content-rail">
    <h5 class="proposal-run-sheet__title">Function Information</h5>
    <% if ((sections || []).length) { %>
      <div class="proposal-run-sheet__notes vstack gap-3">
        <% sections.forEach((section) => { %>
          <div class="proposal-run-sheet__entry">
            <%
              const sectionBody = section?.content || '';
              const hasMarkup = /<[a-z][\s\S]*>/i.test(sectionBody);
              const renderedSection = hasMarkup ? sectionBody : formatPlain(sectionBody).replace(/\n/g, '<br>');
            %>
            <div class="proposal-section-text"><%- renderedSection %></div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="text-muted small">No function notes selected for this proposal.</div>
    <% } %>
  </section>

  <section id="proposalCateringSection" class="proposal-table-card proposal-section proposal-catering-card proposal-content-rail d-none">
    <h5 class="proposal-category__title">Catering</h5>
    <div id="proposalPricingCatering"></div>
  </section>

  <section id="proposalOtherSection" class="proposal-table-card proposal-section proposal-content-rail d-none">
    <h5 class="proposal-category__title">Additional Items</h5>
    <div id="proposalPricingOther"></div>
  </section>

  <section class="proposal-financial proposal-flat proposal-content-rail">
    <h5 class="proposal-financial__title">Financial Summary</h5>
    <table class="proposal-table__grid proposal-financial__table">
      <tbody>
        <tr>
          <td>Total excl. GST</td>
          <td class="text-end" id="fs-total-ex"><%= currency(totalExGst) %></td>
        </tr>
        <tr>
          <td>GST (15%)</td>
          <td class="text-end" id="fs-gst"><%= currency(gstPortion) %></td>
        </tr>
        <tr class="proposal-financial__highlight">
          <td>Total incl. GST</td>
          <td class="text-end" id="fs-total-inc"><%= currency(subtotal) %></td>
        </tr>
        <% if (paymentRows.length) { %>
          <% paymentRows.forEach((payment) => { %>
            <tr>
              <td>Payment: <%= payment.payment_type || 'Payment' %><% if (payment.paid_on) { %> <span class="text-muted">(<%= new Date(payment.paid_on).toLocaleDateString('en-NZ') %>)</span><% } %></td>
              <td class="text-end"><%= currency(payment.amount) %></td>
            </tr>
          <% }) %>
        <% } %>
        <% if (discountAmount > 0) { %>
          <tr>
            <td>Discount</td>
            <td class="text-end" id="fs-discount"><%= currency(-discountAmount) %></td>
          </tr>
        <% } %>
        <% if (!paymentRows.length && discountAmount <= 0) { %>
          <tr>
            <td>Payments</td>
            <td class="text-end"><%= currency(0) %></td>
          </tr>
        <% } %>
        <tr>
          <td>Total payments</td>
          <td class="text-end" id="fs-total-payments"><%= currency(totalPayments) %></td>
        </tr>
        <tr class="proposal-financial__total-due">
          <td>Total to pay</td>
          <td class="text-end" id="fs-total-due"><%= currency(remainingDue) %></td>
        </tr>
      </tbody>
    </table>
  </section>

  <% if (successMessage && clientModeFlag) { %>
    <div class="alert alert-success mb-3">
      <%= successMessage %>
      <div class="mt-1">
        <a href="/functions/proposal/client/<%= proposal?.client_token %>" target="_blank" rel="noopener">View/print your submitted proposal</a>
      </div>
    </div>
  <% } %>

  <% if (terms && !successMessage) { %>
    <% if (clientModeFlag) { %>
      <div class="mb-3">
        <div class="alert alert-info mb-2">
          Please review the Terms &amp; Conditions below, enter your name, and tick agreement before submitting.
        </div>
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-6">
            <label class="form-label">Your name</label>
            <input type="text" class="form-control" name="client_name" form="clientProposalForm" value="<%= proposal?.client_accepted_by || '' %>" required>
          </div>
          <div class="col-md-6 d-flex flex-column flex-sm-row gap-2 align-items-sm-center">
            <div class="form-check mb-0">
              <input class="form-check-input" type="checkbox" value="yes" id="acceptTerms" name="accept_terms" form="clientProposalForm" <%= (proposal?.client_status || '').startsWith('accepted') ? 'checked' : '' %> required>
              <label class="form-check-label" for="acceptTerms">
                I agree to the Terms &amp; Conditions.
              </label>
            </div>
            <div class="ms-sm-auto">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary" type="button" id="refreshClientTotalsTerms">
                  <i class="bi bi-arrow-repeat"></i> Refresh totals
                </button>
                <button class="btn btn-primary" type="submit" name="action" value="pending">Confirm</button>
                <button class="btn btn-success" type="submit" name="action" value="final">Confirm with selections</button>
              </div>
            </div>
          </div>
        </div>
        <% if (acceptedDateDisplay) { %>
          <div class="text-muted small mt-1">Agreement date: <%= acceptedDateDisplay %></div>
        <% } %>
      </div>
    <% } %>
    <section class="proposal-terms card shadow-sm page-break" id="termsSection">
      <div class="card-header bg-light fw-semibold">Terms &amp; Conditions</div>
      <div class="card-body proposal-terms__body small">
        <%- terms %>
      </div>
    </section>
  <% } %>
</form>
</div>

<ul id="previewItemsSource" class="d-none">
  <% (items || []).forEach(item => { %>
    <li data-id="<%= item.id %>" data-price="<%= Number(item.unit_price || 0).toFixed(2) %>" data-selectable="<%= item.client_selectable ? 'true' : 'false' %>">
      <%- String(item.description || '').replace(/\r\n|\r|\n/g, ' ') %>
    </li>
  <% }) %>
</ul>

<script>
  const clientModeFlag = <%= clientModeFlag ? 'true' : 'false' %>;
  window.previewContext = {
    proposalId: <%= proposalId ? Number(proposalId) : 'null' %>
  };
  const menuMetaLookup = <%- JSON.stringify(menuMetaLookup || {}) %>;
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const source = document.getElementById('previewItemsSource');
    const itemsMount = document.getElementById('proposalPricingAll');
    const itemsSection = document.getElementById('proposalItemsSection');
    const itemsTable = document.querySelector('.proposal-items-table');
    const termsSection = document.getElementById('termsSection') || document.querySelector('.proposal-terms');
    if (!source) return;

    const parseMeta = (text) => {
      const meta = {};
      let match;
      const regex = /\[([a-z_]+):([^\]]+)\]/gi;
      while ((match = regex.exec(text))) meta[match[1].toLowerCase()] = match[2];
      const qtyMatch = text.match(/ x (\d+)/i);
      if (qtyMatch) meta.qty = Number(qtyMatch[1]);
      if (/\[excluded:true\]/i.test(text)) meta.excluded = true;
      return meta;
    };

    const cleanLabel = (text) => text.replace(/\[[^\]]+\]/g, '').replace(/\s{2,}/g, ' ').trim();
    const isChild = (text) => /^\s*(Choice:|Add-on:)/i.test(text);
    const formatCurrency = (value) => {
      const amount = Number(value) || 0;
      const sign = amount < 0 ? "-" : "";
      return `${sign}$${Math.abs(amount).toFixed(2)}`;
    };

    function buildModel() {
      const categories = new Map();
      const menuIndex = new Map();
      let currentMenu = null;

      source.querySelectorAll('li').forEach((li) => {
        const id = Number(li.dataset.id);
        const rawText = (li.textContent || '').trim();
        const meta = parseMeta(rawText);
        const price = Number(li.dataset.price || 0);
        const selectable = String(li.dataset.selectable || '').toLowerCase() === 'true';
        const text = cleanLabel(rawText);
        const isAddon = /^\s*Add-on:/i.test(rawText);
        const menuId = meta.menu_id ? Number(meta.menu_id) : null;
        const menuMeta = menuId ? menuMetaLookup[menuId] || null : null;

        if (!isChild(text)) {
          const categoryName = meta.category || menuMeta?.category || 'Uncategorised';
          if (!categories.has(categoryName)) categories.set(categoryName, []);
          currentMenu = {
            menuId,
            title: text.replace(/^Menu:\s*/i, '').trim(),
            basePrice: price,
            baseQty: meta.qty ? Number(meta.qty) : 1,
            baseExcluded: false,
            clientSelectable: selectable,
            items: [],
          };
          if (menuId) menuIndex.set(menuId, currentMenu);
          categories.get(categoryName).push(currentMenu);
          return;
        }

        if (!currentMenu || (menuId && currentMenu.menuId && currentMenu.menuId !== menuId)) {
          const categoryName = meta.category || menuMeta?.category || 'Uncategorised';
          if (!categories.has(categoryName)) categories.set(categoryName, []);
          currentMenu =
            (menuId && menuIndex.get(menuId)) ||
            {
              menuId,
              title: menuMeta?.name || 'Menu',
              basePrice: 0,
              baseQty: 1,
              baseExcluded: true,
              clientSelectable: selectable,
              items: [],
            };
          if (menuId && !menuIndex.has(menuId)) menuIndex.set(menuId, currentMenu);
          if (!categories.get(categoryName).includes(currentMenu)) {
            categories.get(categoryName).push(currentMenu);
          }
        }
        const unitType = String(meta.unit_type || '').toLowerCase();
        const isPerPerson =
          unitType === 'per_person' ||
          unitType === 'per-person' ||
          unitType === 'per person' ||
          unitType === 'pp';
        const qty = meta.qty
          ? Number(meta.qty)
          : isPerPerson
          ? Number(window.fnContext?.attendees || 0) || 1
          : 1;
        let priceEach;
        if (meta.base != null) {
          priceEach = Number(meta.base);
        } else if (isPerPerson && qty > 0) {
          priceEach = price < qty ? price : price / qty;
        } else {
          priceEach = qty > 0 ? price / qty : price;
        }
        const item = {
          id,
          name: text.replace(/^(Choice:|Add-on:)\s*/i, '').replace(/\s+x\s+\d+.*/, '').trim(),
          price,
          priceEach,
          qty,
          isAddon,
          selectable,
          excluded: meta.excluded || false,
          menuId,
        };
        currentMenu.items.push(item);
        if (selectable) currentMenu.clientSelectable = true;
      });

      return categories;
    }

    function renderGroup(entries, mount, section) {
      if (!mount || !section) return;
      mount.innerHTML = '';
      if (!entries.length) {
        section.classList.add('d-none');
        return;
      }
      section.classList.remove('d-none');

      entries.forEach(([categoryName, menus]) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'proposal-category';
        if (categoryName) {
          wrapper.innerHTML = `<h5 class="proposal-category__title">${categoryName}</h5>`;
        }

        const table = document.createElement('table');
        table.className = 'proposal-table__grid';
        table.innerHTML = `
          <thead>
            <tr>
              <th class="proposal-cell--item">Item</th>
              <th class="proposal-cell--qty">Qty</th>
              <th class="proposal-cell--price">Price Each</th>
              <th class="proposal-cell--total">Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        menus.forEach((menu) => {
          const menuRow = document.createElement('tr');
          menuRow.className = 'proposal-table__menu';
          menuRow.innerHTML = `
            <td colspan="4">${menu.title || 'Menu'}</td>
          `;
          tbody.appendChild(menuRow);

          if (!menu.baseExcluded) {
            const baseLabel = menu.title || 'Package';
            const baseQty = menu.baseQty || 1;
            const baseRow = document.createElement('tr');
            baseRow.innerHTML = `
              <td class="proposal-cell proposal-cell--item">${baseLabel}</td>
              <td class="proposal-cell proposal-cell--qty">${baseQty}</td>
              <td class="proposal-cell proposal-cell--price">${formatCurrency(menu.basePrice)}</td>
              <td class="proposal-cell proposal-cell--total" data-base="${menu.basePrice || 0}" data-qty="${baseQty}">
                ${formatCurrency((menu.basePrice || 0) * baseQty)}
              </td>
            `;
            tbody.appendChild(baseRow);
          }

          const extractMeta = (desc) => {
            const meta = {};
            const re = /\[([a-z_]+):([^\]]+)\]/gi;
            let m;
            while ((m = re.exec(desc || ""))) {
              meta[m[1].toLowerCase()] = m[2];
            }
            return meta;
          };

          menu.items.forEach((item) => {
            const meta = extractMeta(item.description || "");
            const excluded = String(meta.excluded || item.excluded || "").toLowerCase() === "true";
            if (excluded) return; // hide excluded items
            const qtyVal = Number(meta.qty || item.qty || 1) || 1;

            const row = document.createElement('tr');
            const label = item.isAddon ? `${item.name} (Add-on)` : item.name;
            const includeControl =
              clientModeFlag && item.selectable
                ? `<input type="checkbox" class="form-check-input client-include" name="item_${item.id}_include" ${
                    excluded ? "" : "checked"
                  }>`
                : '';
            const priceEach = formatCurrency(item.priceEach);
            const priceTotal = formatCurrency(item.priceEach * qtyVal);
            row.innerHTML = `
              <td class="proposal-cell proposal-cell--item d-flex align-items-center gap-2">
                ${includeControl}
                <span>${label}</span>
              </td>
              <td class="proposal-cell proposal-cell--qty">${qtyVal}</td>
              <td class="proposal-cell proposal-cell--price">${priceEach}</td>
              <td class="proposal-cell proposal-cell--total" data-base="${item.priceEach}" data-qty="${qtyVal}">${priceTotal}</td>
            `;
            tbody.appendChild(row);
          });
        });

        wrapper.appendChild(table);
        mount.appendChild(wrapper);
      });
    }

    function render() {
      const categories = buildModel();
      const entries = Array.from(categories.entries());

      // Fallback: if no categories were built but we have items, render a flat list
      if (!entries.length) {
        if (!itemsSection || !itemsMount) return;
        const table = document.createElement('table');
        table.className = 'proposal-table__grid';
        table.innerHTML = `
          <thead>
            <tr>
              <th class="proposal-cell--item">Item</th>
              <th class="proposal-cell--qty">Qty</th>
              <th class="proposal-cell--price">Price Each</th>
              <th class="proposal-cell--total">Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        source.querySelectorAll('li').forEach((li) => {
          const price = Number(li.dataset.price || 0);
          const qty = 1;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="proposal-cell proposal-cell--item">${cleanLabel(li.textContent || '')}</td>
            <td class="proposal-cell proposal-cell--qty">${qty}</td>
            <td class="proposal-cell proposal-cell--price">${formatCurrency(price)}</td>
            <td class="proposal-cell proposal-cell--total" data-base="${price}" data-qty="${qty}">${formatCurrency(price)}</td>
          `;
          tbody.appendChild(row);
        });
        itemsMount.innerHTML = '';
        itemsMount.appendChild(table);
        itemsSection.classList.remove('d-none');
        return;
      }

      renderGroup(entries, itemsMount, itemsSection);
    }

    render();

    if (clientModeFlag) {
      const form = document.getElementById('clientProposalForm');
      const refreshBtn = document.getElementById('refreshClientTotals');
      const refreshBtnTerms = document.getElementById('refreshClientTotalsTerms');
      const clientAlert = document.getElementById('clientFormAlert');
      const updateTotals = () => {
        let subtotal = 0;
        document.querySelectorAll('.proposal-cell--total').forEach((cell) => {
          const row = cell.closest('tr');
          const include = row.querySelector('.client-include');
          if (include && !include.checked) return;
          const base = Number(cell.dataset.base || 0);
          let qty = Number(cell.dataset.qty || 1);
          if (!Number.isFinite(qty) || qty <= 0) qty = 1;
          subtotal += base * qty;
          cell.textContent = formatCurrency(base * qty);
        });
        const discount = Number(<%- baseDiscount.toFixed(2) %>);
        const totalPaid = Number(<%- baseTotalPaid.toFixed(2) %>);
        const totalPayments = totalPaid + (discount > 0 ? discount : 0);
        const remaining = subtotal - totalPayments;
        const totalEx = subtotal / 1.15;
        const gst = subtotal - totalEx;
        const upd = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        };
        upd('fs-total-ex', formatCurrency(totalEx));
        upd('fs-gst', formatCurrency(gst));
        upd('fs-total-inc', formatCurrency(subtotal));
        if (discount > 0) upd('fs-discount', formatCurrency(-discount));
        upd('fs-total-payments', formatCurrency(totalPayments));
        upd('fs-total-due', formatCurrency(remaining));
      };
      const handle = (e) => {
        if (e.target.classList.contains('client-include')) {
          updateTotals();
        }
      };
      form?.addEventListener('input', handle);
      form?.addEventListener('change', handle);
      itemsTable?.addEventListener('input', handle);
      itemsTable?.addEventListener('change', handle);
      refreshBtn?.addEventListener('click', updateTotals);
      refreshBtnTerms?.addEventListener('click', updateTotals);
      updateTotals();
    }
  });
</script>
