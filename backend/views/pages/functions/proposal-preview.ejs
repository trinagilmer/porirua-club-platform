
<% locals.layout = 'layouts/main'; %>

<%
  const formatPlain = (value) => {
    return String(value || '')
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/(p|div|li|h[1-6])>/gi, '\n')
      .replace(/<[^>]+>/g, '')
      .replace(/\r/g, '')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  };
  const formatTime = (value) => {
    if (!value) return null;
    const str = String(value);
    return str.length >= 5 ? str.slice(0, 5) : str;
  };
  const startTime = formatTime(fn?.start_time);
  const endTime = formatTime(fn?.end_time);
%>

<div class="proposal-preview container py-4">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1">Proposal Preview</h1>
      <div class="text-muted small">Prepared for <strong><%= fn.event_name %></strong>.</div>
    </div>
    <div class="btn-toolbar gap-2">
      <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="bi bi-printer me-1"></i> Print / PDF
      </button>
    </div>
  </div>

  <section class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5 class="mb-1 fw-semibold">Function Information</h5>
          <div class="text-muted small">Reference: <%= fn.id_uuid %></div>
          <dl class="row mt-3 mb-0 small">
            <dt class="col-5">Event Name</dt>
            <dd class="col-7 text-end text-md-start"><%= fn.event_name %></dd>
            <dt class="col-5">Event Date</dt>
            <dd class="col-7 text-end text-md-start"><%= fn.event_date ? new Date(fn.event_date).toLocaleDateString() : 'TBC' %></dd>
            <% if (fn.status) { %>
              <dt class="col-5">Status</dt>
              <dd class="col-7 text-end text-md-start"><%= fn.status %></dd>
            <% } %>
            <dt class="col-5">Attendees</dt>
            <dd class="col-7 text-end text-md-start"><%= fn.attendees || 0 %></dd>
            <dt class="col-5">Start Time</dt>
            <dd class="col-7 text-end text-md-start"><%= startTime || '--:--' %></dd>
            <dt class="col-5">Finish Time</dt>
            <dd class="col-7 text-end text-md-start"><%= endTime || '--:--' %></dd>
            <% if (fn.room_name) { %>
              <dt class="col-5">Room</dt>
              <dd class="col-7 text-end text-md-start"><%= fn.room_name %></dd>
            <% } %>
          </dl>
        </div>
        <% if ((contacts || []).length) { %>
        <div class="col-md-6 mt-4 mt-md-0">
            <h5 class="mb-1 fw-semibold">Contacts</h5>
            <ul class="list-unstyled small mb-0 mt-3">
              <% contacts.forEach(contact => { %>
                <li class="mb-2">
                  <strong><%= contact.name %></strong><br>
                  <span class="text-muted"><%= contact.email || 'no email' %><%= contact.phone ? ' â€¢ ' + contact.phone : '' %></span>
                </li>
              <% }) %>
            </ul>
        </div>
        <% } %>
      </div>
    </div>
  </section>

  <% if ((items || []).length) { %>
    <section class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Menus &amp; Pricing</div>
      <div class="card-body">
        <div id="previewMenuMount" class="d-flex flex-column gap-3"></div>
      </div>
    </section>
  <% } %>

  <% if (totals) { %>
    <section class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Financial Summary</div>
      <div class="card-body small">
        <dl class="row mb-0">
          <dt class="col-sm-6">Subtotal</dt>
          <dd class="col-sm-6 text-end text-sm-start">$<%= Number(totals.subtotal || 0).toFixed(2) %></dd>
          <% if (Number(totals.gratuity_amount || 0) > 0) { %>
            <dt class="col-sm-6">Gratuity (<%= Number(totals.gratuity_percent || 0).toFixed(2) %>%)</dt>
            <dd class="col-sm-6 text-end text-sm-start">$<%= Number(totals.gratuity_amount || 0).toFixed(2) %></dd>
          <% } %>
          <% if (Number(totals.discount_amount || 0) > 0) { %>
            <dt class="col-sm-6">Discount</dt>
            <dd class="col-sm-6 text-end text-sm-start">$<%= Number(totals.discount_amount || 0).toFixed(2) %></dd>
          <% } %>
          <dt class="col-sm-6">Deposit</dt>
          <dd class="col-sm-6 text-end text-sm-start">$<%= Number(totals.deposit_amount || 0).toFixed(2) %></dd>
          <dt class="col-sm-6">Total Paid</dt>
          <dd class="col-sm-6 text-end text-sm-start">$<%= Number(totals.total_paid || 0).toFixed(2) %></dd>
          <dt class="col-sm-6 fw-semibold">Remaining Due</dt>
          <dd class="col-sm-6 text-end text-sm-start fw-semibold">$<%= Number(totals.remaining_due || 0).toFixed(2) %></dd>
        </dl>
      </div>
    </section>
  <% } %>

  <% if ((sections || []).length) { %>
    <section class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">Additional Notes</div>
      <div class="card-body vstack gap-3">
        <% sections.forEach((section, idx) => { %>
          <div>
            <div class="fw-semibold mb-1">Section <%= idx + 1 %></div>
            <% 
              const sectionBody = section?.content || '';
              const hasMarkup = /<[a-z][\s\S]*>/i.test(sectionBody);
              const renderedSection = hasMarkup ? sectionBody : formatPlain(sectionBody).replace(/\n/g, '<br>');
            %>
            <div class="proposal-section-text"><%- renderedSection %></div>
          </div>
        <% }) %>
      </div>
    </section>
  <% } %>

  <% if (terms) { %>
    <section class="card shadow-sm page-break">
      <div class="card-header bg-light fw-semibold">Terms &amp; Conditions</div>
      <div class="card-body proposal-terms small">
        <%- formatPlain(terms).replace(/\n/g, '<br>') %>
      </div>
    </section>
  <% } %>
</div>

<ul id="previewItemsSource" class="d-none">
  <% (items || []).forEach(item => { %>
    <li data-id="<%= item.id %>" data-price="<%= Number(item.unit_price || 0).toFixed(2) %>">
      <%- String(item.description || '').replace(/\r\n|\r|\n/g, ' ') %>
    </li>
  <% }) %>
</ul>

<script>
  window.previewContext = {
    proposalId: <%= proposalId ? Number(proposalId) : 'null' %>
  };
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const source = document.getElementById('previewItemsSource');
    const mount = document.getElementById('previewMenuMount');
    if (!source || !mount) return;

    const parseMeta = (text) => {
      const meta = {};
      let match;
      const regex = /\[([a-z_]+):([^\]]+)\]/gi;
      while ((match = regex.exec(text))) meta[match[1].toLowerCase()] = match[2];
      const qtyMatch = text.match(/ x (\d+)/i);
      if (qtyMatch) meta.qty = Number(qtyMatch[1]);
      if (/\[excluded:true\]/i.test(text)) meta.excluded = true;
      return meta;
    };

    const cleanLabel = (text) => text.replace(/\[[^\]]+\]/g, '').replace(/\s{2,}/g, ' ').trim();
    const isChild = (text) => /^\s*(Choice:|Add-on:)/i.test(text);

    const categories = new Map();
    let currentMenu = null;

    source.querySelectorAll('li').forEach((li) => {
      const id = Number(li.dataset.id);
      const raw = (li.textContent || '').trim();
      const meta = parseMeta(raw);
      const text = cleanLabel(raw);
      const price = Number(li.dataset.price || 0);

      if (!isChild(text)) {
        const category = meta.category || 'Uncategorised';
        if (!categories.has(category)) categories.set(category, []);
        currentMenu = {
          title: text.replace(/^Menu:\s*/i, ''),
          basePrice: price,
          items: [],
        };
        categories.get(category).push(currentMenu);
        return;
      }

      if (!currentMenu || meta.excluded) return;
      const qty = meta.qty ? Number(meta.qty) : 1;
      const priceEach = meta.base != null ? Number(meta.base) : qty > 0 ? price / qty : price;
      currentMenu.items.push({
        name: text.replace(/^(Choice:|Add-on:)\s*/i, '').replace(/\s+x\s+\d+.*/, '').trim(),
        qty,
        priceEach,
        total: price,
      });
    });

    if (!categories.size) {
      mount.innerHTML = '<div class="alert alert-secondary mb-0">No menu content included.</div>';
      return;
    }

    categories.forEach((menus, category) => {
      const card = document.createElement('div');
      card.className = 'proposal-summary-card';
      const header = document.createElement('div');
      header.className = 'hdr';
      header.textContent = category;
      card.appendChild(header);

      const body = document.createElement('div');
      body.className = 'body';
      menus.forEach((menu) => {
        const block = document.createElement('div');
        block.className = 'menu-block';
        block.innerHTML = `<div class="menu-title">${menu.title}</div>`;
        const table = document.createElement('table');
        table.className = 'table table-sm proposal-menu-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th>Item</th>
              <th style="width: 60px;">Qty</th>
              <th style="width: 90px;">Each</th>
              <th style="width: 110px;" class="text-end">Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        menu.items.forEach((item) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td>$${Number(item.priceEach).toFixed(2)}</td>
            <td class="text-end">$${Number(item.total).toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });
        if (menu.basePrice) {
          const tfoot = document.createElement('tfoot');
          tfoot.innerHTML = `
            <tr>
              <th colspan="3" class="text-end">Base Price</th>
              <th class="text-end">$${Number(menu.basePrice).toFixed(2)}</th>
            </tr>
          `;
          table.appendChild(tfoot);
        }
        if (!menu.items.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="4" class="text-muted fst-italic">No optional items included.</td>`;
          tbody.appendChild(emptyRow);
        }
        block.appendChild(table);
        body.appendChild(block);
      });

      card.appendChild(body);
      mount.appendChild(card);
    });
  });
</script>

<style>
  .proposal-preview {
    font-size: 11pt;
    line-height: 14pt;
  }
  .proposal-preview p,
  .proposal-preview li,
  .proposal-preview table,
  .proposal-preview dl,
  .proposal-preview td,
  .proposal-preview th,
  .proposal-preview .proposal-section-text,
  .proposal-preview .proposal-terms {
    font-size: 11pt;
    line-height: 14pt;
  }
  .proposal-summary-card {
    border: 1px solid #dde1e6;
    border-radius: 10px;
    overflow: hidden;
  }
  .proposal-summary-card .hdr {
    background: #f4f6fa;
    padding: 8px 12px;
    font-weight: 600;
  }
  .proposal-summary-card .body {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .proposal-menu-table thead th {
    background: #f8f9fb;
  }
  .page-break {
    page-break-before: always;
    margin-top: 32px;
  }
  @page {
    size: A4;
    margin: 20mm;
  }
  @media print {
    body {
      font-size: 11pt;
      line-height: 14pt;
    }
    .btn-toolbar {
      display: none !important;
    }
    .page-break {
      page-break-before: always;
    }
    .proposal-menu-table thead {
      display: table-header-group;
    }
  }
</style>
