<% locals.layout = 'layouts/main'; %>

<%
  const formatPlain = (value) => {
    return String(value || '')
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/(p|div|li|h[1-6])>/gi, '\n')
      .replace(/<[^>]+>/g, '')
      .replace(/\r/g, '')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  };
  const formatTime = (value) => {
    if (!value) return null;
    const str = String(value);
    return str.length >= 5 ? str.slice(0, 5) : str;
  };
  const startTime = formatTime(fn?.start_time);
  const endTime = formatTime(fn?.end_time);
  const contactList = Array.isArray(contacts) ? contacts : [];
  const resolveContactId = (contact) =>
    contact?.id ?? contact?.contact_id ?? contact?.id_uuid ?? null;
  const selectedContactIds = Array.isArray(saved?.includeContactIds)
    ? saved.includeContactIds.map((id) => String(id))
    : [];
  let orderedContacts = [];
  if (selectedContactIds.length) {
    const orderMap = new Map(
      selectedContactIds.map((id, index) => [String(id), index])
    );
    orderedContacts = contactList
      .filter((contact) => {
        const contactId = resolveContactId(contact);
        return orderMap.has(String(contactId));
      })
      .sort((a, b) => {
        const aIdx = orderMap.get(String(resolveContactId(a)));
        const bIdx = orderMap.get(String(resolveContactId(b)));
        return aIdx - bIdx;
      });
  } else if (contactList.length) {
    orderedContacts = [...contactList].sort((a, b) => {
      const primDelta =
        Number(Boolean(b?.is_primary)) - Number(Boolean(a?.is_primary));
      if (primDelta !== 0) return primDelta;
      return (a?.name || "").localeCompare(b?.name || "");
    });
  }
  const primaryContact =
    orderedContacts[0] ||
    contactList.find((c) => c.is_primary) ||
    contactList[0] ||
    null;
  const printedDate = new Date().toLocaleDateString('en-NZ', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
  const eventDate = fn?.event_date
    ? new Date(fn.event_date).toLocaleDateString('en-NZ', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
      })
    : 'TBC';
  const safeTotals = totals || {
    subtotal: 0,
    gratuity_percent: 0,
    gratuity_amount: 0,
    discount_amount: 0,
    deposit_amount: 0,
    total_paid: 0,
    remaining_due: 0,
  };
  const subtotal = Number(safeTotals.subtotal || 0);
  const gratuityAmount = Number(safeTotals.gratuity_amount || 0);
  const gratuityPercent = Number(safeTotals.gratuity_percent || 0);
  const discountAmount = Number(safeTotals.discount_amount || 0);
  const depositAmount = Number(safeTotals.deposit_amount || 0);
  const totalPaid = Number(safeTotals.total_paid || 0);
  const remainingDue = Number(safeTotals.remaining_due || 0);
  const finalTotal = subtotal + gratuityAmount - discountAmount;
  const gstPortion = finalTotal > 0 ? finalTotal - finalTotal / 1.15 : 0;
  const currency = (val) => `$${(Number(val) || 0).toFixed(2)}`;
%>

<div class="proposal-print container py-4">
  <div class="d-flex justify-content-end mb-3 no-print">
    <button class="btn btn-outline-primary btn-sm" type="button" onclick="window.print()">
      <i class="bi bi-printer me-1"></i> Print / Save as PDF
    </button>
  </div>
  <header class="proposal-header card shadow-sm mb-4">
    <div class="proposal-header__logo proposal-header__logo--pc">
      <img src="/img/Pclogotext.png" alt="Porirua Club" class="proposal-logo proposal-logo--primary">
    </div>
    <div class="proposal-header__meta">
      <div class="proposal-header__date"><%= eventDate %></div>
      <div class="proposal-header__title"><strong><%= fn.event_name || 'Function Proposal' %></strong></div>
      <div class="proposal-header__contact">
        <div class="text-muted text-uppercase small letter-tight">Attention</div>
        <% if (primaryContact) { %>
          <strong><%= primaryContact.name %></strong>
          <% if (primaryContact.email) { %><span><%= primaryContact.email %></span><% } %>
          <% if (primaryContact.phone) { %><span><%= primaryContact.phone %></span><% } %>
        <% } else { %>
          <span class="text-muted">No contact selected</span>
        <% } %>
      </div>
      <div class="proposal-header__issued text-uppercase small text-muted">
        Prepared <%= printedDate %>
      </div>
    </div>
    <div class="proposal-header__logo proposal-header__logo--eastwood">
      <img src="/img/EASTWOOD-LOGO-small.png" alt="Eastwood" class="proposal-logo proposal-logo--secondary">
    </div>
  </header>

  <section class="proposal-summary-grid mb-4">
    <div class="proposal-summary-card card shadow-sm">
      <div class="card-body">
        <h5 class="proposal-summary__title">Function Details</h5>
        <dl class="proposal-summary__list">
          <div>
            <dt>Event Date</dt>
            <dd><%= eventDate %></dd>
          </div>
          <div>
            <dt>Attendees</dt>
            <dd><%= fn.attendees || 0 %></dd>
          </div>
          <div>
            <dt>Start / Finish</dt>
            <dd><%= startTime || '--:--' %> â€“ <%= endTime || '--:--' %></dd>
          </div>
          <% if (fn.room_name) { %>
            <div>
              <dt>Room</dt>
              <dd><%= fn.room_name %></dd>
            </div>
          <% } %>
          <% if (fn.status) { %>
            <div>
              <dt>Status</dt>
              <dd><%= fn.status %></dd>
            </div>
          <% } %>
        </dl>
      </div>
    </div>
    <% if ((orderedContacts || []).length) { %>
      <div class="proposal-summary-card card shadow-sm">
        <div class="card-body">
          <h5 class="proposal-summary__title">Contacts</h5>
          <ul class="proposal-contact-list">
            <% orderedContacts.forEach((contact) => { %>
              <li>
                <strong><%= contact.name %></strong>
                <% if (contact.is_primary) { %>
                  <span class="badge bg-secondary ms-2 text-uppercase">Primary</span>
                <% } %>
                <br>
                <span><%= contact.email || 'No email' %></span>
                <% if (contact.phone) { %><span><%= contact.phone %></span><% } %>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
    <% } else { %>
      <div class="proposal-summary-card card shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-center text-muted small">
          No contacts linked to this function yet.
        </div>
      </div>
    <% } %>
  </section>

  <section id="proposalRoomHireSection" class="proposal-table-card proposal-section proposal-content-rail d-none">
    <h5 class="proposal-category__title">Room Hire</h5>
    <div id="proposalPricingRoomHire"></div>
  </section>

  <section class="proposal-run-sheet proposal-flat proposal-content-rail">
    <h5 class="proposal-run-sheet__title">Function Run Sheet</h5>
    <% if ((sections || []).length) { %>
      <div class="proposal-run-sheet__notes vstack gap-3">
        <% sections.forEach((section) => { %>
          <div class="proposal-run-sheet__entry">
            <%
              const sectionBody = section?.content || '';
              const hasMarkup = /<[a-z][\s\S]*>/i.test(sectionBody);
              const renderedSection = hasMarkup ? sectionBody : formatPlain(sectionBody).replace(/\n/g, '<br>');
            %>
            <div class="proposal-section-text"><%- renderedSection %></div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="text-muted small">No function notes selected for this proposal.</div>
    <% } %>
  </section>

  <section id="proposalCateringSection" class="proposal-table-card proposal-section proposal-catering-card proposal-content-rail d-none">
    <h5 class="proposal-category__title">Catering</h5>
    <div id="proposalPricingCatering"></div>
  </section>

  <section id="proposalOtherSection" class="proposal-table-card proposal-section proposal-content-rail d-none">
    <h5 class="proposal-category__title">Additional Items</h5>
    <div id="proposalPricingOther"></div>
  </section>

  <section class="proposal-financial proposal-flat proposal-content-rail">
    <h5 class="proposal-financial__title">Financial Summary</h5>
    <table class="proposal-table__grid proposal-financial__table">
      <tbody>
        <tr>
          <td>Subtotal</td>
          <td class="text-end"><%= currency(subtotal) %></td>
        </tr>
        <% if (gratuityAmount > 0) { %>
          <tr>
            <td>Gratuity (<%= gratuityPercent.toFixed(2) %>%)</td>
            <td class="text-end"><%= currency(gratuityAmount) %></td>
          </tr>
        <% } %>
        <% if (discountAmount > 0) { %>
          <tr>
            <td>Discount</td>
            <td class="text-end">-<%= currency(discountAmount) %></td>
          </tr>
        <% } %>
        <tr class="proposal-financial__highlight">
          <td>Total (incl. GST)</td>
          <td class="text-end"><%= currency(finalTotal) %></td>
        </tr>
        <tr>
          <td>GST (included)</td>
          <td class="text-end"><%= currency(gstPortion) %></td>
        </tr>
        <tr>
          <td>Deposit Paid</td>
          <td class="text-end">-<%= currency(depositAmount) %></td>
        </tr>
        <tr>
          <td>Payments</td>
          <td class="text-end">-<%= currency(totalPaid) %></td>
        </tr>
        <tr class="proposal-financial__total-due">
          <td>Total Owing</td>
          <td class="text-end"><%= currency(remainingDue) %></td>
        </tr>
      </tbody>
    </table>
  </section>

  <% if (terms) { %>
    <section class="proposal-terms card shadow-sm page-break">
      <div class="card-header bg-light fw-semibold">Terms &amp; Conditions</div>
      <div class="card-body proposal-terms__body small">
        <%- terms %>
      </div>
    </section>
  <% } %>
</div>

<ul id="previewItemsSource" class="d-none">
  <% (items || []).forEach(item => { %>
    <li data-id="<%= item.id %>" data-price="<%= Number(item.unit_price || 0).toFixed(2) %>">
      <%- String(item.description || '').replace(/\r\n|\r|\n/g, ' ') %>
    </li>
  <% }) %>
</ul>

<script>
  window.previewContext = {
    proposalId: <%= proposalId ? Number(proposalId) : 'null' %>
  };
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const source = document.getElementById('previewItemsSource');
    const roomMount = document.getElementById('proposalPricingRoomHire');
    const cateringMount = document.getElementById('proposalPricingCatering');
    const otherMount = document.getElementById('proposalPricingOther');
    const roomSection = document.getElementById('proposalRoomHireSection');
    const cateringSection = document.getElementById('proposalCateringSection');
    const otherSection = document.getElementById('proposalOtherSection');
    if (!source) return;

    const parseMeta = (text) => {
      const meta = {};
      let match;
      const regex = /\[([a-z_]+):([^\]]+)\]/gi;
      while ((match = regex.exec(text))) meta[match[1].toLowerCase()] = match[2];
      const qtyMatch = text.match(/ x (\d+)/i);
      if (qtyMatch) meta.qty = Number(qtyMatch[1]);
      if (/\[excluded:true\]/i.test(text)) meta.excluded = true;
      return meta;
    };

    const cleanLabel = (text) => text.replace(/\[[^\]]+\]/g, '').replace(/\s{2,}/g, ' ').trim();
    const isChild = (text) => /^\s*(Choice:|Add-on:)/i.test(text);
    const formatCurrency = (value) => `$${(Number(value) || 0).toFixed(2)}`;

    function buildModel() {
      const categories = new Map();
      let currentMenu = null;

      source.querySelectorAll('li').forEach((li) => {
        const id = Number(li.dataset.id);
        const rawText = (li.textContent || '').trim();
        const meta = parseMeta(rawText);
        const price = Number(li.dataset.price || 0);
        const text = cleanLabel(rawText);
        const isAddon = /^\s*Add-on:/i.test(rawText);

        if (!isChild(text)) {
          const categoryName = meta.category || 'Uncategorised';
          if (!categories.has(categoryName)) categories.set(categoryName, []);
          currentMenu = {
            title: text.replace(/^Menu:\s*/i, '').trim(),
            basePrice: price,
            baseQty: meta.qty ? Number(meta.qty) : 1,
            baseExcluded: Boolean(meta.excluded),
            items: [],
          };
          categories.get(categoryName).push(currentMenu);
          return;
        }

        if (!currentMenu || meta.excluded) return;
        const unitType = meta.unit_type || '';
        const qty = meta.qty
          ? Number(meta.qty)
          : unitType === 'per_person'
          ? Number(window.fnContext?.attendees || 0) || 1
          : 1;
        const priceEach = qty > 0 ? price / qty : price;
        const item = {
          id,
          name: text.replace(/^(Choice:|Add-on:)\s*/i, '').replace(/\s+x\s+\d+.*/, '').trim(),
          price,
          priceEach,
          qty,
          isAddon,
        };
        currentMenu.items.push(item);
      });

      return categories;
    }

    function renderGroup(entries, mount, section, options = {}) {
      const hideTitles = Boolean(options.hideTitles);
      if (!mount || !section) return;
      mount.innerHTML = '';
      if (!entries.length) {
        section.classList.add('d-none');
        return;
      }
      section.classList.remove('d-none');

      entries.forEach(([categoryName, menus]) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'proposal-category';
        if (categoryName && !hideTitles) {
          wrapper.innerHTML = `<h5 class="proposal-category__title">${categoryName}</h5>`;
        }

        const table = document.createElement('table');
        table.className = 'proposal-table__grid';
        table.innerHTML = `
          <thead>
            <tr>
              <th class="proposal-cell--item">Item</th>
              <th class="proposal-cell--qty">Qty</th>
              <th class="proposal-cell--price">Price Each</th>
              <th class="proposal-cell--total">Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        menus.forEach((menu) => {
          if (!menu.baseExcluded) {
            const baseLabel = menu.title || 'Package';
            const baseQty = menu.baseQty || 1;
            const baseRow = document.createElement('tr');
            baseRow.innerHTML = `
              <td class="proposal-cell proposal-cell--item">${baseLabel}</td>
              <td class="proposal-cell proposal-cell--qty">${baseQty}</td>
              <td class="proposal-cell proposal-cell--price">${formatCurrency(menu.basePrice)}</td>
              <td class="proposal-cell proposal-cell--total">${formatCurrency((menu.basePrice || 0) * baseQty)}</td>
            `;
            tbody.appendChild(baseRow);
          }

          menu.items.forEach((item) => {
            const row = document.createElement('tr');
            const label = item.isAddon ? `${item.name} (Add-on)` : item.name;
            row.innerHTML = `
              <td class="proposal-cell proposal-cell--item">${label}</td>
              <td class="proposal-cell proposal-cell--qty">${item.qty || 1}</td>
              <td class="proposal-cell proposal-cell--price">${formatCurrency(item.priceEach)}</td>
              <td class="proposal-cell proposal-cell--total">${formatCurrency(item.price)}</td>
            `;
            tbody.appendChild(row);
          });
        });

        wrapper.appendChild(table);
        mount.appendChild(wrapper);
      });
    }

    function render() {
      const categories = buildModel();
      if (!categories.size) {
        [roomSection, cateringSection, otherSection]
          .filter(Boolean)
          .forEach((section) => section.classList.add('d-none'));
        return;
      }

      const entries = Array.from(categories.entries());
      const normalize = (name = '') => name.trim().toLowerCase();
      const roomEntries = entries.filter(([name]) => normalize(name) === 'room hire');
      const cateringEntries = entries.filter(([name]) => normalize(name) === 'catering');
      const otherEntries = entries.filter(
        ([name]) => normalize(name) !== 'room hire' && normalize(name) !== 'catering'
      );

      renderGroup(roomEntries, roomMount, roomSection, { hideTitles: true });
      renderGroup(cateringEntries, cateringMount, cateringSection, { hideTitles: true });
      renderGroup(otherEntries, otherMount, otherSection);
    }

    render();
  });
</script>
