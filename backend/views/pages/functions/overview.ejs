<% locals.layout = 'layouts/main'; %>

<%
  var contacts = linkedContacts || [];
  var primaryContact =
    contacts.find(function (c) {
      return c.is_primary;
    }) || contacts[0] || {};
  var secondaryContacts = contacts.filter(function (c) {
    return c !== primaryContact;
  });
  var fieldAudit = typeof overviewAudit !== "undefined" ? overviewAudit : {};
  var notesList = typeof overviewNotes !== "undefined" ? overviewNotes : [];
  var allNotes = typeof notes !== "undefined" ? notes : [];
  var menuSummary = typeof overviewMenus !== "undefined" ? overviewMenus : [];
  var financialTotals = typeof totals !== "undefined" ? totals : {};
  var proposalPreview = typeof proposalPreviewLink !== "undefined" ? proposalPreviewLink : null;
  var proposalAudit = typeof proposalAuditData !== "undefined" ? proposalAuditData : null;
  var communicationsFeed =
    typeof communications !== "undefined"
      ? communications
      : grouped
      ? Object.values(grouped).flat()
      : [];

  function nzDate(value) {
    if (!value) return "-";
    return new Date(value).toLocaleDateString("en-NZ");
  }
  function nzTime(value) {
    if (!value) return "--:--";
    var dateValue = value;
    if (typeof value === "string" && value.indexOf("T") === -1) {
      dateValue = "1970-01-01T" + value;
    }
    var d = new Date(dateValue);
    if (isNaN(d.getTime())) return "--:--";
    return d.toLocaleTimeString("en-NZ", { hour: "2-digit", minute: "2-digit" });
  }
  function formatStamp(audit, field) {
    field = field || "updated_at";
    if (!audit) return "-";
    const stamp = audit[field] || audit.date || audit.timestamp;
    const label =
      audit.name ||
      audit.updated_by_name ||
      audit.display ||
      audit.initials ||
      audit.updated_by ||
      audit.user ||
      "";
    if (!stamp && !label) return "-";
    const formatted = stamp ? new Date(stamp).toLocaleDateString("en-NZ") : "-";
    return label ? (formatted + " (" + label + ")").trim() : formatted;
  }
  function formatUpdated(audit) {
    return formatStamp(audit, "updated_at");
  }
  function formatCreated(audit) {
    return formatStamp(audit, "created_at");
  }
  function formatDateInput(value) {
    if (!value) return "";
    var dateObj = new Date(value);
    if (isNaN(dateObj.getTime())) return "";
    var tzOffsetMs = dateObj.getTimezoneOffset() * 60000;
    var localDate = new Date(dateObj.getTime() - tzOffsetMs);
    return localDate.toISOString().split("T")[0];
  }
%>

<div class="function-body function-overview py-4 px-4">
  <% const canManage = user && ['admin','owner'].includes((user.role || '').toLowerCase()); %>
  <div class="overview-toolbar d-flex flex-wrap align-items-center gap-2 mb-3 w-100">
    <% if (canManage) { %>
      <div class="overview-actions d-flex flex-wrap gap-2">
        <button class="btn btn-outline-secondary btn-sm" data-action="archive-function">
          <i class="bi bi-archive me-1"></i> Archive Function
        </button>
        <button class="btn btn-outline-danger btn-sm" data-action="delete-function">
          <i class="bi bi-trash me-1"></i> Delete Function
        </button>
      </div>
    <% } %>
    <div class="ms-auto d-flex">
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#runSheetModal">
        <i class="bi bi-clipboard-check me-1"></i> Run sheet
      </button>
    </div>
  </div>
  <!-- Snapshot -->
  <section class="overview-card overview-snapshot">
    <div class="overview-card__header">
      <div>
        <p class="overview-card__title mb-1">Function Snapshot</p>
        <p class="overview-card__subtitle mb-0">Key details at a glance</p>
      </div>
      <div class="btn-group">
        <a href="/functions/<%= fn.id_uuid %>/edit" class="btn btn-sm btn-outline-primary">Edit function</a>
      </div>
    </div>
    <div class="snapshot-grid">
      <div class="snapshot-row">
        <div class="snapshot-label">Primary Contact</div>
        <div class="snapshot-value">
          <% if (primaryContact && primaryContact.name) { %>
            <strong><%= primaryContact.name %></strong><br>
            <span class="text-muted small"><%= primaryContact.email || 'no email' %> • <%= primaryContact.phone || 'no phone' %></span>
          <% } else { %>
            <span class="text-muted">Not assigned</span>
          <% } %>
        </div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.primary_contact) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">Additional Contacts</div>
        <div class="snapshot-value">
          <% if (secondaryContacts.length) { %>
            <%= secondaryContacts.map(function (c) { return c.name; }).join(', ') %>
          <% } else { %>
            <span class="text-muted">None linked</span>
          <% } %>
        </div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.contacts) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">Attendees</div>
        <div class="snapshot-value"><%= fn.attendees || 0 %></div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.attendees) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">Event Date</div>
        <div class="snapshot-value"><%= nzDate(fn.event_date) %></div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.event_date) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">Start Time</div>
        <div class="snapshot-value"><%= nzTime(fn.start_time) %></div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.start_time) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">End Time</div>
        <div class="snapshot-value"><%= nzTime(fn.end_time) %></div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.end_time) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">Room / Space</div>
        <div class="snapshot-value"><%= fn.room_name || 'Unassigned' %></div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.room_id) %></div>
      </div>
      <div class="snapshot-row">
        <div class="snapshot-label">Status</div>
        <div class="snapshot-value"><span class="badge bg-light text-dark text-uppercase tracking-wide"><%= fn.status || 'lead' %></span></div>
        <div class="snapshot-updated"><%= formatUpdated(fieldAudit.status) %></div>
      </div>
    </div>
  </section>

  <!-- Financial summary -->
  <section class="overview-card overview-financial">
    <div class="overview-card__header">
      <div>
        <p class="overview-card__title mb-1">Financial Summary</p>
        <p class="overview-card__subtitle mb-1">Totals reflected from the live quote</p>
        <% if (proposalAudit) { %>
          <p class="text-muted small mb-0">
            Proposal status:
            <span class="badge bg-light text-dark text-uppercase"><%= proposalAudit.status %></span>
            · <%= formatUpdated(proposalAudit) %>
          </p>
          <p class="text-muted small mb-0">Update this inside the proposal builder on the quote page.</p>
        <% } %>
        <% if (totals && totals.audit) { %>
          <p class="text-muted small mb-0">Updated <%= formatUpdated(totals.audit) %></p>
        <% } %>
        <% if (proposalAudit && proposalAudit.created_at) { %>
          <p class="text-muted small mb-0">Created <%= formatCreated(proposalAudit) %></p>
        <% } %>
      </div>
      <div class="btn-group">
        <a href="/functions/<%= fn.id_uuid %>/quote#totals" class="btn btn-sm btn-outline-secondary">Adjust in quote</a>
        <% if (proposalPreview) { %>
          <a href="<%= proposalPreview %>" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">View proposal</a>
        <% } %>
      </div>
    </div>
    <div class="financial-grid">
      <div class="financial-item">
        <span>Subtotal</span>
        <strong>$<%= Number(financialTotals.subtotal || 0).toFixed(2) %></strong>
      </div>
      <% if (Number(financialTotals.gratuity_amount || 0) > 0) { %>
        <div class="financial-item">
          <span>Gratuity (<%= Number(financialTotals.gratuity_percent || 0).toFixed(2) %>%)</span>
          <strong>$<%= Number(financialTotals.gratuity_amount || 0).toFixed(2) %></strong>
        </div>
      <% } %>
      <% if (Number(financialTotals.discount_amount || 0) > 0) { %>
        <div class="financial-item">
          <span>Discounts</span>
          <strong>$<%= Number(financialTotals.discount_amount || 0).toFixed(2) %></strong>
        </div>
      <% } %>
      <div class="financial-item">
        <span>Deposit</span>
        <strong>$<%= Number(financialTotals.deposit_amount || 0).toFixed(2) %></strong>
      </div>
      <div class="financial-item">
        <span>Total Paid</span>
        <strong>$<%= Number(financialTotals.total_paid || 0).toFixed(2) %></strong>
      </div>
      <div class="financial-item">
        <span>Remaining Due</span>
        <strong class="text-danger">$<%= Number(financialTotals.remaining_due || 0).toFixed(2) %></strong>
      </div>
    </div>
  </section>
  <!-- Notes & Calls -->
  <section class="overview-card overview-notes">
    <div class="overview-card__header">
      <div>
        <p class="overview-card__title mb-1">Notes &amp; Calls</p>
        <p class="overview-card__subtitle mb-0">Operational detail and logged conversations</p>
      </div>
      <div class="btn-group gap-2">
        <button class="btn btn-sm btn-outline-secondary" data-action="add-note" data-function="<%= fn.id_uuid %>">Add note</button>
        <button class="btn btn-sm btn-outline-primary" data-action="log-call" data-function="<%= fn.id_uuid %>">Log call</button>
      </div>
    </div>
    <div class="notes-list">
      <% if (!notesList.length) { %>
        <div class="empty-state">No notes logged yet.</div>
      <% } else { %>
        <% notesList.forEach(function (note) { %>
          <article class="note-card" data-note-id="<%= note.id %>">
            <div class="note-card__head">
              <div>
                <span class="note-card__type">
                  <i class="bi <%= note.type === 'call' ? 'bi-telephone' : 'bi-journal-text' %> me-1"></i>
                  <%= note.title || note.note_type || 'Untitled' %>
                </span>
                <% if (note.contact_name) { %>
                  <span class="badge bg-light text-dark ms-2"><%= note.contact_name %></span>
                <% } %>
              </div>
              <a href="/functions/<%= fn.id_uuid %>/notes?focus=<%= note.id %>#note-<%= note.id %>" class="btn btn-link btn-sm p-0">Open</a>
            </div>
              <p class="note-card__preview mb-2"><%= (note.preview || note.content || '').substring(0, 140) %><%= (note.preview || note.content || '').length > 140 ? '…' : '' %></p>
            <div class="note-card__meta">
              <% const updatedLabel = note.updated_by_name || note.updated_by_initials || ''; %>
              <span>Updated <%= nzDate(note.updated_at || note.created_at) %> <%= updatedLabel %></span>
            </div>
          </article>
        <% }) %>
      <% } %>
    </div>
  </section>
  <!-- Menu Overview -->
  <section class="overview-card overview-menus">
    <div class="overview-card__header">
      <div>
        <p class="overview-card__title mb-1">Menus &amp; Choices</p>
        <p class="overview-card__subtitle mb-0">Items currently priced on the quote</p>
      </div>
      <a href="/functions/<%= fn.id_uuid %>/quote" class="btn btn-sm btn-outline-primary">Open quote</a>
    </div>
    <div class="menu-list">
      <% if (!menuSummary.length) { %>
        <div class="empty-state">No menus attached to this quote.</div>
      <% } else { %>
        <% menuSummary.forEach(function (menu) { %>
          <article class="menu-row" data-menu-id="<%= menu.id %>" data-menu-items='<%- JSON.stringify(menu.items || []) %>'>
            <div class="menu-row__body">
              <div>
                <p class="menu-row__title mb-1"><%= menu.name %></p>
                <p class="menu-row__meta mb-0 text-muted"><%= menu.category || 'Uncategorised' %> &bull; Qty <%= menu.qty || 0 %> &bull; <%= menu.unit || 'each' %></p>
              </div>
              <div class="menu-row__totals text-end">
                <div class="fw-semibold">$<%= Number(menu.total_price || 0).toFixed(2) %></div>
                <small class="text-muted">Cost $<%= Number(menu.total_cost || 0).toFixed(2) %></small>
              </div>
            </div>
            <div class="menu-row__actions">
              <div class="text-muted small d-flex flex-column menu-row__audit">
                <% if (menu.audit && menu.audit.created_at) { %>
                  <span>Created <%= formatCreated(menu.audit) %></span>
                <% } %>
                <% if (menu.audit && menu.audit.updated_at) { %>
                  <span>Updated <%= formatUpdated(menu.audit) %></span>
                <% } %>
              </div>
              <div class="btn-group gap-2">
                <button class="btn btn-sm btn-outline-secondary" data-action="view-menu" data-menu-id="<%= menu.id %>">View items</button>
                <button class="btn btn-sm btn-outline-primary" data-action="edit-menu" data-menu-id="<%= menu.id %>" title="Opens the quote builder for this menu">Edit in quote</button>
              </div>
            </div>
          </article>
        <% }) %>
      <% } %>
    </div>
  </section>

  <!-- Menu Items Modal -->
  <div class="modal fade" id="menuItemsModal" tabindex="-1" aria-labelledby="menuItemsModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="menuItemsModalTitle">Menu items</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="menuItemsModalBody">
          <p class="text-muted mb-0">No items recorded for this menu.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Communications -->
  <section class="overview-card overview-communications">
    <div class="overview-card__header">
      <div>
        <p class="overview-card__title mb-1">Recent Communications</p>
        <p class="overview-card__subtitle mb-0">Emails, proposals, and surveys</p>
      </div>
      <a href="/functions/<%= fn.id_uuid %>/communications" class="btn btn-sm btn-outline-secondary">View all</a>
    </div>
    <div class="comms-feed">
      <% if (!communicationsFeed.length) { %>
        <div class="empty-state">No communications recorded.</div>
      <% } else { %>
        <% communicationsFeed.slice(0, 6).forEach(function (entry) { %>
          <article class="comms-entry">
            <div class="comms-entry__icon">
              <i class="bi <%= entry.type === 'proposal' ? 'bi-file-earmark-text' : entry.type === 'email' ? 'bi-envelope' : entry.type === 'survey' ? 'bi-clipboard-check' : 'bi-chat-left' %>"></i>
            </div>
            <div class="comms-entry__body">
              <p class="mb-0 fw-semibold"><%= entry.subject || entry.title || entry.type || 'Update' %></p>
              <small class="text-muted"><%= entry.preview || entry.summary || entry.note || '' %></small>
            </div>
            <div class="comms-entry__meta text-end">
              <span class="d-block"><%= nzDate(entry.entry_date || entry.created_at) %></span>
              <small class="text-muted"><%= nzTime(entry.entry_date || entry.created_at) %></small>
              <a href="<%= entry.link || '#' %>" class="btn btn-link btn-sm p-0 mt-1">Open</a>
            </div>
          </article>
        <% }) %>
      <% } %>
    </div>
</section>
</div>

<!-- Run Sheet Modal -->
<div class="modal fade" id="runSheetModal" tabindex="-1" aria-labelledby="runSheetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="runSheetForm">
        <div class="modal-header">
          <h5 class="modal-title" id="runSheetModalLabel">Build Run Sheet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-sm-6">
              <label class="form-label text-muted small">Event date</label>
              <p class="fw-semibold mb-0"><%= nzDate(fn.event_date) %></p>
            </div>
            <div class="col-sm-6">
              <label class="form-label text-muted small">Room / Guests</label>
              <p class="fw-semibold mb-0"><%= fn.room_name || 'Unassigned' %> · <%= fn.attendees || 0 %> guests</p>
            </div>
            <div class="col-sm-6">
              <label class="form-label text-muted small">Start time</label>
              <p class="fw-semibold mb-0"><%= nzTime(fn.start_time) %></p>
            </div>
            <div class="col-sm-6">
              <label class="form-label text-muted small">End time</label>
              <p class="fw-semibold mb-0"><%= nzTime(fn.end_time) %></p>
            </div>
          </div>
          <div class="mb-4">
            <label class="form-label fw-semibold">Include notes</label>
            <% if (!allNotes.length) { %>
              <p class="text-muted mb-0">No notes available.</p>
            <% } else { %>
              <div class="run-sheet-checklist">
                <% allNotes.forEach(function(note) { %>
                  <label class="form-check form-check-inline run-sheet-option">
                    <input class="form-check-input" type="checkbox" name="notes" value="<%= note.id %>" checked>
                    <span class="form-check-label">
                      <% if (note.note_type === 'call') { %>Call<% } else if (note.note_type) { %><%= note.note_type.charAt(0).toUpperCase() + note.note_type.slice(1) %><% } else { %>Note<% } %>
                      <small class="text-muted ms-1"><%= new Date(note.updated_at || note.created_at || Date.now()).toLocaleDateString('en-NZ') %></small>
                    </span>
                  </label>
                <% }) %>
              </div>
            <% } %>
          </div>
          <div>
            <label class="form-label fw-semibold">Include menus</label>
            <% if (!menuSummary.length) { %>
              <p class="text-muted mb-0">No menus currently on the quote.</p>
            <% } else { %>
              <div class="run-sheet-checklist">
                <% menuSummary.forEach(function(menu) { %>
                  <label class="form-check run-sheet-option">
                    <input class="form-check-input" type="checkbox" name="menus" value="<%= menu.id %>" checked>
                    <span class="form-check-label">
                      <strong><%= menu.name %></strong>
                      <small class="text-muted ms-1"><%= menu.category || 'Catering' %></small>
                    </span>
                  </label>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="runSheetPreviewBtn">Preview</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Quick Note Modal -->
<div class="modal fade" id="quickNoteModal" tabindex="-1" aria-labelledby="quickNoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="quickNoteModalForm">
        <div class="modal-header">
          <h5 class="modal-title quick-note-title" id="quickNoteModalLabel">Add note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="quickNoteType" class="form-label">Type</label>
            <select id="quickNoteType" class="form-select">
              <option value="call">Call log</option>
              <option value="proposal">Proposal note</option>
              <option value="internal">Internal</option>
            </select>
          </div>
          <div class="mb-0">
            <label for="quickNoteContent" class="form-label">Details</label>
            <textarea id="quickNoteContent" class="form-control" rows="4" placeholder="Add note details"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save note</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Shared Modals -->
<%- include('../../partials/functions/modals', {
  fn,
  linkedContacts: linkedContacts || [],
  rooms: rooms || [],
  eventTypes: eventTypes || []
}) %>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var fnId = "<%= fn.id_uuid %>";
    var modalEl = document.getElementById('quickNoteModal');
    var modalForm = document.getElementById('quickNoteModalForm');
    var typeField = document.getElementById('quickNoteType');
    var contentField = document.getElementById('quickNoteContent');
    var modalTitle = modalEl ? modalEl.querySelector('.quick-note-title') : null;
    var modal = modalEl && window.bootstrap && window.bootstrap.Modal
      ? new window.bootstrap.Modal(modalEl)
      : null;

    function openQuickModal(type) {
      if (!modalEl) {
        window.location.href = `/functions/${fnId}/notes`;
        return;
      }
      if (typeField) {
        typeField.value = type || 'proposal';
      }
      if (modalTitle) {
        modalTitle.textContent = type === 'call' ? 'Log call' : 'Add note';
      }
      if (contentField) {
        contentField.value = "";
      }
      if (modal) {
        modal.show();
      } else {
        window.location.href = `/functions/${fnId}/notes`;
      }
    }

    var noteButtons = document.querySelectorAll('[data-action="add-note"]');
    Array.prototype.forEach.call(noteButtons, function (btn) {
      btn.addEventListener('click', function () { openQuickModal('proposal'); });
    });

    var callButtons = document.querySelectorAll('[data-action="log-call"]');
    Array.prototype.forEach.call(callButtons, function (btn) {
      btn.addEventListener('click', function () { openQuickModal('call'); });
    });

    if (modalForm) modalForm.addEventListener('submit', async function (event) {
      event.preventDefault();
      const content = contentField ? contentField.value.trim() : '';
      const note_type = typeField ? typeField.value : 'proposal';
      if (!content) {
        alert('Please enter note details.');
        return;
      }
      try {
        const res = await fetch(`/functions/${fnId}/notes/new`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, note_type }),
        });
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.message || 'Unable to save note');
        }
        if (modal) modal.hide();
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to save note');
      }
    });

    var runSheetForm = document.getElementById('runSheetForm');
    var runSheetPreviewBtn = document.getElementById('runSheetPreviewBtn');
    if (runSheetPreviewBtn) {
      runSheetPreviewBtn.addEventListener('click', function () {
        if (!runSheetForm) {
          window.open(`/functions/${fnId}/run-sheet`, '_blank');
          return;
        }
        var formData = new FormData(runSheetForm);
        var noteIds = formData.getAll('notes').filter(Boolean);
        var menuIds = formData.getAll('menus').filter(Boolean);
        var params = new URLSearchParams();
        if (noteIds.length) {
          params.set('notes', noteIds.join(','));
        } else {
          params.set('notes', 'none');
        }
        if (menuIds.length) {
          params.set('menus', menuIds.join(','));
        } else {
          params.set('menus', 'none');
        }
        var url = `/functions/${fnId}/run-sheet` + (params.toString() ? `?${params.toString()}` : '');
        window.open(url, '_blank');
      });
    }
  });
</script>

<script>
  window.fnContext = {
    id: "<%= fn.id_uuid %>",
    name: "<%= fn.event_name %>",
    status: "<%= fn.status %>",
    eventDate: "<%= formatDateInput(fn.event_date) %>",
    canManage: <%= canManage ? 'true' : 'false' %>
  };
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var fnId = "<%= fn.id_uuid %>";
    var fnName = <%- JSON.stringify(fn.event_name || '') %>;
    var canManage = window.fnContext && (window.fnContext.canManage === true || window.fnContext.canManage === 'true');
    var archiveBtn = document.querySelector('[data-action="archive-function"]');
    var deleteBtn = document.querySelector('[data-action="delete-function"]');
    var menuItemsModalEl = document.getElementById('menuItemsModal');
    var menuItemsModalTitle = document.getElementById('menuItemsModalTitle');
    var menuItemsModalBody = document.getElementById('menuItemsModalBody');
    var MenuModalCtor = window.bootstrap && window.bootstrap.Modal ? window.bootstrap.Modal : null;
    var menuItemsModal = menuItemsModalEl && MenuModalCtor ? new MenuModalCtor(menuItemsModalEl) : null;

    function formatCurrency(value) {
      var num = Number(value);
      return isNaN(num) ? '$0.00' : '$' + num.toFixed(2);
    }

    function buildMenuItemsHtml(items) {
      items = items || [];
      if (!items.length) {
        return '<p class="text-muted mb-0">No items recorded for this menu.</p>';
      }
      var rows = items
        .map(function (item) {
          var badge = item.excluded
            ? '<span class="badge bg-warning text-dark ms-2">Excluded</span>'
            : '';
          var unitText = item.unit ? ' · ' + item.unit : '';
          var costLine =
            item.cost !== null && item.cost !== undefined
              ? '<small class="text-muted d-block">Cost ' + formatCurrency(item.cost) + '</small>'
              : '';
          return '<div class="list-group-item d-flex justify-content-between align-items-start">' +
            '<div>' +
            '<div class="fw-semibold">' + (item.label || 'Item') + badge + '</div>' +
            '<small class="text-muted">Qty ' + (item.qty || 1) + unitText + '</small>' +
            '</div>' +
            '<div class="text-end">' +
            '<div>' + formatCurrency(item.price) + '</div>' +
            costLine +
            '</div>' +
            '</div>';
        })
        .join('');
      return '<div class="list-group">' + rows + '</div>';
    }

    function goToQuote(menuId, mode) {
      if (!fnId || !menuId) return;
      var params = new URLSearchParams();
      params.set("menu", menuId);
      if (mode) params.set("mode", mode);
      window.location.href = "/functions/" + fnId + "/quote?" + params.toString();
    }

    var viewButtons = document.querySelectorAll('[data-action="view-menu"]');
    Array.prototype.forEach.call(viewButtons, function (btn) {
      btn.addEventListener('click', function () {
        var row = btn.closest('.menu-row');
        if (!row) return;
        var items = [];
        try {
          items = JSON.parse(row.dataset.menuItems || "[]");
        } catch (err) {
          console.warn("Failed to parse menu items", err);
        }
        var titleEl = row.querySelector('.menu-row__title');
        var title = titleEl ? titleEl.textContent.trim() : 'Menu items';
        if (menuItemsModalTitle) menuItemsModalTitle.textContent = title;
        if (menuItemsModalBody) menuItemsModalBody.innerHTML = buildMenuItemsHtml(items);
        if (menuItemsModal) {
          menuItemsModal.show();
        } else {
          alert(title + "\n\n" + (items
            .map(function (item) { return (item.label || 'Item') + ' · Qty ' + (item.qty || 1) + ' · ' + formatCurrency(item.price); })
            .join('\n') || 'No items recorded.'));
        }
      });
    });

    var editButtons = document.querySelectorAll('[data-action="edit-menu"]');
    Array.prototype.forEach.call(editButtons, function (btn) {
      btn.addEventListener('click', function () {
        var menuId = btn.dataset.menuId;
        goToQuote(menuId, "edit");
      });
    });

    if (!canManage) return;

    async function handleRequest(url, options, successMessage) {
      try {
        const res = await fetch(url, options);
        const payload = await res.json();
        if (!payload.success) throw new Error(payload.error || 'Action failed');
        if (successMessage) {
          alert(successMessage);
        }
        window.location.href = '/functions';
      } catch (err) {
        console.error(err);
        alert(err.message || 'Something went wrong');
      }
    }

    if (archiveBtn) archiveBtn.addEventListener('click', function () {
      if (!fnId) return;
      if (!confirm('Archive this function? You can restore it later by editing the status.')) return;
      handleRequest(`/functions/${fnId}/archive`, { method: 'POST', headers: { 'Content-Type': 'application/json' } }, 'Function archived.');
    });

    if (deleteBtn) deleteBtn.addEventListener('click', function () {
      if (!fnId) return;
      const confirmText = prompt(`Type the function name (${fnName || 'function'}) to permanently delete it:`);
      if ((confirmText || '').trim() !== (fnName || '').trim()) {
        alert('Name did not match. Deletion cancelled.');
        return;
      }
      if (!confirm('This will permanently delete the function and related data. Continue?')) return;
      handleRequest(`/functions/${fnId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } }, 'Function deleted.');
    });
  });
</script>

<script src="/js/functions/detail.js" defer></script>
