<% locals.layout = 'layouts/main'; %>

<div class="function-body py-4 px-4 proposal-page">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1">Proposal Builder</h1>
      <div class="text-muted small">
        Configure proposal content for <strong><%= fn.event_name %></strong>.
      </div>
    </div>
    <div class="btn-toolbar gap-2">
      <button id="previewProposalBtn" class="btn btn-outline-primary" <%= proposalId ? '' : 'disabled' %>>
        <i class="bi bi-eye me-1"></i> Preview
      </button>
      <button id="printProposalBtn" class="btn btn-outline-secondary" <%= proposalId ? '' : 'disabled' %>>
        <i class="bi bi-printer me-1"></i> Print
      </button>
      <button id="saveProposalBtn" class="btn btn-success">
        <i class="bi bi-save me-1"></i> Save
      </button>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <section class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold">Included Menus &amp; Items</div>
        <div class="card-body">
          <div id="proposalMenuSummary" class="proposal-menu-summary"></div>
          <% if (!proposalItems.length) { %>
            <div class="alert alert-secondary mb-0">No menu items selected yet. Configure the quote first.</div>
          <% } %>
        </div>
      </section>

      <section class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
          <span>Notes &amp; Sections</span>
          <div class="d-flex gap-2 align-items-center">
            <select id="templatePicker" class="form-select form-select-sm" style="width: 220px;">
              <option value="">Insert templateâ€¦</option>
              <% (templates || []).forEach(t => { %>
                <option value="<%= t.id %>"><%= t.name %><%= t.category ? ' (' + t.category + ')' : '' %></option>
              <% }) %>
            </select>
            <button id="addTemplateBtn" class="btn btn-sm btn-outline-primary">Add</button>
          </div>
        </div>
        <div class="card-body">
          <ul id="proposalSections" class="list-group gap-3">
            <% if ((saved.sections || []).length === 0) { %>
              <li class="list-group-item text-muted fst-italic border">No sections yet.</li>
            <% } %>
            <% (saved.sections || []).forEach((section, idx) => { %>
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-semibold">Section <%= idx + 1 %></span>
                  <button type="button" class="btn btn-sm btn-outline-danger remove-section">Remove</button>
                </div>
                <textarea class="form-control section-content" rows="4"><%= section.content || '' %></textarea>
              </li>
            <% }) %>
          </ul>
        </div>
      </section>

      <section class="card shadow-sm">
        <div class="card-header bg-light fw-semibold">Terms &amp; Conditions</div>
        <div class="card-body">
          <textarea id="termsInput" class="form-control" rows="6" placeholder="Enter or paste your terms..."><%= saved.terms || '' %></textarea>
          <div class="form-text mt-2">Terms are always rendered on a separate page in the proposal preview/PDF.</div>
        </div>
      </section>
    </div>

    <div class="col-lg-5">
      <section class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-semibold">Contacts Included</div>
        <div class="card-body">
          <% if (!(contacts || []).length) { %>
            <div class="alert alert-secondary mb-0">No contacts linked to this function yet.</div>
          <% } else { %>
            <div class="vstack gap-2">
              <% contacts.forEach(contact => { %>
                <label class="form-check">
                  <input class="form-check-input include-contact" type="checkbox" value="<%= contact.id %>" <%= (saved.includeContactIds || []).includes(String(contact.id)) ? 'checked' : '' %>>
                  <span class="form-check-label">
                    <strong><%= contact.name %></strong>
                    <span class="text-muted small">
                      <%= contact.email || 'no email' %>
                      <%= contact.phone ? '&bull; ' + contact.phone : '' %>
                    </span>
                    <% if (contact.is_primary) { %>
                      <span class="badge bg-primary-subtle text-primary ms-2">Primary</span>
                    <% } %>
                  </span>
                </label>
              <% }) %>
            </div>
          <% } %>
        </div>
      </section>

      <section class="card shadow-sm">
        <div class="card-header bg-light fw-semibold">Proposal Summary</div>
        <div class="card-body small">
          <dl class="row mb-0">
            <dt class="col-5">Event Date</dt>
            <dd class="col-7 text-end"><%= fn.event_date ? new Date(fn.event_date).toLocaleDateString() : 'TBC' %></dd>
            <dt class="col-5">Attendees</dt>
            <dd class="col-7 text-end"><%= fn.attendees || 0 %></dd>
            <dt class="col-5">Quote Total</dt>
            <dd class="col-7 text-end">$<%= Number(fn.totals_price || 0).toFixed(2) %></dd>
            <dt class="col-5">Linked Quote Items</dt>
            <dd class="col-7 text-end"><%= proposalItems.length %></dd>
          </dl>
        </div>
      </section>
    </div>
  </div>

  <ul id="proposalItemsSource" class="d-none">
    <% (proposalItems || []).forEach(item => { %>
      <li data-id="<%= item.id %>" data-price="<%= Number(item.unit_price || 0).toFixed(2) %>">
        <%- String(item.description || '').replace(/\r\n|\r|\n/g, ' ') %>
      </li>
    <% }) %>
  </ul>
</div>

<script>
  window.proposalContext = {
    functionId: "<%= fn.id_uuid %>",
    proposalId: <%= proposalId ? Number(proposalId) : 'null' %>,
    attendees: <%= Number(fn.attendees || 0) %>
  };
  window.savedProposalState = <%- JSON.stringify(saved || { includeItemIds: [], includeContactIds: [], sections: [], terms: '' }) %>;
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sectionsList = document.getElementById('proposalSections');
    const templatePicker = document.getElementById('templatePicker');
    const addTemplateBtn = document.getElementById('addTemplateBtn');
    const saveBtn = document.getElementById('saveProposalBtn');
    const previewBtn = document.getElementById('previewProposalBtn');
    const printBtn = document.getElementById('printProposalBtn');
    const menuSummary = document.getElementById('proposalMenuSummary');
    const sourceList = document.getElementById('proposalItemsSource');
    const includeContactInputs = document.querySelectorAll('.include-contact');

    const functionId = window.proposalContext?.functionId;
    const proposalId = window.proposalContext?.proposalId;
    const attendees = Number(window.proposalContext?.attendees || 0);

    const parseMeta = (text) => {
      const meta = {};
      let match;
      const regex = /\[([a-z_]+):([^\]]+)\]/gi;
      while ((match = regex.exec(text))) meta[match[1].toLowerCase()] = match[2];
      const qtyMatch = text.match(/ x (\d+)/i);
      if (qtyMatch) meta.qty = Number(qtyMatch[1]);
      if (/\[excluded:true\]/i.test(text)) meta.excluded = true;
      return meta;
    };

    const cleanLabel = (text) =>
      text.replace(/\[[^\]]+\]/g, '').replace(/\s{2,}/g, ' ').trim();

    const isChildRow = (text) => /^\s*(Choice:|Add-on:)/i.test(text);

    const buildSummary = () => {
      window.quoteActiveItemIds = new Set();
      menuSummary.innerHTML = '';
      if (!sourceList) return;
      const categories = new Map();
      let currentMenu = null;

      sourceList.querySelectorAll('li').forEach((li) => {
        const id = Number(li.dataset.id);
        const raw = (li.textContent || '').trim();
        const meta = parseMeta(raw);
        const text = cleanLabel(raw);
        const price = Number(li.dataset.price || 0);

        if (!isChildRow(text)) {
          const category = meta.category || 'Uncategorised';
          if (!categories.has(category)) categories.set(category, []);
          currentMenu = {
            title: text.replace(/^Menu:\s*/i, ''),
            items: [],
            basePrice: price,
          };
          categories.get(category).push(currentMenu);
          window.quoteActiveItemIds.add(id);
          return;
        }

        if (!currentMenu) return;
        if (meta.excluded) return;
        window.quoteActiveItemIds.add(id);
        const qty = meta.qty ? Number(meta.qty) : 1;
        const priceEach =
          meta.base != null ? Number(meta.base) : qty > 0 ? price / qty : price;
        currentMenu.items.push({
          name: text.replace(/^(Choice:|Add-on:)\s*/i, '').replace(/\s+x\s+\d+.*/, '').trim(),
          qty,
          priceEach,
          total: price,
        });
      });

      if (!categories.size) {
        menuSummary.innerHTML = '<div class="alert alert-secondary mb-0">No items currently selected.</div>';
        return;
      }

      categories.forEach((menus, category) => {
        const card = document.createElement('div');
        card.className = 'proposal-summary-card';
        const header = document.createElement('div');
        header.className = 'hdr';
        header.textContent = category;
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'body';
        menus.forEach((menu) => {
          const block = document.createElement('div');
          block.className = 'menu-block';
          block.innerHTML = `<div class="menu-title">${menu.title}</div>`;
          if (menu.basePrice) {
            block.innerHTML += `<div class="menu-base">Base Price: $${Number(menu.basePrice).toFixed(2)}</div>`;
          }

          if (menu.items.length) {
            const head = document.createElement('div');
            head.className = 'menu-row head';
            head.innerHTML = '<div>Item</div><div>Qty</div><div>Each</div><div>Total</div>';
            block.appendChild(head);
            menu.items.forEach((item) => {
              const row = document.createElement('div');
              row.className = 'menu-row';
              row.innerHTML = `
                <div>${item.name}</div>
                <div>${item.qty}</div>
                <div>$${Number(item.priceEach).toFixed(2)}</div>
                <div>$${Number(item.total).toFixed(2)}</div>
              `;
              block.appendChild(row);
            });
          } else {
            block.innerHTML += '<div class="menu-empty">No optional items included.</div>';
          }
          body.appendChild(block);
        });

        card.appendChild(body);
        menuSummary.appendChild(card);
      });
    };

    const appendSection = (content = '') => {
      const item = document.createElement('li');
      item.className = 'list-group-item';
      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-semibold">Section</span>
          <button type="button" class="btn btn-sm btn-outline-danger remove-section">Remove</button>
        </div>
        <textarea class="form-control section-content" rows="4">${content}</textarea>
      `;
      sectionsList.appendChild(item);
    };

    sectionsList?.addEventListener('click', (event) => {
      if (event.target.classList.contains('remove-section')) {
        event.target.closest('li')?.remove();
        if (!sectionsList.querySelector('li')) {
          sectionsList.innerHTML = '<li class="list-group-item text-muted fst-italic border">No sections yet.</li>';
        }
      }
    });

    addTemplateBtn?.addEventListener('click', async () => {
      const templateId = templatePicker.value;
      if (!templateId) return;
      try {
        const res = await fetch(`/settings/note-templates/api/${templateId}`);
        const payload = await res.json();
        if (!payload.success) throw new Error(payload.error || 'Failed to load template');
        if (sectionsList.querySelector('.text-muted')) sectionsList.innerHTML = '';
        appendSection(payload.data?.content || '');
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to insert template.');
      }
    });

    previewBtn?.addEventListener('click', () => {
      if (!proposalId) return;
      window.open(`/functions/${functionId}/proposal/preview`, '_blank');
    });

    printBtn?.addEventListener('click', () => {
      if (!proposalId) return;
      window.open(`/functions/${functionId}/proposal/preview`, '_blank').print?.();
    });

    saveBtn?.addEventListener('click', async () => {
      const includeContacts = Array.from(includeContactInputs)
        .filter((input) => input.checked)
        .map((input) => input.value);
      const sections = Array.from(sectionsList.querySelectorAll('.section-content')).map((textarea) => ({
        content: textarea.value,
      }));
      const payload = {
        includeItemIds: Array.from(window.quoteActiveItemIds || []),
        includeContactIds: includeContacts,
        sections,
        terms: document.getElementById('termsInput')?.value || '',
      };

      saveBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${functionId}/proposal/save`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Save failed.');
        alert('Proposal settings saved.');
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to save proposal.');
      } finally {
        saveBtn.disabled = false;
      }
    });

    buildSummary();
  });
</script>

<style>
  .proposal-menu-summary {
    display: grid;
    gap: 16px;
  }
  @media (min-width: 992px) {
    .proposal-menu-summary {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  .proposal-summary-card {
    border: 1px solid #dde1e6;
    border-radius: 10px;
    overflow: hidden;
  }
  .proposal-summary-card .hdr {
    background: #f4f6fa;
    padding: 8px 12px;
    font-weight: 600;
  }
  .proposal-summary-card .body {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .proposal-summary-card .menu-title {
    font-weight: 600;
    margin-bottom: 4px;
  }
  .proposal-summary-card .menu-base {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 6px;
  }
  .proposal-summary-card .menu-row {
    display: grid;
    grid-template-columns: 1fr 50px 70px 80px;
    gap: 6px;
    font-size: 13px;
    padding: 3px 0;
    border-bottom: 1px solid #eef1f5;
  }
  .proposal-summary-card .menu-row.head {
    font-weight: 600;
    color: #6c757d;
    border-bottom: 1px solid #d9dee6;
  }
  .proposal-summary-card .menu-row:last-child {
    border-bottom: 0;
  }
  .proposal-summary-card .menu-empty {
    font-size: 12px;
    color: #999;
  }
</style>




