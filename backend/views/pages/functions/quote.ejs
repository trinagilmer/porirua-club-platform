<% locals.layout = 'layouts/main'; %>
<%
  const formatEventDate = (value) => {
    if (!value) return 'Date not set';
    try {
      return new Date(value).toLocaleDateString('en-NZ', {
        weekday: 'short',
        day: 'numeric',
        month: 'short',
        year: 'numeric',
      });
    } catch (err) {
      return 'Date not set';
    }
  };

  const formatTime = (value) => {
    if (!value) return '—';
    const parts = String(value).split(':');
    let hours = Number(parts[0]);
    const minutes = (parts[1] || '00').padStart(2, '0');
    if (!Number.isFinite(hours)) return '—';
    const suffix = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12 || 12;
    return `${hours}:${minutes} ${suffix}`;
  };

  const contacts = Array.isArray(linkedContacts) ? linkedContacts : [];
  const primaryContact =
    contacts.find((contact) => contact.is_primary) || contacts[0] || null;
  const otherContacts = primaryContact
    ? contacts.filter((contact) => contact.id !== primaryContact.id)
    : contacts;
%>

<div id="quoteToastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<style>
  .quote-actions.sticky-top { top: 70px; z-index: 9; }
  .quote-menu-base-row { background: #eef2f6 !important; }
  .quote-menu-title { font-weight: 700; font-size: 0.95rem; }
  .quote-menu-item { font-size: 0.95rem; }
</style>

<div class="function-body py-4 px-4 quote-page">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1"><%= fn.event_name || 'Untitled Function' %></h1>
      <div class="text-muted small">Quote builder • Configure menus, pricing, and proposal selections.</div>
    </div>
    <div class="btn-toolbar gap-2">
      <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newQuoteModal">
        <i class="bi bi-journal-plus me-1"></i> New Quote
      </button>
      <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addMenuModal">
        <i class="bi bi-list-plus me-1"></i> Add Menu
      </button>
    </div>
  </div>

  <div class="quote-stage">
    <section class="quote-card flex-grow-1 d-flex flex-column">
      <div id="quoteMenuMount" class="d-flex flex-column gap-3"></div>
      <% if (!proposals.length) { %>
        <div class="alert alert-secondary mt-3 mb-0">No quotes created yet. Start by adding a menu.</div>
      <% } %>
    </section>

    <section class="quote-totals">
      <div class="quote-card thin">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-semibold">Quote Totals</span>
          <div class="quote-actions d-flex gap-2 flex-wrap sticky-top bg-white border rounded p-2 shadow-sm">
            <button id="saveQuoteBtn" class="btn btn-sm btn-outline-secondary">Save</button>
            <button id="resetQuoteBtn" class="btn btn-sm btn-outline-danger">Reset</button>
            <button id="editTotalsBtn" class="btn btn-sm btn-outline-primary" <%= proposals.length ? '' : 'disabled' %>>Edit</button>
            <button id="resyncQuoteBtn" class="btn btn-sm btn-warning" <%= proposals.length ? '' : 'disabled' %>>
              Refresh from menus
            </button>
            <span class="badge bg-light text-dark text-uppercase align-self-center">
              Client: <%= clientStatus || 'draft' %>
            </span>
            <button id="sendClientLinkBtn" class="btn btn-sm btn-outline-success" <%= proposals.length ? '' : 'disabled' %>>
              Email client link
            </button>
            <button id="copyClientLinkBtn" type="button" class="btn btn-sm btn-outline-secondary" data-link="<%= clientLink || '' %>" <%= clientLink ? '' : 'disabled' %>>
              Copy client link
            </button>
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#quoteProposalBuilderCollapse" aria-expanded="false" aria-controls="quoteProposalBuilderCollapse">
              Open builder
            </button>
            <% if (proposals[0]?.client_selection) { %>
              <button id="applyClientSelectionBtn" class="btn btn-sm btn-success">
                Apply client selections
              </button>
            <% } %>
          </div>
        </div>
        <dl class="row gy-2 gx-0 small">
          <dt class="col-6">Subtotal</dt>
          <dd class="col-6 text-end" id="quoteSubtotal">$<%= Number(totals.subtotal || 0).toFixed(2) %></dd>
          <dt class="col-6">Gratuity (<span id="quoteGratuityPercent"><%= Number(totals.gratuity_percent || 0).toFixed(2) %></span>%)</dt>
          <dd class="col-6 text-end" id="quoteGratuity">$<%= Number(totals.gratuity_amount || 0).toFixed(2) %></dd>
          <dt class="col-6">Discount</dt>
          <dd class="col-6 text-end" id="quoteDiscount">$<%= Number(totals.discount_amount || 0).toFixed(2) %></dd>
          <dt class="col-6">Deposit</dt>
          <dd class="col-6 text-end" id="quoteDeposit">$<%= Number(totals.deposit_amount || 0).toFixed(2) %></dd>
          <dt class="col-6">Total Paid</dt>
          <dd class="col-6 text-end" id="quotePaid">$<%= Number(totals.total_paid || 0).toFixed(2) %></dd>
          <dt class="col-6 fw-semibold">Remaining Due</dt>
          <dd class="col-6 text-end fw-semibold" id="quoteRemaining">$<%= Number(totals.remaining_due || 0).toFixed(2) %></dd>
        </dl>
      </div>
    </section>
  </div>

    <section class="quote-card proposal-builder-wrapper" id="proposalBuilderCard">
      <div class="proposal-builder-toggle">
        <div>
          <p class="fw-semibold mb-1">Proposal Builder</p>
          <p class="text-muted small mb-0">Open the builder to choose which menus, notes, contacts, and terms flow through to the customer proposal.</p>
        </div>
      </div>
      <div class="collapse mt-3" id="quoteProposalBuilderCollapse">
        <%- include('../../partials/proposal/builder', {
          fn,
          proposalId: proposals[0]?.id || null,
        proposalItems,
        templates,
        contacts: linkedContacts || [],
        saved: proposalBuilderSaved,
        termsLibrary,
        builderHeading: 'Proposal Builder',
        builderDescription: 'Choose exactly what reaches the proposal before you preview or print it.'
      }) %>
    </div>
  </section>

  <ul id="proposalItemsList" class="d-none">
    <% (proposalItems || []).forEach(item => { %>
      <li data-id="<%= item.id %>" data-price="<%= Number(item.unit_price || 0).toFixed(2) %>" data-selectable="<%= item.client_selectable ? 'true' : 'false' %>">
        <%- String(item.description || '').replace(/\r\n|\r|\n/g, ' ') %>
      </li>
    <% }) %>
  </ul>
</div>

<!-- Send Client Email Modal -->
<div class="modal fade" id="sendClientEmailModal" tabindex="-1" aria-labelledby="sendClientEmailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="sendClientEmailForm">
        <div class="modal-header">
          <h5 class="modal-title" id="sendClientEmailModalLabel">Email client link</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Recipient</label>
            <div class="row g-2">
              <div class="col-md-6">
                <select class="form-select" id="clientEmailSelect">
                  <% if (primaryContact) { %>
                    <option value="<%= primaryContact.id %>" data-email="<%= primaryContact.email %>" data-name="<%= primaryContact.name %>">
                      <%= primaryContact.name || primaryContact.email %> (<%= primaryContact.email || 'no email' %>)
                    </option>
                  <% } %>
                  <% (otherContacts || []).forEach((c) => { %>
                    <option value="<%= c.id %>" data-email="<%= c.email %>" data-name="<%= c.name %>">
                      <%= c.name || c.email %> (<%= c.email || 'no email' %>)
                    </option>
                  <% }); %>
                  <option value="" data-email="" data-name="">Custom email…</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="email" class="form-control" id="clientEmailInput" placeholder="name@example.com">
              </div>
            </div>
            <div class="mt-2">
              <input type="text" class="form-control" id="clientNameInput" placeholder="Recipient name (optional)">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label d-flex align-items-center gap-2">Link type</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="clientLinkType" id="clientLinkTypeClient" value="client" checked>
                <label class="form-check-label" for="clientLinkTypeClient">Proposal link</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="clientLinkType" id="clientLinkTypeAccept" value="accept">
                <label class="form-check-label" for="clientLinkTypeAccept">Acceptance link</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Message (you can edit the AI draft)</label>
            <textarea class="form-control" id="clientEmailMessage" rows="5"></textarea>
            <div class="form-text">The system email is sent via Microsoft 365 and will appear in Sent Items.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="sendClientEmailSubmit">Send email</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Menu Modal -->
<div class="modal fade" id="addMenuModal" tabindex="-1" aria-labelledby="addMenuModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMenuModalLabel">Add Menu to Quote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Sales Category</label>
          <select id="quoteCategorySelect" class="form-select">
            <option value="">Select category...</option>
            <% (categories || []).forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Menu</label>
          <select id="quoteMenuSelect" class="form-select" disabled>
            <option value="">Select menu...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="d-flex gap-2">
          <button type="button" id="createMenuFromModalBtn" class="btn btn-outline-success" disabled>Create New Menu</button>
          <button type="button" id="openMenuDrawerBtn" class="btn btn-outline-secondary" disabled>Edit Menu</button>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="addMenuToQuoteBtn" class="btn btn-success" disabled>Add</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Totals offcanvas -->
<div id="totalsDrawer" class="offcanvas offcanvas-end" tabindex="-1" aria-labelledby="totalsDrawerLabel">
  <div class="offcanvas-header">
    <h5 id="totalsDrawerLabel" class="mb-0">Adjust Totals</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form id="totalsForm" data-proposal-id="<%= proposals[0]?.id || '' %>" class="vstack gap-3">
      <div>
        <label class="form-label">Subtotal</label>
        <input type="number" step="0.01" name="subtotal" class="form-control" value="<%= Number(totals.subtotal || 0).toFixed(2) %>" readonly>
        <div class="form-text">Calculated automatically based on menu selections.</div>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Gratuity %</label>
          <input type="number" step="0.01" name="gratuity_percent" class="form-control" value="<%= Number(totals.gratuity_percent || 0).toFixed(2) %>">
        </div>
        <div class="col-6">
          <label class="form-label">Discount ($)</label>
          <input type="number" step="0.01" name="discount_amount" class="form-control" value="<%= Number(totals.discount_amount || 0).toFixed(2) %>">
        </div>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Deposit ($)</label>
          <input type="number" step="0.01" name="deposit_amount" class="form-control" value="<%= Number(totals.deposit_amount || 0).toFixed(2) %>">
        </div>
        <div class="col-6">
          <label class="form-label">Override Total ($)</label>
          <input type="number" step="0.01" name="override_total" class="form-control" placeholder="Optional">
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Save Totals</button>
    </form>
  </div>
</div>

<!-- Shared Modals -->
<%- include('../../partials/functions/modals', {
  fn,
  linkedContacts: linkedContacts || [],
  rooms: rooms || [],
  eventTypes: eventTypes || []
}) %>
<%- include('../../partials/menuDrawer', { categories, units }) %>

<div class="modal fade" id="newQuoteModal" tabindex="-1" aria-labelledby="newQuoteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/functions/<%= fn.id_uuid %>/quote/new" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="newQuoteModalLabel">Create New Quote</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Link to contact (optional)</label>
          <select name="contact_id" class="form-select">
            <option value="">- None -</option>
            <% (linkedContacts || []).forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %> (<%= c.email || 'no email' %>)</option>
            <% }) %>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  window.fnContext = {
    id: "<%= fn.id_uuid %>",
    name: "<%= fn.event_name %>",
    attendees: <%= Number(fn.attendees || 0) %>,
    proposalId: <%= proposals[0]?.id ? Number(proposals[0].id) : 'null' %>
  };
  window.menuBuilderData = {
    categories: <%- JSON.stringify(categories || []) %>,
    units: <%- JSON.stringify(units || []) %>
  };
  window.quoteMenuData = {
    categories: <%- JSON.stringify(categories || []) %>,
    menus: <%- JSON.stringify(menus || []) %>
  };
</script>

<script>
  // Toast helper with brand-aligned Bootstrap styles
  const quoteToast = (message, variant = 'primary') => {
    const container = document.getElementById('quoteToastContainer');
    if (!container) return alert(message);
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
    toastEl.role = 'status';
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 3500 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  };

  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('proposalItemsList');
    const mount = document.getElementById('quoteMenuMount');
    const totalsForm = document.getElementById('totalsForm');
    const editTotalsBtn = document.getElementById('editTotalsBtn');
    const resetQuoteBtn = document.getElementById('resetQuoteBtn');
    const saveQuoteBtn = document.getElementById('saveQuoteBtn');
    const categorySelect = document.getElementById('quoteCategorySelect');
    const menuSelect = document.getElementById('quoteMenuSelect');
    const addMenuBtn = document.getElementById('addMenuToQuoteBtn');
    const openDrawerBtn = document.getElementById('openMenuDrawerBtn');
    const createMenuBtn = document.getElementById('createMenuFromModalBtn');

    const fnId = window.fnContext?.id;
    const proposalId = window.fnContext?.proposalId;
    const attendees = Number(window.fnContext?.attendees || 0);
    const fnEventName = `<%- (fn.event_name || 'your booking').replace(/\\/g, '\\\\').replace(/\"/g, '\\"').replace(/` + "`" + `/g, '\\`" + "`" + `') %>`;
    const fnEventDate = `<%- fn.event_date || '' %>`;

    window.quoteActiveItemIds = new Set();
    const itemLookup = new Map();

    const formatCurrency = (value) => `$${(Number(value) || 0).toFixed(2)}`;

    function updateModalActions() {
      const hasCategory = Boolean(categorySelect?.value);
      if (createMenuBtn) createMenuBtn.disabled = !hasCategory;
    }

    const parseMeta = (text) => {
      const meta = {};
      let match;
      const regex = /\[([a-z_]+):([^\]]+)\]/gi;
      while ((match = regex.exec(text))) {
        meta[match[1].toLowerCase()] = match[2];
      }
      const qtyMatch = text.match(/ x (\d+)/i);
      if (qtyMatch) meta.qty = Number(qtyMatch[1]);
      if (/\[excluded:true\]/i.test(text)) meta.excluded = true;
      return meta;
    };

    const cleanLabel = (text) =>
      text
        .replace(/\[[^\]]+\]/g, '')
        .replace(/\s{2,}/g, ' ')
        .trim();

    const isChildRow = (text) => /^\s*(Choice:|Add-on:)/i.test(text);

    function buildModel() {
      window.quoteActiveItemIds = new Set();
      itemLookup.clear();
      const categories = new Map();
      let currentMenu = null;

      list.querySelectorAll('li').forEach((li) => {
        const id = Number(li.dataset.id);
        const rawText = (li.textContent || '').trim();
        const meta = parseMeta(rawText);
        const price = Number(li.dataset.price || 0);
        const selectable = String(li.dataset.selectable || '').toLowerCase() === 'true';
        const text = cleanLabel(rawText);

        if (!isChildRow(text)) {
          const menuTitle = text.replace(/^Menu:\s*/i, '').trim();
          const categoryName = meta.category || 'Uncategorised';
          const baseCostValue =
            meta.cost !== undefined && meta.cost !== null
              ? Number(meta.cost)
              : null;
          const baseCost =
            baseCostValue !== null && Number.isFinite(baseCostValue)
              ? baseCostValue
              : null;
          if (!categories.has(categoryName)) categories.set(categoryName, []);
          const clientSelectableFlag = selectable || String(meta.client_selectable || "").toLowerCase() === "true";
          const clientAllowQtyFlag = String(meta.client_allow_qty || "").toLowerCase() === "true";
          currentMenu = {
            menuId: Number(meta.menu_id) || null,
            baseId: id,
            title: menuTitle,
            basePrice: price,
            baseExcluded: Boolean(meta.excluded),
            baseCost,
            clientSelectable: clientSelectableFlag,
            clientAllowQty: clientAllowQtyFlag,
            items: [],
          };
          categories.get(categoryName).push(currentMenu);
          itemLookup.set(id, {
            id,
            name: menuTitle,
            price,
            qty: 1,
            excluded: Boolean(meta.excluded),
            isBase: true,
          });
          if (!meta.excluded) window.quoteActiveItemIds.add(id);
          return;
        }

        if (!currentMenu) return;
        const unitType = meta.unit_type || '';
        const qty = meta.qty
          ? Number(meta.qty)
          : unitType === 'per_person'
          ? attendees
          : 1;
        const priceEach =
          meta.base != null ? Number(meta.base) : qty > 0 ? price / qty : price;
          const costEachMeta =
            meta.cost_each !== undefined && meta.cost_each !== null
              ? Number(meta.cost_each)
              : null;
          const costTotalMeta =
            meta.cost !== undefined && meta.cost !== null
              ? Number(meta.cost)
              : null;
          const costEach = Number.isFinite(costEachMeta)
            ? costEachMeta
            : costTotalMeta != null && Number.isFinite(costTotalMeta) && qty > 0
            ? costTotalMeta / qty
            : null;
          const costTotal =
            costEach != null && Number.isFinite(costEach) && qty > 0
              ? costEach * qty
              : Number.isFinite(costTotalMeta)
              ? costTotalMeta
              : null;
        const item = {
          id,
          name: text.replace(/^(Choice:|Add-on:)\s*/i, '').replace(/\s+x\s+\d+.*/, '').trim(),
          price,
          qty,
          unitType,
          priceEach,
          costEach: Number.isFinite(costEach) ? costEach : null,
          costTotal,
          excluded: meta.excluded || false,
          selectable,
        };
        currentMenu.items.push(item);
        if (selectable) currentMenu.clientSelectable = true;
        itemLookup.set(item.id, item);
        if (!item.excluded) window.quoteActiveItemIds.add(id);
      });

      return categories;
    }

    async function fetchTotals() {
      if (!proposalId) return;
      try {
        const res = await fetch(`/functions/${proposalId}/totals`);
        const payload = await res.json();
        if (payload.success && payload.data) {
          const t = payload.data;
          document.getElementById('quoteSubtotal').textContent = formatCurrency(t.subtotal);
          document.getElementById('quoteGratuity').textContent = formatCurrency(t.gratuity_amount);
          document.getElementById('quoteGratuityPercent').textContent = Number(t.gratuity_percent || 0).toFixed(2);
          document.getElementById('quoteDiscount').textContent = formatCurrency(t.discount_amount);
          document.getElementById('quoteDeposit').textContent = formatCurrency(t.deposit_amount);
          document.getElementById('quotePaid').textContent = formatCurrency(t.total_paid);
          document.getElementById('quoteRemaining').textContent = formatCurrency(t.remaining_due);
        }
      } catch (err) {
        console.error('Failed to refresh totals', err);
      }
    }

    async function saveLineTotal(itemId, lineTotal, include, costTotal, costEach) {
      const payload = { unit_price: lineTotal, include };
      if (costTotal !== undefined) payload.cost_total = costTotal;
      if (costEach !== undefined) payload.cost_each = costEach;
      await fetch(`/functions/proposal-items/${itemId}/price`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (proposalId) await fetchTotals();
    }

    async function saveQty(itemId, qty) {
      await fetch(`/functions/proposal-items/${itemId}/qty`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qty }),
      });
    }

    function render() {
      const categories = buildModel();
      mount.innerHTML = '';
      if (!categories.size) return;

      categories.forEach((menus, categoryName) => {
        const card = document.createElement('div');
        card.className = 'card shadow-sm';
        card.innerHTML = `
          <div class="card-header bg-light fw-semibold">${categoryName}</div>
          <div class="list-group list-group-flush"></div>
        `;
        const listGroup = card.querySelector('.list-group');

        menus.forEach((menu) => {
          const listItem = document.createElement('div');
          listItem.className = 'list-group-item';
          listItem.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm align-middle quote-table mb-0">
                <caption class="quote-menu-caption">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                    <div>
                      <div class="fw-semibold">${menu.title}</div>
                      <div class="text-muted small">Menu ID: ${menu.menuId || 'n/a'}</div>
                      <div class="d-flex flex-wrap gap-2 mt-1">
                        <span class="badge ${menu.baseExcluded ? 'bg-light text-muted border border-secondary' : 'bg-success text-white'}">${menu.baseExcluded ? 'Hidden from proposal' : 'Shown in proposal'}</span>
                        <span class="badge ${menu.clientSelectable ? 'bg-primary text-white' : 'bg-light text-muted border border-secondary'}">${menu.clientSelectable ? 'Client can choose' : 'Client view locked'}</span>
                        <span class="badge ${menu.clientAllowQty ? 'bg-info text-dark' : 'bg-light text-muted border border-secondary'}">${menu.clientAllowQty ? 'Client qty editable' : 'Client qty locked'}</span>
                      </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-secondary menu-edit" data-menu-id="${menu.menuId || ''}">Edit</button>
                      <button class="btn btn-outline-primary menu-resync" data-menu-id="${menu.menuId || ''}">Resync</button>
                      <button class="btn btn-outline-success menu-client-select" data-menu-id="${menu.menuId || ''}" data-selectable="${menu.clientSelectable ? 'true' : 'false'}">${menu.clientSelectable ? 'Client selectable' : 'Client locked'}</button>
                      <button class="btn btn-outline-dark menu-hide-proposal" data-menu-id="${menu.menuId || ''}" data-hidden="${menu.baseExcluded ? 'true' : 'false'}">${menu.baseExcluded ? 'Show in proposal' : 'Hide from proposal'}</button>
                      <button class="btn btn-outline-danger menu-remove" data-menu-id="${menu.menuId || ''}">Remove</button>
                    </div>
                  </div>
                </caption>
                  <thead class="table-light">
                    <tr>
                      <th style="width: 40px;"></th>
                      <th>Item</th>
                      <th style="width: 100px;">Qty</th>
                      <th style="width: 110px;">Price</th>
                      <th style="width: 110px;">Cost</th>
                      <th class="text-end" style="width: 120px;">Total</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr>
                    <td colspan="4" class="text-end fw-semibold">Subtotal</td>
                    <td class="text-end fw-semibold menu-subtotal" data-base="${menu.basePrice}">${formatCurrency(menu.basePrice)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;
          const tbody = listItem.querySelector('tbody');

          // Base line
          const baseRow = document.createElement('tr');
          baseRow.dataset.id = menu.baseId;
          baseRow.classList.add('table-secondary', 'quote-menu-base-row');
          baseRow.innerHTML = `
            <td class="text-center">
              <input class="form-check-input include-toggle" type="checkbox" ${menu.baseExcluded ? '' : 'checked'}>
            </td>
            <td class="quote-menu-title"><strong>${menu.title}</strong>${(menu.basePrice || 0) === 0 ? ' <span class="badge bg-light text-muted border border-secondary ms-1">Included</span>' : ''}</td>
            <td>
              <input type="number" class="form-control form-control-sm qty-input" min="1" value="1">
            </td>
            <td>
              <input type="number" class="form-control form-control-sm price-input" step="0.01" min="0" value="${(menu.basePrice || 0).toFixed(2)}">
            </td>
            <td>
              <input type="number" class="form-control form-control-sm cost-input" step="0.01" min="0" value="${Number.isFinite(menu.baseCost) && menu.baseCost !== null ? menu.baseCost.toFixed(2) : '0.00'}">
            </td>
            <td class="text-end">
              <span class="line-total">${formatCurrency(menu.basePrice || 0)}</span>
            </td>
          `;
          tbody.appendChild(baseRow);

          menu.items.forEach((item) => {
              const row = document.createElement('tr');
              row.dataset.id = item.id;
              const includeChecked = !item.excluded;
              const qtyValue = item.qty > 0 ? item.qty : item.unitType === 'per_person' ? attendees : 1;
              row.innerHTML = `
                <td class="text-center">
                  <input class="form-check-input include-toggle" type="checkbox" ${includeChecked ? 'checked' : ''}>
                </td>
                <td class="quote-menu-item">${item.name}${(item.priceEach || 0) === 0 ? ' <span class="badge bg-light text-muted border border-secondary ms-1">Included</span>' : ''}</td>
                <td>
                  <input type="number" class="form-control form-control-sm qty-input" min="1" value="${qtyValue}">
                </td>
                <td>
                  <input type="number" class="form-control form-control-sm price-input" step="0.01" min="0" value="${(item.priceEach || 0).toFixed(2)}">
              </td>
              <td>
                <input type="number" class="form-control form-control-sm cost-input" step="0.01" min="0" value="${item.costEach != null && Number.isFinite(item.costEach) ? item.costEach.toFixed(2) : '0.00'}">
              </td>
              <td class="text-end">
                <span class="line-total">${formatCurrency(includeChecked ? item.price : 0)}</span>
              </td>
            `;
            tbody.appendChild(row);
          });

          const baseTotal = menu.items
            .filter((item) => !item.excluded)
            .reduce((sum, item) => sum + Number(item.price || 0), Number(menu.basePrice || 0));
          const subtotalCell = listItem.querySelector('.menu-subtotal');
          subtotalCell.dataset.base = Number(menu.basePrice || 0).toFixed(2);
          subtotalCell.textContent = formatCurrency(baseTotal);
          listGroup.appendChild(listItem);
        });

        mount.appendChild(card);
      });
    }

    function updateMenuSubtotal(row) {
      const table = row.closest('table');
      if (!table) return;
      let subtotal = 0;
      const baseId = table.closest('.list-group-item').querySelector('.menu-subtotal');
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach((tr) => {
        const totalEl = tr.querySelector('.line-total');
        if (!totalEl) return;
        subtotal += Number(totalEl.textContent.replace(/[^0-9.-]/g, '')) || 0;
      });
      const basePrice = Number(
        baseId.dataset.base
      ) || Number(baseId.textContent.replace(/[^0-9.-]/g, '')) || 0;
      baseId.textContent = formatCurrency(subtotal + basePrice);
    }

    mount.addEventListener('change', async (event) => {
      const row = event.target.closest('tr');
      if (!row) return;
      const itemId = Number(row.dataset.id);
      if (!itemId) return;
      const item = itemLookup.get(itemId);
      const include = row.querySelector('.include-toggle').checked;
      const qtyInput = row.querySelector('.qty-input');
      const priceInput = row.querySelector('.price-input');
      const costInput = row.querySelector('.cost-input');

      let qty = Number(qtyInput.value);
      if (!Number.isFinite(qty) || qty <= 0) {
        const placeholder = Number(qtyInput.placeholder || 0);
        qty = placeholder > 0 ? placeholder : 1;
      }
      const priceEach = Number(priceInput.value || 0);
      const costEach = costInput ? Number(costInput.value || 0) : undefined;
      const total = include ? qty * priceEach : 0;
      const lineTotalEl = row.querySelector('.line-total');
      if (lineTotalEl) lineTotalEl.textContent = formatCurrency(total);

      if (item) {
        item.qty = qty;
        item.priceEach = priceEach;
        item.price = total;
        if (costInput) {
          item.costEach = Number.isFinite(costEach) ? costEach : null;
          item.costTotal = item.costEach != null ? item.costEach * qty : null;
        }
      }

      let costTotal;
      if (costInput && Number.isFinite(costEach)) {
        costTotal = include ? costEach * qty : 0;
      } else if (item && item.costEach != null && Number.isFinite(item.costEach)) {
        costTotal = include ? item.costEach * qty : 0;
      }

      if (include) {
        window.quoteActiveItemIds.add(itemId);
      } else {
        window.quoteActiveItemIds.delete(itemId);
      }

      await saveLineTotal(itemId, total, include, costTotal, costEach);
      await saveQty(itemId, qty);
      updateMenuSubtotal(row);
      await fetchTotals();
    });

    mount.addEventListener('click', async (event) => {
      const removeBtn = event.target.closest('.menu-remove');
      if (removeBtn) {
        const menuId = removeBtn.dataset.menuId;
        if (!menuId) return;
        if (!confirm('Remove this menu (and related choices) from the quote?')) return;
        try {
          const res = await fetch(`/functions/${fnId}/quote/remove-menu`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menu_id: menuId }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to remove menu');
          location.reload();
        } catch (err) {
          console.error(err);
          quoteToast(err.message || 'Failed to remove menu', 'danger');
        }
        return;
      }

      const resyncBtn = event.target.closest('.menu-resync');
      if (resyncBtn) {
        const menuId = resyncBtn.dataset.menuId;
        if (!menuId) return;
        resyncBtn.disabled = true;
        try {
          const res = await fetch(`/functions/${fnId}/quote/resync-menu`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menu_id: menuId }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to resync menu');
          location.reload();
        } catch (err) {
          console.error(err);
          quoteToast(err.message || 'Failed to resync menu', 'danger');
        } finally {
          resyncBtn.disabled = false;
        }
        return;
      }

      const editBtn = event.target.closest('.menu-edit');
      if (editBtn) {
        const menuId = editBtn.dataset.menuId;
        if (!menuId) return;
        try {
          const res = await fetch(`/settings/menus/api/${menuId}`);
          const payload = await res.json();
          if (!payload.success) throw new Error(payload.error || 'Failed to load menu.');
          const menu = payload.data;
          if (window.menuDrawerApi?.open) {
            window.menuDrawerApi.open({ mode: 'edit', menu });
          }
        } catch (err) {
          console.error(err);
          quoteToast(err.message || 'Failed to open menu drawer.', 'danger');
        }
      }
    });

    if (editTotalsBtn && totalsForm) {
      editTotalsBtn.addEventListener('click', () => {
        const drawer = new bootstrap.Offcanvas(document.getElementById('totalsDrawer'));
        drawer.show();
      });

      totalsForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(totalsForm);
        const payload = Object.fromEntries(formData.entries());
        const proposalId = totalsForm.dataset.proposalId;
        try {
          const res = await fetch(`/functions/${proposalId}/totals/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to update totals');
          await fetchTotals();
          bootstrap.Offcanvas.getInstance(document.getElementById('totalsDrawer')).hide();
        } catch (err) {
          console.error(err);
          quoteToast(err.message || 'Totals update failed.', 'danger');
        }
      });
    }

    function populateMenus() {
      updateModalActions();
      menuSelect.innerHTML = '<option value="">Select menu...</option>';
      const hasCategory = Boolean(categorySelect?.value);
      if (!hasCategory) {
        menuSelect.disabled = true;
        addMenuBtn.disabled = true;
        if (openDrawerBtn) openDrawerBtn.disabled = true;
        return;
      }
      const categoryId = Number(categorySelect.value);
      const menus = (window.quoteMenuData?.menus || []).filter((m) => Number(m.category_id) === categoryId);
      menus.forEach((m) => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = `${m.name}${m.description ? ' — ' + m.description : ''}`;
        menuSelect.appendChild(option);
      });
      menuSelect.disabled = menus.length === 0;
      addMenuBtn.disabled = menuSelect.value === '';
      if (openDrawerBtn) openDrawerBtn.disabled = menuSelect.value === '';
    }

    categorySelect?.addEventListener('change', () => {
      populateMenus();
    });

    menuSelect?.addEventListener('change', () => {
      addMenuBtn.disabled = menuSelect.value === '';
      if (openDrawerBtn) openDrawerBtn.disabled = menuSelect.value === '';
    });

    saveQuoteBtn?.addEventListener('click', () => {
      window.location.reload();
    });

    createMenuBtn?.addEventListener('click', () => {
      const categoryId = categorySelect?.value ? Number(categorySelect.value) : null;
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('addMenuModal'));
      modalInstance?.hide();
      if (window.menuDrawerApi?.open) {
        window.menuDrawerApi.open({ mode: 'create', categoryId });
      }
    });

    addMenuBtn?.addEventListener('click', async () => {
      const menuId = menuSelect.value;
      if (!menuId) return;
      addMenuBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${fnId}/quote/add-menu`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ menu_id: Number(menuId) }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to add menu.');
        const modal = bootstrap.Modal.getInstance(document.getElementById('addMenuModal'));
        modal?.hide();
        location.reload();
      } catch (err) {
        console.error(err);
        quoteToast(err.message || 'Add menu failed.', 'danger');
      } finally {
        addMenuBtn.disabled = false;
      }
    });

    openDrawerBtn?.addEventListener('click', async () => {
      const menuId = menuSelect.value;
      if (!menuId) return;
      try {
        const res = await fetch(`/settings/menus/api/${menuId}`);
        const payload = await res.json();
        if (!payload.success) throw new Error(payload.error || 'Failed to load menu.');
        const menu = payload.data;
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('addMenuModal'));
        modalInstance?.hide();
        if (window.menuDrawerApi?.open) {
          window.menuDrawerApi.open({ mode: 'edit', menu });
        }
      } catch (err) {
        console.error(err);
        quoteToast(err.message || 'Failed to open menu drawer.', 'danger');
      }
    });

    const sendClientLinkBtn = document.getElementById('sendClientLinkBtn');
    const copyClientLinkBtn = document.getElementById('copyClientLinkBtn');
    const sendClientEmailModalEl = document.getElementById('sendClientEmailModal');
    const sendClientEmailForm = document.getElementById('sendClientEmailForm');
    const clientEmailSelect = document.getElementById('clientEmailSelect');
    const clientEmailInput = document.getElementById('clientEmailInput');
    const clientNameInput = document.getElementById('clientNameInput');
    const clientEmailMessage = document.getElementById('clientEmailMessage');
    const sendClientEmailSubmit = document.getElementById('sendClientEmailSubmit');
    const applyClientSelectionBtn = document.getElementById('applyClientSelectionBtn');

    function formatEventDateForEmail(value) {
      if (!value) return '';
      try {
        return new Date(value).toLocaleDateString('en-NZ', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          year: 'numeric',
        });
      } catch (err) {
        return '';
      }
    }

    function seedEmailDraft() {
      const friendlyDate = formatEventDateForEmail(fnEventDate);
      const name = clientNameInput.value || (clientEmailSelect?.selectedOptions?.[0]?.dataset?.name || '');
      clientEmailMessage.value =
        `Hi ${name || 'there'},\n\n` +
        `Here is your proposal for ${fnEventName || 'your booking'}${friendlyDate ? ' on ' + friendlyDate : ''}. ` +
        `Please review and confirm using the link below.\n\n` +
        `If you’d like to adjust menu selections, you can do so inside the link.`;
    }

    function applySelectedContact() {
      const opt = clientEmailSelect?.selectedOptions?.[0];
      if (!opt) return;
      const email = opt.dataset.email || '';
      const name = opt.dataset.name || '';
      clientEmailInput.value = email || clientEmailInput.value;
      clientNameInput.value = name || clientNameInput.value;
    }

    sendClientLinkBtn?.addEventListener('click', () => {
      if (!fnId) return;
      applySelectedContact();
      seedEmailDraft();
      const modal = bootstrap.Modal.getOrCreateInstance(sendClientEmailModalEl);
      modal.show();
    });

    clientEmailSelect?.addEventListener('change', () => {
      applySelectedContact();
    });

    sendClientEmailForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!fnId) return;
      sendClientEmailSubmit.disabled = true;
      try {
        const linkType = (sendClientEmailForm.querySelector('input[name="clientLinkType"]:checked')?.value) || 'client';
        const payload = {
          contactId: clientEmailSelect?.value || null,
          email: clientEmailInput.value || null,
          name: clientNameInput.value || null,
          linkType,
          message: clientEmailMessage.value || null,
        };
        const res = await fetch(`/functions/${fnId}/quote/send-client-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to send email');
        quoteToast(`Email sent to ${data.sentTo || 'recipient'}. Saved to Sent Items.`, 'success');
        bootstrap.Modal.getInstance(sendClientEmailModalEl)?.hide();
      } catch (err) {
        console.error(err);
        quoteToast(err.message || 'Failed to send email.', 'danger');
      } finally {
        sendClientEmailSubmit.disabled = false;
      }
    });

    copyClientLinkBtn?.addEventListener('click', async () => {
      const link = copyClientLinkBtn.dataset.link;
      if (!link) return;
      try {
        await navigator.clipboard.writeText(link);
        quoteToast('Client link copied to clipboard.', 'success');
      } catch (err) {
        console.error(err);
      }
    });

    resetQuoteBtn?.addEventListener('click', async () => {
      if (!fnId) return;
      if (!confirm('Reset quote totals and remove all menu items?')) return;
      resetQuoteBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${fnId}/quote/reset`, {
          method: 'POST',
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to reset quote');
        location.reload();
      } catch (err) {
        console.error(err);
        quoteToast(err.message || 'Reset failed.', 'danger');
      } finally {
        resetQuoteBtn.disabled = false;
      }
    });

    const resyncQuoteBtn = document.getElementById('resyncQuoteBtn');
    resyncQuoteBtn?.addEventListener('click', async () => {
      if (!fnId) return;
      if (!confirm('Refresh prices from current menus? This will overwrite manual price edits on this quote.')) return;
      resyncQuoteBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${fnId}/quote/resync-all`, {
          method: 'POST',
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to refresh pricing');
        location.reload();
      } catch (err) {
        console.error(err);
        quoteToast(err.message || 'Refresh failed.', 'danger');
      } finally {
        resyncQuoteBtn.disabled = false;
      }
    });

    applyClientSelectionBtn?.addEventListener('click', async () => {
      if (!fnId) return;
      applyClientSelectionBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${fnId}/proposal/apply-client`, { method: 'POST' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to apply client selections');
        quoteToast('Client selections applied to quote.', 'success');
        setTimeout(() => window.location.reload(), 500);
      } catch (err) {
        console.error(err);
        quoteToast(err.message || 'Failed to apply client selections.', 'danger');
      } finally {
        applyClientSelectionBtn.disabled = false;
      }
    });

    mount.addEventListener('click', async (event) => {
      const clientSelectBtn = event.target.closest('.menu-client-select');
      if (clientSelectBtn) {
        const menuId = clientSelectBtn.dataset.menuId;
        if (!menuId) return;
        const currentlySelectable = clientSelectBtn.dataset.selectable === 'true';
        const desiredFlag = !currentlySelectable;
        clientSelectBtn.disabled = true;
        try {
          const res = await fetch(`/functions/${fnId}/quote/menu/client-toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menu_id: menuId, selectable: desiredFlag }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to mark menu client-selectable');
          clientSelectBtn.dataset.selectable = desiredFlag ? 'true' : 'false';
          clientSelectBtn.textContent = desiredFlag ? 'Client selectable' : 'Client locked';
          const badges = clientSelectBtn.closest('caption')?.querySelectorAll('.badge');
          if (badges && badges[1]) {
            badges[1].className = desiredFlag ? 'badge bg-primary text-white' : 'badge bg-light text-muted border border-secondary';
            badges[1].textContent = desiredFlag ? 'Client can choose' : 'Client view locked';
          }
          quoteToast(desiredFlag ? 'Menu marked client-selectable.' : 'Client selection disabled for this menu.', desiredFlag ? 'primary' : 'secondary');
        } catch (err) {
          console.error(err);
          quoteToast(err.message || 'Failed to update client flag.', 'danger');
        } finally {
          clientSelectBtn.disabled = false;
        }
        return;
      }

      const hideBtn = event.target.closest('.menu-hide-proposal');
      if (hideBtn) {
        const menuId = hideBtn.dataset.menuId;
        if (!menuId) return;
        const currentlyHidden = hideBtn.dataset.hidden === 'true';
        const desiredHide = !currentlyHidden;
        hideBtn.disabled = true;
        try {
          const res = await fetch(`/functions/${fnId}/quote/menu/proposal-toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menu_id: menuId, hide: desiredHide }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to update proposal visibility');
          hideBtn.dataset.hidden = desiredHide ? 'true' : 'false';
          hideBtn.textContent = desiredHide ? 'Show in proposal' : 'Hide from proposal';
          const caption = hideBtn.closest('caption');
          const badge = caption?.querySelector('.badge');
          if (badge) {
            if (desiredHide) {
              badge.className = 'badge bg-light text-muted border border-secondary';
              badge.textContent = 'Hidden from proposal';
            } else {
              badge.className = 'badge bg-success text-white';
              badge.textContent = 'Shown in proposal';
            }
          }
          quoteToast(desiredHide ? 'Menu hidden from proposal.' : 'Menu shown in proposal.', desiredHide ? 'secondary' : 'success');
        } catch (err) {
          console.error(err);
          quoteToast(err.message || 'Failed to update proposal visibility.', 'danger');
        } finally {
          hideBtn.disabled = false;
        }
        return;
      }
    }, true);

    updateModalActions();
    populateMenus();
    if (list) render();
    if (proposalId) fetchTotals();
  });
</script>

