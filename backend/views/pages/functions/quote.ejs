<% locals.layout = 'layouts/main'; %>
<%
  const formatEventDate = (value) => {
    if (!value) return 'Date not set';
    try {
      return new Date(value).toLocaleDateString('en-NZ', {
        weekday: 'short',
        day: 'numeric',
        month: 'short',
        year: 'numeric',
      });
    } catch (err) {
      return 'Date not set';
    }
  };

  const formatTime = (value) => {
    if (!value) return '—';
    const parts = String(value).split(':');
    let hours = Number(parts[0]);
    const minutes = (parts[1] || '00').padStart(2, '0');
    if (!Number.isFinite(hours)) return '—';
    const suffix = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12 || 12;
    return `${hours}:${minutes} ${suffix}`;
  };

  const contacts = Array.isArray(linkedContacts) ? linkedContacts : [];
  const primaryContact =
    contacts.find((contact) => contact.is_primary) || contacts[0] || null;
  const otherContacts = primaryContact
    ? contacts.filter((contact) => contact.id !== primaryContact.id)
    : contacts;
%>

<div class="function-body py-4 px-4 quote-page">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1"><%= fn.event_name || 'Untitled Function' %></h1>
      <div class="text-muted small">Quote builder • Configure menus, pricing, and proposal selections.</div>
    </div>
    <div class="btn-toolbar gap-2">
      <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newQuoteModal">
        <i class="bi bi-journal-plus me-1"></i> New Quote
      </button>
      <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addMenuModal">
        <i class="bi bi-list-plus me-1"></i> Add Menu
      </button>
    </div>
  </div>

  <div class="row g-3 mb-4 quote-info-grid">
    <div class="col-lg-6">
      <div class="quote-info-card h-100">
        <div class="quote-info-title">Schedule & contacts</div>
        <table class="table table-sm mb-0 quote-info-table">
          <tbody>
            <tr>
              <th scope="row">Event date</th>
              <td><%= formatEventDate(fn.event_date) %></td>
            </tr>
            <tr>
              <th scope="row">Primary contact</th>
              <td>
                <% if (primaryContact) { %>
                  <div class="fw-semibold"><%= primaryContact.name %></div>
                  <div class="text-muted"><%= primaryContact.email || 'No email' %></div>
                  <div class="text-muted"><%= primaryContact.phone || 'No phone' %></div>
                <% } else { %>
                  <span class="text-muted">No contact linked</span>
                <% } %>
              </td>
            </tr>
            <tr>
              <th scope="row">Additional contacts</th>
              <td>
                <% if (otherContacts && otherContacts.length) { %>
                  <% otherContacts.forEach((contact, index) => { %>
                    <span><%= contact.name %></span><%= index < otherContacts.length - 1 ? ', ' : '' %>
                  <% }) %>
                <% } else { %>
                  <span class="text-muted">None</span>
                <% } %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="quote-info-card h-100">
        <div class="quote-info-title">Function details</div>
        <table class="table table-sm mb-0 quote-info-table">
          <tbody>
            <tr>
              <th scope="row">Event type</th>
              <td><%= fn.event_type || 'Not set' %></td>
            </tr>
            <tr>
              <th scope="row">Attendees</th>
              <td><%= Number.isFinite(Number(fn.attendees)) ? Number(fn.attendees) : 'Not set' %></td>
            </tr>
            <tr>
              <th scope="row">Start time</th>
              <td><%= formatTime(fn.start_time) %></td>
            </tr>
            <tr>
              <th scope="row">End time</th>
              <td><%= formatTime(fn.end_time) %></td>
            </tr>
            <tr>
              <th scope="row">Room</th>
              <td><%= fn.room_name || 'Not assigned' %></td>
            </tr>
            <tr>
              <th scope="row">Status</th>
              <td><span class="badge bg-light text-dark text-uppercase fw-semibold"><%= fn.status || 'Draft' %></span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="quote-stage">
    <section class="quote-card flex-grow-1 d-flex flex-column">
      <div id="quoteMenuMount" class="d-flex flex-column gap-3"></div>
      <% if (!proposals.length) { %>
        <div class="alert alert-secondary mt-3 mb-0">No quotes created yet. Start by adding a menu.</div>
      <% } %>
    </section>

    <section class="quote-totals">
      <div class="quote-card thin">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-semibold">Quote Totals</span>
          <div class="quote-actions d-flex gap-2 flex-wrap">
            <button id="saveQuoteBtn" class="btn btn-sm btn-outline-secondary">Save</button>
            <button id="resetQuoteBtn" class="btn btn-sm btn-outline-danger">Reset</button>
            <button id="editTotalsBtn" class="btn btn-sm btn-outline-primary" <%= proposals.length ? '' : 'disabled' %>>Edit</button>
          </div>
        </div>
        <dl class="row gy-2 gx-0 small">
          <dt class="col-6">Subtotal</dt>
          <dd class="col-6 text-end" id="quoteSubtotal">$<%= Number(totals.subtotal || 0).toFixed(2) %></dd>
          <dt class="col-6">Gratuity (<span id="quoteGratuityPercent"><%= Number(totals.gratuity_percent || 0).toFixed(2) %></span>%)</dt>
          <dd class="col-6 text-end" id="quoteGratuity">$<%= Number(totals.gratuity_amount || 0).toFixed(2) %></dd>
          <dt class="col-6">Discount</dt>
          <dd class="col-6 text-end" id="quoteDiscount">$<%= Number(totals.discount_amount || 0).toFixed(2) %></dd>
          <dt class="col-6">Deposit</dt>
          <dd class="col-6 text-end" id="quoteDeposit">$<%= Number(totals.deposit_amount || 0).toFixed(2) %></dd>
          <dt class="col-6">Total Paid</dt>
          <dd class="col-6 text-end" id="quotePaid">$<%= Number(totals.total_paid || 0).toFixed(2) %></dd>
          <dt class="col-6 fw-semibold">Remaining Due</dt>
          <dd class="col-6 text-end fw-semibold" id="quoteRemaining">$<%= Number(totals.remaining_due || 0).toFixed(2) %></dd>
        </dl>
      </div>
    </section>
  </div>

  <section class="quote-card proposal-builder-wrapper" id="proposalBuilderCard">
    <div class="proposal-builder-toggle">
      <div>
        <p class="fw-semibold mb-1">Proposal Builder</p>
        <p class="text-muted small mb-0">Open the builder to choose which menus, notes, contacts, and terms flow through to the customer proposal.</p>
      </div>
      <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#quoteProposalBuilderCollapse" aria-expanded="false" aria-controls="quoteProposalBuilderCollapse">
        <i class="bi bi-layout-text-window-reverse me-1"></i> Toggle Builder
      </button>
    </div>
    <div class="collapse mt-3" id="quoteProposalBuilderCollapse">
      <%- include('../../partials/proposal/builder', {
        fn,
        proposalId: proposals[0]?.id || null,
        proposalItems,
        templates,
        contacts: linkedContacts || [],
        saved: proposalBuilderSaved,
        termsLibrary,
        builderHeading: 'Proposal Builder',
        builderDescription: 'Choose exactly what reaches the proposal before you preview or print it.'
      }) %>
    </div>
  </section>

  <ul id="proposalItemsList" class="d-none">
    <% (proposalItems || []).forEach(item => { %>
      <li data-id="<%= item.id %>" data-price="<%= Number(item.unit_price || 0).toFixed(2) %>">
        <%- String(item.description || '').replace(/\r\n|\r|\n/g, ' ') %>
      </li>
    <% }) %>
  </ul>
</div>

<!-- Add Menu Modal -->
<div class="modal fade" id="addMenuModal" tabindex="-1" aria-labelledby="addMenuModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMenuModalLabel">Add Menu to Quote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Sales Category</label>
          <select id="quoteCategorySelect" class="form-select">
            <option value="">Select category...</option>
            <% (categories || []).forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Menu</label>
          <select id="quoteMenuSelect" class="form-select" disabled>
            <option value="">Select menu...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="d-flex gap-2">
          <button type="button" id="createMenuFromModalBtn" class="btn btn-outline-success" disabled>Create New Menu</button>
          <button type="button" id="openMenuDrawerBtn" class="btn btn-outline-secondary" disabled>Edit Menu</button>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="addMenuToQuoteBtn" class="btn btn-success" disabled>Add</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Totals offcanvas -->
<div id="totalsDrawer" class="offcanvas offcanvas-end" tabindex="-1" aria-labelledby="totalsDrawerLabel">
  <div class="offcanvas-header">
    <h5 id="totalsDrawerLabel" class="mb-0">Adjust Totals</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form id="totalsForm" data-proposal-id="<%= proposals[0]?.id || '' %>" class="vstack gap-3">
      <div>
        <label class="form-label">Subtotal</label>
        <input type="number" step="0.01" name="subtotal" class="form-control" value="<%= Number(totals.subtotal || 0).toFixed(2) %>" readonly>
        <div class="form-text">Calculated automatically based on menu selections.</div>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Gratuity %</label>
          <input type="number" step="0.01" name="gratuity_percent" class="form-control" value="<%= Number(totals.gratuity_percent || 0).toFixed(2) %>">
        </div>
        <div class="col-6">
          <label class="form-label">Discount ($)</label>
          <input type="number" step="0.01" name="discount_amount" class="form-control" value="<%= Number(totals.discount_amount || 0).toFixed(2) %>">
        </div>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Deposit ($)</label>
          <input type="number" step="0.01" name="deposit_amount" class="form-control" value="<%= Number(totals.deposit_amount || 0).toFixed(2) %>">
        </div>
        <div class="col-6">
          <label class="form-label">Override Total ($)</label>
          <input type="number" step="0.01" name="override_total" class="form-control" placeholder="Optional">
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Save Totals</button>
    </form>
  </div>
</div>

<!-- Shared Modals -->
<%- include('../../partials/functions/modals', {
  fn,
  linkedContacts: linkedContacts || [],
  rooms: rooms || [],
  eventTypes: eventTypes || []
}) %>
<%- include('../../partials/menuDrawer', { categories, units }) %>

<div class="modal fade" id="newQuoteModal" tabindex="-1" aria-labelledby="newQuoteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/functions/<%= fn.id_uuid %>/quote/new" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="newQuoteModalLabel">Create New Quote</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Link to contact (optional)</label>
          <select name="contact_id" class="form-select">
            <option value="">- None -</option>
            <% (linkedContacts || []).forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %> (<%= c.email || 'no email' %>)</option>
            <% }) %>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  window.fnContext = {
    id: "<%= fn.id_uuid %>",
    name: "<%= fn.event_name %>",
    attendees: <%= Number(fn.attendees || 0) %>,
    proposalId: <%= proposals[0]?.id ? Number(proposals[0].id) : 'null' %>
  };
  window.menuBuilderData = {
    categories: <%- JSON.stringify(categories || []) %>,
    units: <%- JSON.stringify(units || []) %>
  };
  window.quoteMenuData = {
    categories: <%- JSON.stringify(categories || []) %>,
    menus: <%- JSON.stringify(menus || []) %>
  };
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('proposalItemsList');
    const mount = document.getElementById('quoteMenuMount');
    const totalsForm = document.getElementById('totalsForm');
    const editTotalsBtn = document.getElementById('editTotalsBtn');
    const resetQuoteBtn = document.getElementById('resetQuoteBtn');
    const saveQuoteBtn = document.getElementById('saveQuoteBtn');
    const categorySelect = document.getElementById('quoteCategorySelect');
    const menuSelect = document.getElementById('quoteMenuSelect');
    const addMenuBtn = document.getElementById('addMenuToQuoteBtn');
    const openDrawerBtn = document.getElementById('openMenuDrawerBtn');
    const createMenuBtn = document.getElementById('createMenuFromModalBtn');

    const fnId = window.fnContext?.id;
    const proposalId = window.fnContext?.proposalId;
    const attendees = Number(window.fnContext?.attendees || 0);

    window.quoteActiveItemIds = new Set();
    const itemLookup = new Map();

    const formatCurrency = (value) => `$${(Number(value) || 0).toFixed(2)}`;

    function updateModalActions() {
      const hasCategory = Boolean(categorySelect?.value);
      if (createMenuBtn) createMenuBtn.disabled = !hasCategory;
    }

    const parseMeta = (text) => {
      const meta = {};
      let match;
      const regex = /\[([a-z_]+):([^\]]+)\]/gi;
      while ((match = regex.exec(text))) {
        meta[match[1].toLowerCase()] = match[2];
      }
      const qtyMatch = text.match(/ x (\d+)/i);
      if (qtyMatch) meta.qty = Number(qtyMatch[1]);
      if (/\[excluded:true\]/i.test(text)) meta.excluded = true;
      return meta;
    };

    const cleanLabel = (text) =>
      text
        .replace(/\[[^\]]+\]/g, '')
        .replace(/\s{2,}/g, ' ')
        .trim();

    const isChildRow = (text) => /^\s*(Choice:|Add-on:)/i.test(text);

    function buildModel() {
      window.quoteActiveItemIds = new Set();
      itemLookup.clear();
      const categories = new Map();
      let currentMenu = null;

      list.querySelectorAll('li').forEach((li) => {
        const id = Number(li.dataset.id);
        const rawText = (li.textContent || '').trim();
        const meta = parseMeta(rawText);
        const price = Number(li.dataset.price || 0);
        const text = cleanLabel(rawText);

        if (!isChildRow(text)) {
          const menuTitle = text.replace(/^Menu:\s*/i, '').trim();
          const categoryName = meta.category || 'Uncategorised';
          const baseCostValue =
            meta.cost !== undefined && meta.cost !== null
              ? Number(meta.cost)
              : null;
          const baseCost =
            baseCostValue !== null && Number.isFinite(baseCostValue)
              ? baseCostValue
              : null;
          if (!categories.has(categoryName)) categories.set(categoryName, []);
          currentMenu = {
            menuId: Number(meta.menu_id) || null,
            baseId: id,
            title: menuTitle,
            basePrice: price,
            baseCost,
            items: [],
          };
          categories.get(categoryName).push(currentMenu);
          if (!meta.excluded) window.quoteActiveItemIds.add(id);
          return;
        }

        if (!currentMenu) return;
        const unitType = meta.unit_type || '';
        const qty = meta.qty
          ? Number(meta.qty)
          : unitType === 'per_person'
          ? attendees
          : 1;
        const priceEach =
          meta.base != null ? Number(meta.base) : qty > 0 ? price / qty : price;
        const rawCost =
          meta.cost !== undefined && meta.cost !== null
            ? Number(meta.cost)
            : null;
        const costTotal =
          rawCost !== null && Number.isFinite(rawCost) ? rawCost : null;
        const costEach =
          costTotal != null && qty > 0 ? costTotal / qty : costTotal;
        const item = {
          id,
          name: text.replace(/^(Choice:|Add-on:)\s*/i, '').replace(/\s+x\s+\d+.*/, '').trim(),
          price,
          qty,
          unitType,
          priceEach,
          costEach: Number.isFinite(costEach) ? costEach : null,
          costTotal,
          excluded: meta.excluded || false,
        };
        currentMenu.items.push(item);
        itemLookup.set(item.id, item);
        if (!item.excluded && price > 0) window.quoteActiveItemIds.add(id);
      });

      return categories;
    }

    async function fetchTotals() {
      if (!proposalId) return;
      try {
        const res = await fetch(`/functions/${proposalId}/totals`);
        const payload = await res.json();
        if (payload.success && payload.data) {
          const t = payload.data;
          document.getElementById('quoteSubtotal').textContent = formatCurrency(t.subtotal);
          document.getElementById('quoteGratuity').textContent = formatCurrency(t.gratuity_amount);
          document.getElementById('quoteGratuityPercent').textContent = Number(t.gratuity_percent || 0).toFixed(2);
          document.getElementById('quoteDiscount').textContent = formatCurrency(t.discount_amount);
          document.getElementById('quoteDeposit').textContent = formatCurrency(t.deposit_amount);
          document.getElementById('quotePaid').textContent = formatCurrency(t.total_paid);
          document.getElementById('quoteRemaining').textContent = formatCurrency(t.remaining_due);
        }
      } catch (err) {
        console.error('Failed to refresh totals', err);
      }
    }

    async function saveLineTotal(itemId, total, include, costTotal) {
      const payload = { unit_price: total, include };
      if (costTotal !== undefined) payload.cost_total = costTotal;
      await fetch(`/functions/proposal-items/${itemId}/price`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (proposalId) await fetchTotals();
    }

    async function saveQty(itemId, qty) {
      await fetch(`/functions/proposal-items/${itemId}/qty`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qty }),
      });
    }

    function render() {
      const categories = buildModel();
      mount.innerHTML = '';
      if (!categories.size) return;

      categories.forEach((menus, categoryName) => {
        const card = document.createElement('div');
        card.className = 'card shadow-sm';
        card.innerHTML = `
          <div class="card-header bg-light fw-semibold">${categoryName}</div>
          <div class="list-group list-group-flush"></div>
        `;
        const listGroup = card.querySelector('.list-group');

        menus.forEach((menu) => {
          const listItem = document.createElement('div');
          listItem.className = 'list-group-item';
          listItem.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm align-middle quote-table mb-0">
                <caption class="quote-menu-caption">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                    <div>
                      <div class="fw-semibold">${menu.title}</div>
                      <div class="text-muted small">Menu ID: ${menu.menuId || 'n/a'}</div>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-secondary menu-edit" data-menu-id="${menu.menuId || ''}">Edit</button>
                      <button class="btn btn-outline-primary menu-resync" data-menu-id="${menu.menuId || ''}">Resync</button>
                      <button class="btn btn-outline-danger menu-remove" data-menu-id="${menu.menuId || ''}">Remove</button>
                    </div>
                  </div>
                </caption>
                <thead class="table-light">
                  <tr>
                    <th style="width: 40px;"></th>
                    <th>Item</th>
                    <th style="width: 100px;">Qty</th>
                    <th style="width: 110px;">Price</th>
                    <th class="text-end" style="width: 120px;">Total</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-end fw-semibold">Subtotal</td>
                    <td class="text-end fw-semibold menu-subtotal" data-base="${menu.basePrice}">${formatCurrency(menu.basePrice)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;
          const tbody = listItem.querySelector('tbody');

          menu.items.forEach((item) => {
            const row = document.createElement('tr');
            row.dataset.id = item.id;
            const includeChecked = !item.excluded && item.price > 0;
            const qtyValue = item.qty > 0 ? item.qty : item.unitType === 'per_person' ? attendees : 1;
            row.innerHTML = `
              <td class="text-center">
                <input class="form-check-input include-toggle" type="checkbox" ${includeChecked ? 'checked' : ''}>
              </td>
              <td>${item.name}</td>
              <td>
                <input type="number" class="form-control form-control-sm qty-input" min="1" value="${qtyValue}">
              </td>
              <td>
                <input type="number" class="form-control form-control-sm price-input" step="0.01" min="0" value="${(item.priceEach || 0).toFixed(2)}">
              </td>
              <td class="text-end">
                <span class="line-total">${formatCurrency(includeChecked ? item.price : 0)}</span>
              </td>
            `;
            tbody.appendChild(row);
          });

          const baseTotal = menu.items
            .filter((item) => !item.excluded)
            .reduce((sum, item) => sum + Number(item.price || 0), Number(menu.basePrice || 0));
          const subtotalCell = listItem.querySelector('.menu-subtotal');
          subtotalCell.dataset.base = Number(menu.basePrice || 0).toFixed(2);
          subtotalCell.textContent = formatCurrency(baseTotal);
          listGroup.appendChild(listItem);
        });

        mount.appendChild(card);
      });
    }

    function updateMenuSubtotal(row) {
      const table = row.closest('table');
      if (!table) return;
      let subtotal = 0;
      const baseId = table.closest('.list-group-item').querySelector('.menu-subtotal');
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach((tr) => {
        const totalEl = tr.querySelector('.line-total');
        if (!totalEl) return;
        subtotal += Number(totalEl.textContent.replace(/[^0-9.-]/g, '')) || 0;
      });
      const basePrice = Number(
        baseId.dataset.base
      ) || Number(baseId.textContent.replace(/[^0-9.-]/g, '')) || 0;
      baseId.textContent = formatCurrency(subtotal + basePrice);
    }

    mount.addEventListener('change', async (event) => {
      const row = event.target.closest('tr');
      if (!row) return;
      const itemId = Number(row.dataset.id);
      if (!itemId) return;
      const item = itemLookup.get(itemId);
      const include = row.querySelector('.include-toggle').checked;
      const qtyInput = row.querySelector('.qty-input');
      const priceInput = row.querySelector('.price-input');

      let qty = Number(qtyInput.value);
      if (!Number.isFinite(qty) || qty <= 0) {
        const placeholder = Number(qtyInput.placeholder || 0);
        qty = placeholder > 0 ? placeholder : 1;
      }
      const priceEach = Number(priceInput.value || 0);
      const total = include ? qty * priceEach : 0;
      const lineTotalEl = row.querySelector('.line-total');
      if (lineTotalEl) lineTotalEl.textContent = formatCurrency(total);

      if (item) {
        item.qty = qty;
        item.priceEach = priceEach;
      }

      let costTotal;
      if (item && item.costEach != null && Number.isFinite(item.costEach)) {
        costTotal = include ? item.costEach * qty : 0;
      }
      if (item && costTotal !== undefined) {
        item.costTotal = costTotal;
      }

      if (include) {
        window.quoteActiveItemIds.add(itemId);
      } else {
        window.quoteActiveItemIds.delete(itemId);
      }

      await saveLineTotal(itemId, total, include, costTotal);
      await saveQty(itemId, qty);
      updateMenuSubtotal(row);
    });

    mount.addEventListener('click', async (event) => {
      const removeBtn = event.target.closest('.menu-remove');
      if (removeBtn) {
        const menuId = removeBtn.dataset.menuId;
        if (!menuId) return;
        if (!confirm('Remove this menu (and related choices) from the quote?')) return;
        try {
          const res = await fetch(`/functions/${fnId}/quote/remove-menu`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menu_id: menuId }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to remove menu');
          location.reload();
        } catch (err) {
          console.error(err);
          alert(err.message || 'Failed to remove menu');
        }
        return;
      }

      const resyncBtn = event.target.closest('.menu-resync');
      if (resyncBtn) {
        const menuId = resyncBtn.dataset.menuId;
        if (!menuId) return;
        resyncBtn.disabled = true;
        try {
          const res = await fetch(`/functions/${fnId}/quote/resync-menu`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menu_id: menuId }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to resync menu');
          location.reload();
        } catch (err) {
          console.error(err);
          alert(err.message || 'Failed to resync menu');
        } finally {
          resyncBtn.disabled = false;
        }
        return;
      }

      const editBtn = event.target.closest('.menu-edit');
      if (editBtn) {
        const menuId = editBtn.dataset.menuId;
        if (!menuId) return;
        try {
          const res = await fetch(`/settings/menus/api/${menuId}`);
          const payload = await res.json();
          if (!payload.success) throw new Error(payload.error || 'Failed to load menu.');
          const menu = payload.data;
          if (window.menuDrawerApi?.open) {
            window.menuDrawerApi.open({ mode: 'edit', menu });
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'Failed to open menu drawer.');
        }
      }
    });

    if (editTotalsBtn && totalsForm) {
      editTotalsBtn.addEventListener('click', () => {
        const drawer = new bootstrap.Offcanvas(document.getElementById('totalsDrawer'));
        drawer.show();
      });

      totalsForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(totalsForm);
        const payload = Object.fromEntries(formData.entries());
        const proposalId = totalsForm.dataset.proposalId;
        try {
          const res = await fetch(`/functions/${proposalId}/totals/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Failed to update totals');
          await fetchTotals();
          bootstrap.Offcanvas.getInstance(document.getElementById('totalsDrawer')).hide();
        } catch (err) {
          console.error(err);
          alert(err.message || 'Totals update failed.');
        }
      });
    }

    function populateMenus() {
      updateModalActions();
      menuSelect.innerHTML = '<option value="">Select menu...</option>';
      const hasCategory = Boolean(categorySelect?.value);
      if (!hasCategory) {
        menuSelect.disabled = true;
        addMenuBtn.disabled = true;
        if (openDrawerBtn) openDrawerBtn.disabled = true;
        return;
      }
      const categoryId = Number(categorySelect.value);
      const menus = (window.quoteMenuData?.menus || []).filter((m) => Number(m.category_id) === categoryId);
      menus.forEach((m) => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = `${m.name}${m.description ? ' — ' + m.description : ''}`;
        menuSelect.appendChild(option);
      });
      menuSelect.disabled = menus.length === 0;
      addMenuBtn.disabled = menuSelect.value === '';
      if (openDrawerBtn) openDrawerBtn.disabled = menuSelect.value === '';
    }

    categorySelect?.addEventListener('change', () => {
      populateMenus();
    });

    menuSelect?.addEventListener('change', () => {
      addMenuBtn.disabled = menuSelect.value === '';
      if (openDrawerBtn) openDrawerBtn.disabled = menuSelect.value === '';
    });

    saveQuoteBtn?.addEventListener('click', () => {
      window.location.reload();
    });

    createMenuBtn?.addEventListener('click', () => {
      const categoryId = categorySelect?.value ? Number(categorySelect.value) : null;
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('addMenuModal'));
      modalInstance?.hide();
      if (window.menuDrawerApi?.open) {
        window.menuDrawerApi.open({ mode: 'create', categoryId });
      }
    });

    addMenuBtn?.addEventListener('click', async () => {
      const menuId = menuSelect.value;
      if (!menuId) return;
      addMenuBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${fnId}/quote/add-menu`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ menu_id: Number(menuId) }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to add menu.');
        const modal = bootstrap.Modal.getInstance(document.getElementById('addMenuModal'));
        modal?.hide();
        location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Add menu failed.');
      } finally {
        addMenuBtn.disabled = false;
      }
    });

    openDrawerBtn?.addEventListener('click', async () => {
      const menuId = menuSelect.value;
      if (!menuId) return;
      try {
        const res = await fetch(`/settings/menus/api/${menuId}`);
        const payload = await res.json();
        if (!payload.success) throw new Error(payload.error || 'Failed to load menu.');
        const menu = payload.data;
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('addMenuModal'));
        modalInstance?.hide();
        if (window.menuDrawerApi?.open) {
          window.menuDrawerApi.open({ mode: 'edit', menu });
        }
      } catch (err) {
        console.error(err);
        alert(err.message || 'Failed to open menu drawer.');
      }
    });

    resetQuoteBtn?.addEventListener('click', async () => {
      if (!fnId) return;
      if (!confirm('Reset quote totals and remove all menu items?')) return;
      resetQuoteBtn.disabled = true;
      try {
        const res = await fetch(`/functions/${fnId}/quote/reset`, {
          method: 'POST',
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to reset quote');
        location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Reset failed.');
      } finally {
        resetQuoteBtn.disabled = false;
      }
    });

    updateModalActions();
    populateMenus();
    if (list) render();
    if (proposalId) fetchTotals();
  });
</script>

