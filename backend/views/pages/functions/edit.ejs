<!-- üõ†Ô∏è pages/functions/edit.ejs -->
<% locals.layout = 'layouts/main'; %>


    <!-- üîπ Body -->
    <div class="function-body py-4 px-4">

      <!-- üßæ Edit Form -->
      <form method="POST" action="/functions/<%= fn.id_uuid %>/edit" class="card p-4 shadow-sm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Event Name</label>
            <input type="text" name="event_name" class="form-control" value="<%= fn.event_name || '' %>" required />
          </div>

          <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" name="event_date" class="form-control"
                   value="<%= fn.event_date ? fn.event_date.toISOString().slice(0,10) : '' %>" />
          </div>

          <div class="col-md-3">
            <label class="form-label">End date</label>
            <input type="date" name="end_date" class="form-control"
                   value="<%= fn.end_date ? fn.end_date.toISOString().slice(0,10) : '' %>" />
          </div>

          <div class="col-md-3">
            <label class="form-label">Start Time</label>
            <input type="time" name="start_time" class="form-control" value="<%= fn.start_time || '' %>" />
          </div>

          <div class="col-md-3">
            <label class="form-label">End Time</label>
            <input type="time" name="end_time" class="form-control" value="<%= fn.end_time || '' %>" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Attendees</label>
            <input type="number" name="attendees" class="form-control" value="<%= fn.attendees || '' %>" />
          </div>

          <div class="col-md-6">
            <label class="form-label">Budget ($)</label>
            <input type="number" step="0.01" name="budget" class="form-control" value="<%= fn.budget || '' %>" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Total Price</label>
            <input type="number" step="0.01" name="totals_price" class="form-control" value="<%= fn.totals_price || 0 %>" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Total Cost</label>
            <input type="number" step="0.01" name="totals_cost" class="form-control" value="<%= fn.totals_cost || 0 %>" />
          </div>

          <div class="col-md-6">
            <label class="form-label">Room / Space</label>
            <select name="room_id" class="form-select">
              <option value="">Select a room</option>
              <% rooms.forEach(r => { %>
                <option value="<%= r.id %>" <%= fn.room_id === r.id ? 'selected' : '' %>>
                  <%= r.name %> (<%= r.capacity %> ppl)
                </option>
              <% }) %>
            </select>
          </div>

          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <label class="form-label mb-0">Room allocations</label>
                <p class="text-muted small mb-0">
                  Add rooms and optional time windows. Leave blank to use the primary room for the whole function.
                </p>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="addAllocationRow">
                + Add room allocation
              </button>
            </div>
            <div class="alert alert-danger mt-3 d-none" id="allocationError" role="alert"></div>
            <div id="allocationRows" class="mt-3 d-grid gap-3">
              <% const allocations = Array.isArray(roomAllocations) ? roomAllocations : []; %>
              <% const toInputDate = (value) => {
                   if (!value) return '';
                   const d = value instanceof Date ? value : new Date(value);
                   if (isNaN(d.getTime())) return '';
                   const tzOffset = d.getTimezoneOffset() * 60000;
                   const local = new Date(d.getTime() - tzOffset);
                   return local.toISOString().slice(0, 10);
                 };
              %>
              <% const toInputTime = (value) => {
                   if (!value) return '';
                   const d = value instanceof Date ? value : new Date(value);
                   if (isNaN(d.getTime())) return '';
                   const tzOffset = d.getTimezoneOffset() * 60000;
                   const local = new Date(d.getTime() - tzOffset);
                   return local.toISOString().slice(11, 16);
                 };
              %>
              <% allocations.forEach(function(a) { %>
                <div class="border rounded-3 p-3 allocation-row">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label small">Room</label>
                      <select name="allocation_room_id" class="form-select">
                        <option value="">Select room</option>
                        <% rooms.forEach(r => { %>
                          <option value="<%= r.id %>" <%= String(a.room_id) === String(r.id) ? 'selected' : '' %>>
                            <%= r.name %>
                          </option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Start date</label>
                      <input type="date" name="allocation_start_date" class="form-control" value="<%= toInputDate(a.start_at) %>">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">Start time</label>
                      <input type="time" name="allocation_start_time" class="form-control" value="<%= toInputTime(a.start_at) %>">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">End date</label>
                      <input type="date" name="allocation_end_date" class="form-control" value="<%= toInputDate(a.end_at) %>">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small">End time</label>
                      <input type="time" name="allocation_end_time" class="form-control" value="<%= toInputTime(a.end_at) %>">
                    </div>
                    <div class="col-md-10">
                      <label class="form-label small">Notes</label>
                      <input type="text" name="allocation_notes" class="form-control" value="<%= a.notes || '' %>" placeholder="Optional notes">
                    </div>
                    <div class="col-md-2 text-end">
                      <button type="button" class="btn btn-outline-danger btn-sm remove-allocation">Remove</button>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Event Type</label>
            <select name="event_type" class="form-select">
              <option value="">Select an event type</option>
              <% eventTypes.forEach(t => { %>
                <option value="<%= t.name %>" <%= fn.event_type === t.name ? 'selected' : '' %>><%= t.name %></option>
              <% }) %>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Status</label>
            <select name="status" class="form-select" id="functionStatusSelect">
              <% ['lead','qualified','confirmed','balance_due','completed','cancelled'].forEach(st => { %>
                <option value="<%= st %>" <%= fn.status === st ? 'selected' : '' %>>
                  <%= st.replace('_', ' ') %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="col-12" id="cancelReasonGroup" style="<%= fn.status === 'cancelled' ? '' : 'display:none;' %>">
            <label class="form-label">Cancellation reason</label>
            <textarea name="cancelled_reason" class="form-control" rows="3" placeholder="Add a note for why this function was cancelled."><%= fn.cancelled_reason || '' %></textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label">Function Owner</label>
            <select name="owner_id" class="form-select">
              <option value="">Unassigned</option>
              <% (users || []).forEach(u => { %>
                <option value="<%= u.id %>" <%= fn.owner_id === u.id ? 'selected' : '' %>><%= u.name %></option>
              <% }) %>
            </select>
          </div>
        </div>

        <div class="mt-4 d-flex justify-content-end gap-2">
          <a href="/functions/<%= fn.id_uuid %>" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </section>
</main>

<!-- üß± Modals (shared across all function pages) -->
<%- include('../../partials/functions/modals', {
  fn,
  linkedContacts: linkedContacts || [],
  rooms: rooms || [],
  eventTypes: eventTypes || []
}) %>

<!-- ‚öôÔ∏è Scripts -->
<script>
  // ‚úÖ Use UUID-only context (no integer fallback)
  window.fnContext = {
    id: "<%= fn.id_uuid %>",
    name: "<%= fn.event_name %>",
    status: "<%= fn.status %>",
    eventDate: "<%= fn.event_date ? fn.event_date.toISOString().split('T')[0] : '' %>",
    endDate: "<%= fn.end_date ? fn.end_date.toISOString().split('T')[0] : '' %>"
  };

  console.log("üõ†Ô∏è Function Context (Edit):", window.fnContext);
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const statusSelect = document.getElementById("functionStatusSelect");
    const cancelGroup = document.getElementById("cancelReasonGroup");
    if (!statusSelect || !cancelGroup) return;
    const toggleCancelReason = () => {
      cancelGroup.style.display = statusSelect.value === "cancelled" ? "" : "none";
    };
    statusSelect.addEventListener("change", toggleCancelReason);
    toggleCancelReason();
  });
</script>

<!-- JS Controller -->
<script src="/js/functions/edit.js" defer></script>

<template id="allocationRowTemplate">
  <div class="border rounded-3 p-3 allocation-row">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label small">Room</label>
        <select name="allocation_room_id" class="form-select">
          <option value="">Select room</option>
          <% rooms.forEach(r => { %>
            <option value="<%= r.id %>"><%= r.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small">Start date</label>
        <input type="date" name="allocation_start_date" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label small">Start time</label>
        <input type="time" name="allocation_start_time" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label small">End date</label>
        <input type="date" name="allocation_end_date" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label small">End time</label>
        <input type="time" name="allocation_end_time" class="form-control">
      </div>
      <div class="col-md-10">
        <label class="form-label small">Notes</label>
        <input type="text" name="allocation_notes" class="form-control" placeholder="Optional notes">
      </div>
      <div class="col-md-2 text-end">
        <button type="button" class="btn btn-outline-danger btn-sm remove-allocation">Remove</button>
      </div>
    </div>
  </div>
</template>

