<!-- ðŸ“¬ pages/functions/communications-detail.ejs -->
<% locals.layout = 'layouts/main'; %>

<main class="function-layout-two-col">

  <!-- ðŸ§­ Sidebar -->
  <%- include('../../partials/functions/sidebar', {
    fn,
    linkedContacts: linkedContacts || [],
    rooms: rooms || [],
    eventTypes: eventTypes || []
  }) %>

  <!-- ðŸ§© Workspace -->
  <section class="function-workspace">
    <!-- ðŸ”¹ Tabs -->
    <%- include('../../partials/functions/tabs', {
      fn,
      activeTab: 'communications'
    }) %>

    <!-- ðŸ”¹ Body -->
    <div class="function-body container py-4">

      <!-- ðŸ“¨ Back + Title -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a class="btn btn-outline-secondary btn-sm"
           href="/functions/<%= fn.id_uuid %>/communications">&larr; Back to Communications</a>
        <h3 class="mb-0">Reply</h3>
        <div></div>
      </div>

      <!-- ðŸ§¾ Original message -->
      <div class="inbox">
        <div class="message-card message-card--detail p-3 border rounded mb-4">
          <% const toEmail = Array.isArray(message.to_email) ? message.to_email.join(", ") : message.to_email; %>
          <p class="msg-subject h5 fw-semibold mb-2 text-break"><%= message.subject || "(No Subject)" %></p>
          <div class="msg-header text-muted small mb-3">
            <div class="d-flex flex-column gap-1">
              <% if (message.from_email) { %>
                <span class="text-break">From: <%= message.from_email %></span>
              <% } %>
              <% if (toEmail) { %>
                <span class="text-break">To: <%= toEmail %></span>
              <% } %>
            </div>
            <div class="mt-2">
              <%= (message.entry_date || message.created_at)
                    ? new Date(message.entry_date || message.created_at).toLocaleString('en-NZ')
                    : "" %>
            </div>
          </div>

          <div class="msg-body">
            <% const htmlBody = (message.body_html || "").trim(); %>
            <% const plainBody = (message.body || "").trim(); %>
            <% if (htmlBody) { %>
              <div class="message-body-html">
                <%- htmlBody %>
              </div>
            <% } else { %>
              <div class="message-body-plain"><%= plainBody %></div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- âœ‰ï¸ Reply form -->
      <div class="card mt-4">
        <div class="card-body">
          <form id="replyForm" method="POST"
                action="/functions/<%= fn.id_uuid %>/communications/<%= message.id %>/reply">
            <input type="hidden" name="next" value="/functions/<%= fn.id_uuid %>/communications">

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">To</label>
                <input name="to" id="replyTo" class="form-control"
                       value="<%= message.from_email || '' %>" placeholder="name@domain">
              </div>

              <div class="col-12">
                <label class="form-label">Subject</label>
                <input name="subject" id="replySubject" class="form-control"
                       value="Re: <%= message.subject || '(No subject)' %>">
              </div>

              <div class="col-12">
                <label class="form-label">Message</label>
                <div id="replyEditor" style="height: 260px;"></div>
                <input type="hidden" name="body" id="replyBody">
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-3">
              <a class="btn btn-outline-secondary"
                 href="/functions/<%= fn.id_uuid %>/communications">Cancel</a>
              <button class="btn btn-primary" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div> <!-- end body -->
  </section>
</main>

<!-- ðŸ§± Modals (shared across all function pages) -->
<%- include('../../partials/functions/modals', {
  fn,
  linkedContacts: linkedContacts || [],
  rooms: rooms || [],
  eventTypes: eventTypes || []
}) %>

<!-- âš™ï¸ Inline JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ov = document.getElementById('panelOverlay');
    if (ov) ov.classList.add('hidden');
    document.body.classList.remove('no-scroll');

    if (!window.Quill) {
      console.error('Quill library not loaded');
      return;
    }

    const quill = new Quill('#replyEditor', {
      theme: 'snow',
      placeholder: 'Type your replyâ€¦',
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ['bold', 'italic', 'underline'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link'],
        ],
      },
    });

    const editorHost = document.getElementById('replyEditor');
    if (editorHost) editorHost.style.minHeight = '240px';

    const form = document.getElementById('replyForm');
    form.addEventListener('submit', function () {
      document.getElementById('replyBody').value = quill.root.innerHTML;
    });
  });
</script>

<script>
  // âœ… Use UUID-only function context
  window.fnContext = {
    id: "<%= fn.id_uuid %>",
    messageId: "<%= message.id %>",      // already UUID-safe
    name: "<%= fn.event_name %>",
    status: "<%= fn.status %>",
    eventDate: "<%= fn.event_date ? fn.event_date.toISOString().split('T')[0] : '' %>"
  };

  console.log("ðŸ“¨ Function Context (Comm Detail):", window.fnContext);
</script>

<!-- JS Controller -->
<script src="/js/functions/communications.js" defer></script>


