<%
  function stripMeta(desc) {
    return String(desc || '').replace(/\[[^\]]+\]/g, '').trim();
  }
  function parseMeta(desc) {
    const meta = {};
    const regex = /\[([a-z_]+):([^\]]+)\]/gi;
    let match;
    while ((match = regex.exec(desc || ''))) {
      meta[match[1].toLowerCase()] = match[2];
    }
    const qtyMatch = String(desc || '').match(/ x (\d+)/i);
    if (qtyMatch) meta.qty = Number(qtyMatch[1]);
    return meta;
  }
  function formatCurrency(value) {
    const amount = Number(value) || 0;
    return amount.toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
  }
  function formatDate(value) {
    if (!value) return '';
    try {
      return new Date(value).toLocaleDateString('en-NZ', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
      });
    } catch (err) {
      return '';
    }
  }
  function formatTime(value) {
    if (!value) return '';
    try {
      return new Date(`1970-01-01T${value}`).toLocaleTimeString('en-NZ', {
        hour: 'numeric',
        minute: '2-digit',
      });
    } catch (err) {
      return value || '';
    }
  }
  const orderedContacts = Array.isArray(contacts) ? contacts : [];
  const primaryContact =
    orderedContacts.find((contact) => contact.is_primary) || orderedContacts[0] || null;
  const hasContacts = orderedContacts.length > 0;
  const eventDate = formatDate(proposal?.event_date);
  const printedDate = formatDate(new Date());
%>

<style>
  .client-shell {
    min-height: 100vh;
    background: #0f172a;
    padding: 2rem 1rem;
  }
  .client-card {
    max-width: 900px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
  }
  .client-header {
    background: linear-gradient(135deg, #0f172a, #1d4ed8);
    color: #fff;
  }
  .client-actions {
    gap: 0.5rem;
  }
</style>

<main class="client-shell">
  <div class="card shadow-lg client-card">
    <div class="print-only">
      <header class="proposal-header card shadow-sm mb-4">
        <div class="proposal-header__logo proposal-header__logo--pc">
          <img src="/img/Pclogotext.png" alt="Porirua Club" class="proposal-logo proposal-logo--primary">
        </div>
        <div class="proposal-header__meta">
          <div class="proposal-header__date"><%= eventDate %></div>
          <div class="proposal-header__title"><strong><%= proposal?.event_name || 'Function Proposal' %></strong></div>
          <div class="proposal-header__contact">
            <div class="text-muted text-uppercase small letter-tight">Attention</div>
            <% if (primaryContact) { %>
              <strong><%= primaryContact.name %></strong>
              <% if (primaryContact.email) { %><span><%= primaryContact.email %></span><% } %>
              <% if (primaryContact.phone) { %><span><%= primaryContact.phone %></span><% } %>
            <% } else { %>
              <span class="text-muted">No contact selected</span>
            <% } %>
          </div>
          <div class="proposal-header__issued text-uppercase small text-muted">
            Prepared <%= printedDate %>
          </div>
        </div>
        <div class="proposal-header__logo proposal-header__logo--eastwood">
          <img src="/img/EASTWOOD-LOGO-small.png" alt="Eastwood" class="proposal-logo proposal-logo--secondary">
        </div>
      </header>
    </div>
    <div class="card-body client-header no-print">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <p class="text-uppercase small mb-1">Proposal</p>
          <h1 class="h4 mb-1"><%= proposal?.event_name || 'Function Proposal' %></h1>
          <p class="mb-0 text-white-50">
            <%= proposal?.event_date ? new Date(proposal.event_date).toLocaleDateString('en-NZ') : '' %>
            <% if (proposal?.room_id) { %> Â· Room assigned <% } %>
          </p>
        </div>
        <div class="client-actions d-flex flex-wrap">
          <button class="btn btn-outline-light btn-sm" type="button" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> Print / Save PDF
          </button>
        </div>
      </div>
    </div>

    <div class="card-body bg-white">
      <% if (successMessage) { %>
        <div class="alert alert-success"><%= successMessage %></div>
      <% } %>
      <% if (errorMessage) { %>
        <div class="alert alert-danger"><%= errorMessage %></div>
      <% } %>

      <% if (!proposal) { %>
        <p class="text-muted mb-0">This link is no longer available.</p>
      <% } else { %>
        <form method="POST" action="/functions/proposal/client/<%= proposal.client_token %>/accept" class="vstack gap-4">
          <div class="row g-3">
            <div class="<%= hasContacts ? 'col-lg-6' : 'col-12' %>">
              <div class="proposal-summary-card card shadow-sm h-100 <%= hasContacts ? '' : 'proposal-summary-card--single' %>">
                <div class="card-body">
                  <h5 class="proposal-summary__title">Function Details</h5>
                  <dl class="proposal-summary__list">
                    <div>
                      <dt>Event</dt>
                      <dd><%= proposal?.event_name || '-' %></dd>
                    </div>
                    <div>
                      <dt>Date</dt>
                      <dd><%= eventDate || '-' %></dd>
                    </div>
                    <div>
                      <dt>Time</dt>
                      <dd>
                        <%= proposal?.start_time ? formatTime(proposal.start_time) : '-' %>
                        <% if (proposal?.end_time) { %> - <%= formatTime(proposal.end_time) %><% } %>
                      </dd>
                    </div>
                    <div>
                      <dt>Guests</dt>
                      <dd><%= proposal?.attendees || '-' %></dd>
                    </div>
                    <div>
                      <dt>Room</dt>
                      <dd><%= proposal?.room_name || (proposal?.room_id ? 'Room assigned' : '-') %></dd>
                    </div>
                  </dl>
                </div>
              </div>
            </div>
            <% if (hasContacts) { %>
              <div class="col-lg-6">
                <div class="proposal-summary-card card shadow-sm h-100">
                  <div class="card-body">
                    <h5 class="proposal-summary__title">Contact Details</h5>
                    <dl class="proposal-summary__list">
                      <% orderedContacts.forEach(function(contact) { %>
                        <div>
                          <dt><%= contact.is_primary ? 'Primary contact' : 'Contact' %></dt>
                          <dd>
                            <strong><%= contact.name || '-' %></strong>
                            <% if (contact.email) { %><span><%= contact.email %></span><% } %>
                            <% if (contact.phone) { %><span><%= contact.phone %></span><% } %>
                          </dd>
                        </div>
                      <% }) %>
                    </dl>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
          <div>
            <label class="form-label">Your name</label>
            <input type="text" class="form-control" name="client_name" required placeholder="Full name">
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="yes" id="acceptTerms" name="accept_terms" required>
            <label class="form-check-label" for="acceptTerms">
              I confirm this booking and agree to the Terms &amp; Conditions in this proposal.
            </label>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 50px;"></th>
                  <th>Item</th>
                  <th style="width: 90px;">Qty</th>
                  <th style="width: 120px;">Price</th>
                  <th style="width: 120px;">Total</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(function(item) { 
                  const label = stripMeta(item.description);
                  const selectable = item.client_selectable;
                  const meta = parseMeta(item.description);
                  const allowQty = String(meta.client_allow_qty || '').toLowerCase() === 'true';
                  const qtyValue = Number(meta.qty || 1) || 1;
                  const unitPrice = Number(item.unit_price || 0);
                  const unitType = String(meta.unit_type || '').toLowerCase();
                  const isPerPerson =
                    unitType === 'per_person' ||
                    unitType === 'per-person' ||
                    unitType === 'per person' ||
                    unitType === 'pp';
                  let priceEach;
                  if (meta.base != null) {
                    priceEach = Number(meta.base);
                  } else if (isPerPerson && qtyValue > 0) {
                    priceEach = unitPrice < qtyValue ? unitPrice : unitPrice / qtyValue;
                  } else {
                    priceEach = qtyValue > 0 ? unitPrice / qtyValue : unitPrice;
                  }
                  const lineTotal = priceEach * qtyValue;
                %>
                  <tr>
                    <td class="text-center">
                      <% if (selectable) { %>
                        <input type="checkbox" class="form-check-input client-include" name="item_<%= item.id %>_include" checked>
                      <% } %>
                    </td>
                    <td><%= label || 'Item' %></td>
                    <td>
                      <% if (selectable || allowQty) { %>
                        <input type="number" name="item_<%= item.id %>_qty" class="form-control form-control-sm client-qty" value="<%= qtyValue %>" min="1" data-price="<%= priceEach %>">
                      <% } else { %>
                        <span><%= qtyValue %></span>
                      <% } %>
                    </td>
                    <td><%= formatCurrency(priceEach) %></td>
                    <td class="client-line-total"><%= formatCurrency(lineTotal) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button type="submit" name="action" value="pending" class="btn btn-primary">
              Confirm booking now (choose menu later)
            </button>
            <button type="submit" name="action" value="final" class="btn btn-success">
              Confirm with menu selections
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="window.print()">Print proposal</button>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</main>

<script>
  document.querySelectorAll('.client-qty').forEach((input) => {
    const row = input.closest('tr');
    const totalCell = row?.querySelector('.client-line-total');
    const priceEach = Number(input.dataset.price || 0);
    const update = () => {
      let qty = Number(input.value || 1);
      if (!Number.isFinite(qty) || qty <= 0) qty = 1;
      const total = priceEach * qty;
      if (totalCell) {
        totalCell.textContent = total.toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
      }
    };
    input.addEventListener('input', update);
    input.addEventListener('change', update);
    update();
  });
</script>
