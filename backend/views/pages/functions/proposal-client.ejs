<% function stripMeta(desc) { return String(desc || '').replace(/\[[^\]]+\]/g, '').trim(); } %>

<style>
  .client-shell {
    min-height: 100vh;
    background: #0f172a;
    padding: 2rem 1rem;
  }
  .client-card {
    max-width: 900px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
  }
  .client-header {
    background: linear-gradient(135deg, #0f172a, #1d4ed8);
    color: #fff;
  }
  .client-actions {
    gap: 0.5rem;
  }
</style>

<main class="client-shell">
  <div class="card shadow-lg client-card">
    <div class="card-body client-header">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <p class="text-uppercase small mb-1">Proposal</p>
          <h1 class="h4 mb-1"><%= proposal?.event_name || 'Function Proposal' %></h1>
          <p class="mb-0 text-white-50">
            <%= proposal?.event_date ? new Date(proposal.event_date).toLocaleDateString('en-NZ') : '' %>
            <% if (proposal?.room_id) { %> Â· Room assigned <% } %>
          </p>
        </div>
        <div class="client-actions d-flex flex-wrap">
          <button class="btn btn-outline-light btn-sm" type="button" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> Print / Save PDF
          </button>
        </div>
      </div>
    </div>

    <div class="card-body bg-white">
      <% if (successMessage) { %>
        <div class="alert alert-success"><%= successMessage %></div>
      <% } %>
      <% if (errorMessage) { %>
        <div class="alert alert-danger"><%= errorMessage %></div>
      <% } %>

      <% if (!proposal) { %>
        <p class="text-muted mb-0">This link is no longer available.</p>
      <% } else { %>
        <form method="POST" action="/functions/proposal/client/<%= proposal.client_token %>/accept" class="vstack gap-4">
          <div>
            <label class="form-label">Your name</label>
            <input type="text" class="form-control" name="client_name" required placeholder="Full name">
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 50px;"></th>
                  <th>Item</th>
                  <th style="width: 90px;">Qty</th>
                  <th style="width: 120px;">Price</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(function(item) { const label = stripMeta(item.description); const selectable = item.client_selectable; %>
                  <tr>
                    <td class="text-center">
                      <% if (selectable) { %>
                        <input type="checkbox" class="form-check-input client-include" name="item_<%= item.id %>_include" checked>
                      <% } %>
                    </td>
                    <td><%= label || 'Item' %></td>
                    <td>
                      <% if (selectable) { %>
                        <input type="number" name="item_<%= item.id %>_qty" class="form-control form-control-sm client-qty" value="1" min="1">
                      <% } %>
                    </td>
                    <td><%= Number(item.unit_price || 0).toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' }) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button type="submit" name="action" value="pending" class="btn btn-primary">
              Confirm booking now (choose menu later)
            </button>
            <button type="submit" name="action" value="final" class="btn btn-success">
              Confirm with menu selections
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="window.print()">Print proposal</button>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</main>
