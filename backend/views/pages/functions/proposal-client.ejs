<%
  function stripMeta(desc) {
    return String(desc || '').replace(/\[[^\]]+\]/g, '').trim();
  }
  function parseMeta(desc) {
    const meta = {};
    const regex = /\[([a-z_]+):([^\]]+)\]/gi;
    let match;
    while ((match = regex.exec(desc || ''))) {
      meta[match[1].toLowerCase()] = match[2];
    }
    const qtyMatch = String(desc || '').match(/ x (\d+)/i);
    if (qtyMatch) meta.qty = Number(qtyMatch[1]);
    return meta;
  }
  function formatCurrency(value) {
    const amount = Number(value) || 0;
    return amount.toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
  }
%>

<style>
  .client-shell {
    min-height: 100vh;
    background: #0f172a;
    padding: 2rem 1rem;
  }
  .client-card {
    max-width: 900px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
  }
  .client-header {
    background: linear-gradient(135deg, #0f172a, #1d4ed8);
    color: #fff;
  }
  .client-actions {
    gap: 0.5rem;
  }
</style>

<main class="client-shell">
  <div class="card shadow-lg client-card">
    <div class="print-only">
      <header class="proposal-header card shadow-sm mb-4">
        <div class="proposal-header__logo proposal-header__logo--pc">
          <img src="/img/Pclogotext.png" alt="Porirua Club" class="proposal-logo proposal-logo--primary">
        </div>
        <div class="proposal-header__meta">
          <div class="proposal-header__date">
            <%= proposal?.event_date ? new Date(proposal.event_date).toLocaleDateString('en-NZ') : '' %>
          </div>
          <div class="proposal-header__title">
            <strong><%= proposal?.event_name || 'Function Proposal' %></strong>
          </div>
        </div>
        <div class="proposal-header__logo proposal-header__logo--eastwood">
          <img src="/img/EASTWOOD-LOGO-small.png" alt="Eastwood" class="proposal-logo proposal-logo--secondary">
        </div>
      </header>
    </div>
    <div class="card-body client-header no-print">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <p class="text-uppercase small mb-1">Proposal</p>
          <h1 class="h4 mb-1"><%= proposal?.event_name || 'Function Proposal' %></h1>
          <p class="mb-0 text-white-50">
            <%= proposal?.event_date ? new Date(proposal.event_date).toLocaleDateString('en-NZ') : '' %>
            <% if (proposal?.room_id) { %> Â· Room assigned <% } %>
          </p>
        </div>
        <div class="client-actions d-flex flex-wrap">
          <button class="btn btn-outline-light btn-sm" type="button" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> Print / Save PDF
          </button>
        </div>
      </div>
    </div>

    <div class="card-body bg-white">
      <% if (successMessage) { %>
        <div class="alert alert-success"><%= successMessage %></div>
      <% } %>
      <% if (errorMessage) { %>
        <div class="alert alert-danger"><%= errorMessage %></div>
      <% } %>

      <% if (!proposal) { %>
        <p class="text-muted mb-0">This link is no longer available.</p>
      <% } else { %>
        <form method="POST" action="/functions/proposal/client/<%= proposal.client_token %>/accept" class="vstack gap-4">
          <div>
            <label class="form-label">Your name</label>
            <input type="text" class="form-control" name="client_name" required placeholder="Full name">
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="yes" id="acceptTerms" name="accept_terms" required>
            <label class="form-check-label" for="acceptTerms">
              I confirm this booking and agree to the Terms &amp; Conditions in this proposal.
            </label>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 50px;"></th>
                  <th>Item</th>
                  <th style="width: 90px;">Qty</th>
                  <th style="width: 120px;">Price</th>
                  <th style="width: 120px;">Total</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(function(item) { 
                  const label = stripMeta(item.description);
                  const selectable = item.client_selectable;
                  const meta = parseMeta(item.description);
                  const qtyValue = Number(meta.qty || 1) || 1;
                  const unitPrice = Number(item.unit_price || 0);
                  const priceEach = meta.base ? Number(meta.base) : qtyValue > 0 ? unitPrice / qtyValue : unitPrice;
                  const lineTotal = priceEach * qtyValue;
                %>
                  <tr>
                    <td class="text-center">
                      <% if (selectable) { %>
                        <input type="checkbox" class="form-check-input client-include" name="item_<%= item.id %>_include" checked>
                      <% } %>
                    </td>
                    <td><%= label || 'Item' %></td>
                    <td>
                      <% if (selectable) { %>
                        <input type="number" name="item_<%= item.id %>_qty" class="form-control form-control-sm client-qty" value="<%= qtyValue %>" min="1" data-price="<%= priceEach %>">
                      <% } else { %>
                        <span><%= qtyValue %></span>
                      <% } %>
                    </td>
                    <td><%= formatCurrency(priceEach) %></td>
                    <td class="client-line-total"><%= formatCurrency(lineTotal) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button type="submit" name="action" value="pending" class="btn btn-primary">
              Confirm booking now (choose menu later)
            </button>
            <button type="submit" name="action" value="final" class="btn btn-success">
              Confirm with menu selections
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="window.print()">Print proposal</button>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</main>

<script>
  document.querySelectorAll('.client-qty').forEach((input) => {
    const row = input.closest('tr');
    const totalCell = row?.querySelector('.client-line-total');
    const priceEach = Number(input.dataset.price || 0);
    const update = () => {
      let qty = Number(input.value || 1);
      if (!Number.isFinite(qty) || qty <= 0) qty = 1;
      const total = priceEach * qty;
      if (totalCell) {
        totalCell.textContent = total.toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
      }
    };
    input.addEventListener('input', update);
    input.addEventListener('change', update);
    update();
  });
</script>
