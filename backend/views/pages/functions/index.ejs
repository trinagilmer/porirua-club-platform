<!-- ðŸ“Š pages/functions/index.ejs -->
<% locals.layout = 'layouts/main'; %>

<div class="function-dashboard container-fluid py-4">
<div class="dashboard-header function-header d-flex justify-content-between align-items-center">
  <h1 class="page-title">Functions Dashboard</h1>
  <a href="/functions/new" class="btn btn-brand">+ Add Function</a>
</div>


  <!-- KPI Overview -->
  <div class="kpi-bar mb-4">
    <div class="kpi">
      <div class="label">Leads</div>
      <div class="value">$<%= totals.lead_value %></div>
    </div>
    <div class="kpi">
      <div class="label">Qualified</div>
      <div class="value">$<%= totals.qualified_value %></div>
    </div>
    <div class="kpi">
      <div class="label">Confirmed</div>
      <div class="value">$<%= totals.confirmed_value %></div>
    </div>
    <div class="kpi">
      <div class="label">Balance Due</div>
      <div class="value">$<%= totals.balance_due_value %></div>
    </div>
    <div class="kpi">
      <div class="label">Completed YTD</div>
      <div class="value">$<%= totals.completed_value %></div>
    </div>
  </div>

  <!-- Status Filters -->
  <div class="status-filters mb-4">
    <% ['active','lead','qualified','confirmed','balance_due','completed','cancelled'].forEach(st => { %>
      <a href="/functions?status=<%= st %>"
         class="filter-pill <%= statusFilter === st ? 'active' : '' %>">
        <%= st.replace('_',' ') %>
      </a>
    <% }) %>
    <a href="/functions?mine=true" class="filter-pill <%= myOnly ? 'active' : '' %>">My Events</a>
  </div>

  <!-- Functions Table -->
<div class="table-wrapper">
  <table class="table function-table">
      <thead>
        <tr>
          <th>Event</th>
          <th>Status</th>
          <th>Date</th>
          <th>Attendees</th>
          <th>Value ($)</th>
          <th>Room</th>
          <th>Owner</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (events.length === 0) { %>
          <tr>
            <td colspan="9" class="text-center py-3 text-muted">
              No functions found for this view.
            </td>
          </tr>
        <% } else { %>
          <% events.forEach(e => { %>
            <tr>
              <!-- Event + Contact -->
              <td>
                <a href="/functions/<%= e.id_uuid %>" class="event-link">
                  <%= e.event_name %>
                </a><br>

                <% 
                  let contacts = e.contacts || [];
                  if (typeof contacts === 'string') contacts = JSON.parse(e.contacts); 
                %>

                <% if (contacts.length > 0) { 
                     const primary = contacts.find(c => c.is_primary) || contacts[0];
                     const extra = contacts.length - 1;
                %>
                  <span class="subtext">
                    <%= primary.name %>
                    <% if (extra > 0) { %>
                      <span class="text-muted"> +<%= extra %></span>
                    <% } %>
                  </span>
                <% } else { %>
                  <span class="text-muted subtext">No contact</span>
                <% } %>
              </td>

              <!-- Status -->
              <td>
                <span class="status-badge status-<%= e.status %>">
                  <%= e.status %>
                </span>
              </td>

              <!-- Date + Time -->
              <td>
                <%= formatNZDate(e.event_date) %><br>
                <% if (e.event_time) { %>
                  <span class="subtext"><%= e.event_time.toString().slice(0, 5) %></span>
                <% } %>
              </td>

              <td><%= e.attendees || '' %></td>

              <td>
                <% if (e.totals_price) { %>
                  $<%= Number(e.totals_price).toFixed(2) %>
                <% } else { %>
                  â€”
                <% } %>
              </td>

              <td><%= e.room_name || '' %></td>
              <td><%= e.owner_name || '' %></td>
              <td><%= formatNZDate(e.created_at) %></td>

              <!-- Actions -->
              <td class="table-actions">
                <a href="/functions/<%= e.id_uuid %>" class="btn btn-sm btn-outline-primary">View</a>
                <a href="/functions/<%= e.id_uuid %>/edit" class="btn btn-sm btn-outline-secondary">Edit</a>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>
