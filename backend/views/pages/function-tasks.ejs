<!-- ðŸ§© Function Tasks Page -->
<div class="function-page function-layout-two-col">

  <!-- ðŸ§­ Sidebar -->
  <%- include('../partials/sidebar', { fn, linkedContacts, rooms, eventTypes }) %>

  <!-- ðŸ§  MAIN CONTENT AREA -->
  <section class="function-workspace">
    
    <!-- ðŸ§­ Function Tabs -->
    <%- include('../partials/function-tabs', { fn, activeTab: 'tasks' }) %>

    <!-- ðŸ—’ï¸ Tasks Section -->
    <div class="workspace-content container mt-4" style="max-width: 900px;">
      <div class="tasks-header d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 fw-bold text-success">ðŸ“‹ Tasks for <%= fn.event_name %></h1>
        <button id="addTaskBtn" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
          âž• Add Task
        </button>
      </div>

    <% if (!tasks || !tasks.length) { %>
  <div class="alert alert-info">No tasks yet â€” create one!</div>
<% } else { %>
  <div class="task-cards-grid row g-3">
    <% tasks.forEach(t => { %>
     <div class="col-12 col-md-6">
        <div class="task-card shadow-sm h-100">
          <div class="task-card-body d-flex flex-column justify-content-between">

            <!-- ðŸ§¾ Header -->
            <div class="task-card-header">
              <h5 class="task-card-title text-success mb-1">
                <%= t.title %>
              </h5>
              <p class="task-card-desc text-muted small mb-2">
  <%- t.description ? t.description : "<span class='text-muted fst-italic'>No details</span>" %>
</p>
            </div>

            <!-- ðŸ‘¤ Assigned / Due -->
            <div class="task-card-meta d-flex justify-content-between align-items-center mt-2">
              <div>
                <span class="small"><strong>Assigned:</strong> <%= t.assigned_user_name || 'â€”' %></span><br>
                <span class="small"><strong>Due:</strong> 
                  <%= t.due_at 
                    ? new Date(t.due_at).toLocaleDateString('en-NZ', { day: '2-digit', month: 'short' }) 
                    : 'â€”' %>
                </span>
              </div>

             <span class="task-card-status badge 
  <%= t.status === 'completed' 
        ? 'status-completed' 
        : t.status === 'in_progress' 
          ? 'status-progress' 
          : 'status-open' %>">
  <%= t.status ? t.status.charAt(0).toUpperCase() + t.status.slice(1).replace('_', ' ') : 'Open' %>
</span>

            </div>

            <!-- ðŸ•“ Footer -->
            <div class="task-card-footer d-flex justify-content-between align-items-center mt-3 border-top pt-2">
              <small class="text-muted">
                Updated: <%= t.updated_at 
                  ? new Date(t.updated_at).toLocaleDateString('en-NZ', { day: '2-digit', month: 'short' }) 
                  : 'â€”' %>
              </small>

              <div class="task-card-actions btn-group btn-group-sm">
                <button class="btn btn-outline-primary editTaskBtn" data-id="<%= t.id %>">Edit</button>
                <% if (t.status !== 'completed') { %>
                  <button class="btn btn-outline-success completeTaskBtn" data-id="<%= t.id %>">Complete</button>
                <% } %>
                <button class="btn btn-outline-danger deleteTaskBtn" data-id="<%= t.id %>">Delete</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>
    </div>
  </section>
</div>

<!-- ðŸ§© Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <div class="modal-header">
          <h5 class="modal-title">Add Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" id="taskTitle" class="form-control" required>
          </div>
         <div class="mb-3">
  <label class="form-label">Assign To</label>
  <select id="taskAssignedTo" class="form-select">
    <option value="">Unassigned</option>
    <% if (users && users.length) { %>
      <% users.forEach(u => { %>
        <option value="<%= u.id %>"><%= u.name %></option>
      <% }) %>
    <% } else { %>
      <option disabled>(No users found)</option>
    <% } %>
  </select>
</div>
            <div class="mb-3">
            <label class="form-label">Due Date</label>
            <input type="date" id="taskDueAt" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ðŸ”¹ Include Contact Panels / Time Modals -->
<%- include('../partials/function-modals') %>

<!-- ðŸ”¹ JS Context -->
<script>
  window.fnContext = { id: "<%= fn.id %>" };
</script>

<!-- ðŸ”¹ Scripts -->
<script src="/js/sidebar.js"></script>
<script src="/js/function-tasks.js"></script>


