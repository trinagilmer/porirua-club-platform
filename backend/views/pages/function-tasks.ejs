<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head', { title: 'Tasks' }) %>
  <link rel="stylesheet" href="/css/main.css">
  <style>
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .tasks-header h1 {
      color: #0f766e;
      font-weight: 700;
    }
    .status-badge {
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 0.8rem;
    }
    .status-open { background: #dcfce7; color: #166534; }
    .status-completed { background: #dbeafe; color: #1e3a8a; }
    table.table td, table.table th { vertical-align: middle; }
    td.description-cell {
      max-width: 300px;
      white-space: pre-line;
      overflow-wrap: break-word;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { active: 'functions', user: user }) %>

  <main class="main-content container mt-4">
    <%- include('../partials/function-tabs', { fn, activeTab: 'tasks' }) %>

    <h1 class="mb-3">Tasks for <%= fn.event_name %></h1>

    <div class="tasks-header mt-3 mb-3">
      <h1 class="h3 fw-bold text-success">ðŸ“‹ Tasks</h1>
      <button id="addTaskBtn" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
        âž• Add Task
      </button>
    </div>

    <% if (!tasks || !tasks.length) { %>
      <div class="alert alert-info">No tasks yet â€” create one!</div>
    <% } else { %>
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Task</th>
            <th>Description</th>
            <th>Assigned To</th>
            <th>Status</th>
            <th>Due</th>
            <th>Actions</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="taskTableBody">
          <% tasks.forEach(t => { %>
            <tr data-id="<%= t.id %>">
              <td><%= t.title %></td>
              <td class="description-cell"><%= t.description || 'â€”' %></td>
              <td><%= t.assigned_user_name || 'â€”' %></td>
              <td>
                <span class="status-badge status-<%= t.status %>">
                  <%= t.status.charAt(0).toUpperCase() + t.status.slice(1) %>
                </span>
              </td>
              <td><%= t.due_at ? new Date(t.due_at).toLocaleDateString() : 'â€”' %></td>
              <td>
                <button class="btn btn-outline-primary btn-sm editTaskBtn" data-id="<%= t.id %>">Edit</button>
                <% if (t.status !== 'completed') { %>
                  <button class="btn btn-outline-success btn-sm completeTaskBtn" data-id="<%= t.id %>">Complete</button>
                <% } %>
                <button class="btn btn-outline-danger btn-sm deleteTaskBtn" data-id="<%= t.id %>">Delete</button>
              </td>
              <td><%= t.updated_at ? new Date(t.updated_at).toLocaleString() : 'â€”' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </main>

  <!-- ðŸ§© Add/Edit Task Modal -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-3">
        <form id="taskForm">
          <input type="hidden" id="taskId">
          <div class="modal-header">
            <h5 class="modal-title">Add Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" id="taskTitle" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea id="taskDescription" class="form-control" rows="3" placeholder="Optional details..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Assign To (User ID)</label>
              <input type="number" id="taskAssignedTo" class="form-control" placeholder="User ID">
            </div>
            <div class="mb-3">
              <label class="form-label">Due Date</label>
              <input type="date" id="taskDueAt" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <!-- Pass the function ID to JavaScript -->
  <script>
    window.functionId = <%= fn.id %>;
  </script>

  <!-- Load the task logic -->
  <script src="/js/function-tasks.js" defer></script>
</body>
</html>

