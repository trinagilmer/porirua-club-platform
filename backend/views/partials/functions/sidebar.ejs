<!-- ðŸ§­ LEFT COLUMN â€” Sidebar Partial -->
<aside class="function-sidebar" aria-label="Function details">
  <div class="sidebar-mobile-header">
    <span>Function details</span>
    <button type="button" class="sidebar-close" aria-label="Close details">&times;</button>
  </div>
  <div class="sidebar-scroll-container"> <!-- NEW WRAPPER -->

    <!-- ðŸ§© FUNCTION META -->
    <div class="function-meta">
      <h2 contenteditable="true" class="editable" data-field="event_name" data-id="<%= fn.id_uuid %>">
        <%= fn.event_name %>
      </h2>
      <select class="form-select status-select" disabled>
        <option value="lead" <%= fn.status==='lead'?'selected':'' %>>Lead</option>
        <option value="qualified" <%= fn.status==='qualified'?'selected':'' %>>Qualified</option>
        <option value="confirmed" <%= fn.status==='confirmed'?'selected':'' %>>Confirmed</option>
        <option value="balance_due" <%= fn.status==='balance_due'?'selected':'' %>>Balance Due</option>
        <option value="completed" <%= fn.status==='completed'?'selected':'' %>>Completed</option>
        <option value="cancelled" <%= fn.status==='cancelled'?'selected':'' %>>Cancelled</option>
      </select>
    </div>

    <!-- ðŸ‘¥ CONTACT BLOCK -->
    <section class="function-contact-block sidebar-block">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Contacts</h4>
        <button id="openAddPanelBtn" class="btn btn-sm btn-outline-primary">+ Add</button>
      </div>

      <% if (linkedContacts.length > 0) { %>
        <ul class="contact-list">
          <% linkedContacts.forEach(c => { %>
            <li class="contact-card">
              <div class="contact-info">
                <strong><%= c.name %></strong>
                <% if (c.is_primary) { %>
                  <span class="badge bg-success ms-1">Primary</span>
                <% } %><br>
                <small><%= c.email || 'No email' %></small><br>
                <small><%= c.phone || '' %></small>
              </div>

              <!-- â‹® BURGER MENU -->
              <div class="menu-container">
                <button class="menu-btn fn-menu-btn" data-id="<%= c.id %>">â‹®</button>
                <div id="menu-<%= c.id %>" class="menu-dropdown fn-menu-dropdown hidden">
                  <button class="edit-btn" data-id="<%= c.id %>">Edit</button>
                  <% if (!c.is_primary) { %>
                    <button class="primary-btn" data-id="<%= c.id %>">Make Primary</button>
                  <% } %>
                  <button class="remove-btn" data-id="<%= c.id %>">Remove</button>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">No contacts linked</p>
      <% } %>
    </section>

    <!-- ðŸ“… FUNCTION DETAILS -->
    <section class="function-details sidebar-block">
      <h4>Function Details</h4>

    <!-- Event Date -->
    <div class="detail-item">
      <label>Event Date</label>
      <input
        type="date"
        class="editable"
        data-field="event_date"
        data-id="<%= fn.id_uuid %>"
        value="<%= (() => {
          if (!fn.event_date) return '';
          const d = new Date(fn.event_date);
          if (isNaN(d.getTime())) return '';
          const tzOffset = d.getTimezoneOffset() * 60000;
          const local = new Date(d.getTime() - tzOffset);
          return local.toISOString().split('T')[0];
        })() %>"
      >
    </div>

    <!-- Time Range -->
    <div class="detail-row">
      <div class="detail-item half">
        <label>Start Time</label>
        <button class="btn btn-sm time-modal-btn w-100" data-field="start_time" data-id="<%= fn.id_uuid %>">
          <%- fn.start_time ? fn.start_time : 'Set Time' %>
        </button>
      </div>

      <div class="detail-item half">
        <label>End Time</label>
        <button class="btn btn-sm time-modal-btn w-100" data-field="end_time" data-id="<%= fn.id_uuid %>">
          <%- fn.end_time ? fn.end_time : 'Set Time' %>
        </button>
      </div>
    </div>

    <!-- Attendance + Budget -->
    <div class="detail-row">
      <div class="detail-item half">
        <label>Group Size</label>
        <input
          type="number"
          class="editable w-100"
          data-field="attendees"
          data-id="<%= fn.id_uuid %>"
          value="<%= fn.attendees || '' %>"
        >
      </div>

      <div class="detail-item half">
        <label>Budget ($)</label>
        <input
          type="number"
          class="editable w-100"
          data-field="budget"
          data-id="<%= fn.id_uuid %>"
          value="<%= fn.budget || '' %>"
          step="0.01"
        >
      </div>
    </div>

    <!-- Totals -->
    <div class="detail-row">
      <div class="detail-item half">
        <label>Total Cost ($)</label>
        <input
          type="number"
          class="editable w-100"
          data-field="totals_cost"
          data-id="<%= fn.id_uuid %>"
          value="<%= fn.totals_cost || '' %>"
          step="0.01"
        >
      </div>

      <div class="detail-item half">
        <label>Total Price ($)</label>
        <input
          type="number"
          class="editable w-100"
          data-field="totals_price"
          data-id="<%= fn.id_uuid %>"
          value="<%= fn.totals_price || '' %>"
          step="0.01"
        >
      </div>
    </div>

    <!-- Room Selection -->
    <div class="detail-item">
      <label>Room / Space</label>
      <select class="editable form-select" data-field="room_id" data-id="<%= fn.id_uuid %>">
        <option value="">Select a room</option>
        <% rooms.forEach(r => { %>
          <option value="<%= r.id %>" <%= fn.room_id === r.id ? 'selected' : '' %>>
            <%= r.name %> (<%= r.capacity ? r.capacity + ' ppl' : 'no capacity' %>)
          </option>
        <% }) %>
      </select>
    </div>

    <!-- Event Type -->
    <div class="detail-item">
      <label>Event Type</label>
      <select class="editable form-select" data-field="event_type" data-id="<%= fn.id_uuid %>">
        <option value="">Select an event type</option>
        <% eventTypes.forEach(t => { %>
          <option value="<%= t.name %>" <%= fn.event_type === t.name ? 'selected' : '' %>>
            <%= t.name %>
          </option>
        <% }) %>
      </select>
    </div>
  </section>
  </div> <!-- /sidebar-scroll-container -->
</aside>
<div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

