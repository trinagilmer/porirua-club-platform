<!-- views/partials/messageDetail.ejs -->
<div class="message-detail-inner card shadow-sm p-4 rounded-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 fw-semibold"><%= msg.subject || "(No Subject)" %></h2>
    <span class="badge bg-light text-dark px-3 py-2">
      <%= msg.message_type === "outbound" ? "Sent" : "Received" %>
    </span>
  </div>

  <!-- Quick Link Buttons -->
  <div class="d-flex justify-content-end gap-2 mb-3">
    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#linkContactModal">
      ğŸ“‡ Link Contact
    </button>
    <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#linkFunctionModal">
      ğŸ§© Link Function
    </button>
  </div>

  <!-- Linked Info Banner -->
  <% if (msg.contact_name || msg.function_name) { %>
    <div class="alert alert-info mb-3">
      <% if (msg.contact_name) { %>
        ğŸ“‡ Linked to: <strong><%= msg.contact_name %></strong>
      <% } %>
      <% if (msg.function_name) { %>
        <br>ğŸ§© Function: <strong><%= msg.function_name %></strong>
      <% } %>
    </div>
  <% } else { %>
    <div class="alert alert-warning mb-3">
      âš ï¸ This message is not yet linked to any contact or function.
    </div>
  <% } %>

  <!-- Meta Info -->
  <div class="text-muted mb-3 small">
    <p><strong>From:</strong> <%= msg.from_email || "Unknown" %></p>
    <p><strong>To:</strong> <%= msg.to_email || "Unknown" %></p>
    <p><strong>Date:</strong>
      <%= msg.created_at
          ? new Date(msg.created_at).toLocaleString()
          : "(Unknown date)" %>
    </p>
  </div>

  <!-- Message Body -->
  <hr>
  <div class="message-body">
    <%
      const plainBody = (msg.body_html || msg.body || "").replace(/<[^>]+>/g, "").trim();
    %>
    <% if (plainBody) { %>
      <pre class="formatted-body"><%= plainBody %></pre>
    <% } else { %>
      <em class="text-muted">(No message body)</em>
    <% } %>
  </div>

  <!-- Attachments -->
  <% if (msg.attachments && msg.attachments.length > 0) { %>
    <hr>
    <div class="attachments mt-4">
      <h5 class="fw-bold mb-3">ğŸ“ Attachments</h5>
      <ul class="list-group list-group-flush">
        <% msg.attachments.forEach(a => { %>
          <li class="list-group-item">
            <a href="<%= a.file_url || a.filePath || '#' %>" target="_blank">
              <%= a.file_name || a.name || "Unnamed attachment" %>
            </a>
          </li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <!-- Footer Buttons -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#linkContactModal">ğŸ“‡ Link Contact</button>
      <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#linkFunctionModal">ğŸ§© Link Function</button>
      <button class="btn btn-outline-info btn-sm btn-reply-message" data-bs-toggle="modal" data-bs-target="#replyMessageModal">
  ğŸ’¬ Reply
</button>

    </div>
    <a href="/inbox" class="btn btn-secondary btn-sm">â† Back to Inbox</a>
  </div>

</div>
<%- include('../partials/replyModal', { message: msg }) %>




