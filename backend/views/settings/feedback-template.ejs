<main class="settings-feedback py-4">
  <style>
    .quill-editor {
      min-height: 220px;
      background: #fff;
      border: 1px solid var(--bs-border-color);
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
    }
  </style>

  <div class="d-flex justify-content-between align-items-center flex-wrap mb-4 gap-2">
    <div>
      <h1 class="mb-1"><%= templateConfig.title %></h1>
      <p class="text-muted mb-0"><%= templateConfig.description %></p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="/settings/feedback" class="btn btn-outline-secondary btn-sm">
        Automation &amp; questions
      </a>
      <a href="/settings/feedback/activity" class="btn btn-outline-secondary btn-sm">
        Responses
      </a>
      <a href="/settings/overview" class="btn btn-link text-decoration-none">
        &larr; Back to overview
      </a>
    </div>
  </div>

  <% if (flashMessage) { %>
    <div class="alert alert-<%= flashType === 'error' ? 'danger' : flashType || 'success' %>">
      <%= flashMessage %>
    </div>
  <% } %>

  <section class="card shadow-sm mb-4">
    <div class="card-body">
      <h6 class="text-muted text-uppercase small mb-3">Templates</h6>
      <div class="d-flex flex-wrap gap-2">
        <% (templateLinks || []).forEach(function(link) { %>
          <a href="<%= link.path %>" class="btn btn-light border <%= link.key === templateConfig.key ? 'active fw-semibold' : '' %>">
            <%= link.label %>
          </a>
        <% }) %>
      </div>
    </div>
  </section>

  <section class="card shadow-sm">
    <form class="card-body vstack gap-4" method="POST" action="/settings/feedback/templates/<%= templateConfig.key %>">
      <% if (templateConfig.subjectField) { %>
        <div>
          <label class="form-label"><%= templateConfig.subjectLabel || 'Subject' %></label>
          <input
            type="text"
            class="form-control"
            name="<%= templateConfig.subjectField %>"
            value="<%= templateValues.subject || '' %>" />
        </div>
      <% } %>

      <% if (templateConfig.editorField) { %>
        <div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0"><%= templateConfig.editorLabel || 'Content' %></label>
            <% if (templateConfig.helperText) { %>
              <span class="text-muted small"><%= templateConfig.helperText %></span>
            <% } %>
          </div>
          <div id="templateEditor" class="quill-editor"></div>
          <input
            type="hidden"
            id="templateEditorInput"
            name="<%= templateConfig.editorField %>"
            value="<%- templateValues.editor || '' %>" />
        </div>
      <% } %>

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Save template</button>
      </div>
    </form>
  </section>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const editorContainer = document.getElementById("templateEditor");
    const hiddenInput = document.getElementById("templateEditorInput");
    if (!editorContainer || !hiddenInput) return;

    const initEditor = (attempt = 0) => {
      if (typeof Quill === "undefined") {
        if (attempt < 20) return setTimeout(() => initEditor(attempt + 1), 100);
        console.warn("Quill failed to load; template editor unavailable.");
        return;
      }
      const quill = new Quill(editorContainer, {
        theme: "snow",
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["link", "image"],
            ["clean"],
          ],
        },
      });
      quill.root.innerHTML = hiddenInput.value || "";
      quill.on("text-change", () => {
        hiddenInput.value = quill.root.innerHTML;
      });
    };
    initEditor();
  });
</script>
