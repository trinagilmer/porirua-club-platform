2. Database Tables
communications
Stores all inbound and outbound emails.
Column	Type	Description
id	uuid (PK)	Unique message ID
direction	text	inbound or outbound
subject	text	Email subject
sender_email	text	From address
recipient_emails	text[]	To/CC/BCC addresses
body_html	text	Full HTML content
body_preview	text	Snippet of the message
received_at	timestamptz	Date received/sent
function_id	uuid	Links to functions.id
contact_id	uuid	Links to contacts.id
created_at	timestamptz	Default NOW()
Relationships
â€¢	communications.function_id â†’ functions.id
â€¢	communications.contact_id â†’ contacts.id
â€¢	Updates functions.last_contacted automatically.
________________________________________
3. Email Sending Flow
Route: POST /inbox/send
Purpose: Send messages from the shared mailbox using Microsoft Graph.
POST /inbox/send
Body:
{
  "to": "customer@example.com",
  "subject": "Function Confirmation",
  "htmlBody": "<p>Your booking is confirmed...</p>",
  "functionId": "uuid-1234",
  "contactId": "uuid-5678"
}
â€¢	Sends email via sendMail Graph endpoint.
â€¢	Saves to Outlook â€œSent Items.â€
â€¢	Inserts a record in communications.
â€¢	Updates last_contacted.
________________________________________
4. Email Receiving Flow
Route: GET /inbox
Purpose: Fetch recent messages from the shared mailbox.
â€¢	Uses Graph API to fetch from /users/{shared_mailbox}/mailFolders('Inbox')/messages.
â€¢	Filters messages by:
o	Keywords (e.g., Function, Booking, Proposal)
o	Address (to/from @poriruaclub.co.nz)
â€¢	Displays results in a clean, scrollable table view.
â€¢	Future enhancement: click to view full email with attachments.
________________________________________
5. Linking Logic
Emails are auto-linked where possible:
Source	Match Criteria	Links To
Inbound email	from matches a contactâ€™s email	contact_id
Inbound email	subject contains â€œFunction #123â€ or â€œBooking IDâ€	function_id
Outbound email	to matches contact email	contact_id
Any email	forwarded manually from Outlook with ID tag	Creates or links to existing record
________________________________________
6. Future Enhancements
Feature	Description	Priority
ğŸ“ Attachments	Save/download attachments per message	â˜…â˜…â˜…
ğŸ§  Smart Linking	Auto-detect function by subject, date, or sender	â˜…â˜…â˜…â˜…
ğŸ’¬ Inline Replies	Send and view replies directly inside Inbox	â˜…â˜…â˜…
ğŸ•“ Contact History	Merge with notes, calls, and meetings timeline	â˜…â˜…â˜…â˜…â˜…
ğŸ“± Notifications	Notify owner when contact replies	â˜…â˜…â˜…
________________________________________
7. Frontend Integration
The following pages will surface communications:
Page	Integration
Function Detail	â€œCommunicationâ€ tab shows inbound/outbound messages
Contact View	â€œEmail Historyâ€ section lists all correspondence
Inbox Dashboard	Central inbox, filter by contact/function
Restaurant & Events Dashboards	Display last communication date
________________________________________
8. Security & Compliance
â€¢	Uses Microsoft Graph OAuth tokens (no passwords stored)
â€¢	Only allowed to act as events@poriruaclub.co.nz
â€¢	Fully logged through Outlookâ€™s compliance trail
â€¢	Stored email bodies sanitized before rendering
________________________________________
9. Example Use Case
1.	Customer fills function enquiry form â†’ Email sent to events@poriruaclub.co.nz
2.	Platform fetches email, detects contact by sender address
3.	Creates new lead function and logs communication
4.	Staff replies directly from platform â†’ sent via shared mailbox
5.	Both sidesâ€™ messages appear under Function â†’ Communications tab
________________________________________
âœ… Summary
Once active, this system provides:
â€¢	Centralized visibility of all communication
â€¢	Seamless Outlook integration via Microsoft Graph
â€¢	Full audit trail in your own database
â€¢	Intelligent linking between functions, bookings, and contacts
